<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Discipline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

                .auth-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
            text-align: center;
        }
        
        .auth-icon {
            font-size: 64px;
            margin-bottom: 24px;
            background: #f8f9fa;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .auth-btn {
            width: 100%;
            padding: 16px;
            background: #1a1a1a;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: transform 0.1s;
            margin-top: 32px;
        }
        
        .auth-btn:active {
            transform: scale(0.98);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #333;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .app-container {
            background: white;
            width: 100%;
            max-width: 480px;
            height: 90vh;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .header {
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 14px;
            color: #666;
        }

        .progress-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-card span {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .progress-card .percentage {
            font-size: 16px;
            font-weight: 700;
            color: #ef4444;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1a1a1a;
        }

        .habit-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .habit-item:hover {
            background: #e9ecef;
        }

        .habit-item.completed {
            opacity: 0.6;
        }

        .habit-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .habit-info {
            flex: 1;
        }

        .habit-name {
            font-size: 15px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 2px;
        }

        .habit-details {
            font-size: 13px;
            color: #666;
        }

        .add-habit-btn {
            width: 100%;
            padding: 16px;
            border: 2px dashed #ddd;
            border-radius: 12px;
            background: white;
            color: #666;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }

        .add-habit-btn:hover {
            border-color: #999;
            color: #333;
        }

        .info-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 24px;
        }

        .info-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .info-card-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .info-card-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 2px;
        }

        .info-card-value {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .bottom-nav {
            display: flex;
            background: white;
            border-top: 1px solid #e9ecef;
            padding: 8px 0;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            gap: 4px;
            cursor: pointer;
            border: none;
            background: none;
            color: #999;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: #ef4444;
        }

        .nav-item:hover {
            color: #333;
        }

        .nav-icon {
            font-size: 24px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        .date-picker {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .category-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .pill {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: white;
            border: none;
            cursor: pointer;
        }

        .time-slot {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .time-label {
            font-size: 14px;
            font-weight: 600;
            width: 80px;
            color: #333;
        }

        .activity-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .weekly-chart {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .chart-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .day-label {
            font-size: 13px;
            font-weight: 500;
            width: 40px;
            color: #666;
        }

        .chart-bar {
            flex: 1;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(90deg, #ef4444, #a855f7);
            position: relative;
        }

        .radar-chart {
            width: 100%;
            height: 300px;
            margin: 20px 0;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-header {
            font-size: 12px;
            font-weight: 600;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .setting-item:hover {
            background: #e9ecef;
        }

        .setting-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .setting-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .setting-value {
            font-size: 14px;
            color: #666;
        }

        .sign-out-btn {
            background: #fee;
            color: #ef4444;
        }

        .app-version {
            text-align: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e9ecef;
        }

        .version-text {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
        }

        .hidden {
            display: none;
        }

        canvas {
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="content" id="content">
            <!-- Views will be dynamically loaded here -->
        </div>
        
        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchView('tracker')">
                <div class="nav-icon">üè†</div>
                <div class="nav-label">Tracker</div>
            </button>
            <button class="nav-item" onclick="switchView('log')">
                <div class="nav-icon">üïê</div>
                <div class="nav-label">Log</div>
            </button>
            <button class="nav-item" onclick="switchView('analytics')">
                <div class="nav-icon">üìä</div>
                <div class="nav-label">Analytics</div>
            </button>
            <button class="nav-item" onclick="switchView('character')">
                <div class="nav-icon">‚öîÔ∏è</div>
                <div class="nav-label">Character</div>
            </button>
            <button class="nav-item" onclick="switchView('settings')">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div class="nav-label">Settings</div>
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';;

        // Firebase configuration with placeholders
        const firebaseConfig = {
            apiKey: "FIREBASE_API_KEY_PLACEHOLDER",
            authDomain: "FIREBASE_AUTH_DOMAIN_PLACEHOLDER",
            projectId: "FIREBASE_PROJECT_ID_PLACEHOLDER",
            storageBucket: "FIREBASE_STORAGE_BUCKET_PLACEHOLDER",
            messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID_PLACEHOLDER",
            appId: "FIREBASE_APP_ID_PLACEHOLDER"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUser = null;

        // News API Key
        const NEWS_API_KEY = "NEWS_API_ORG_KEY_PLACEHOLDER";

        // Global state
        let currentView = 'tracker';
        let habits = [];
        let completions = {};
        let hourlyLog = {};
        let userStats = {
            totalXP: 0,
            level: 1,
            stats: {
                vitality: 15,
                intellect: 12,
                creativity: 10,
                social: 8,
                spirit: 9,
                wealth: 7
            }
        };

        // Default habits
        const defaultHabits = [
            { id: '1', name: 'Morning Exercise', category: 'Health', xp: 15, icon: 'üèÉ', color: '#fecaca' },
            { id: '2', name: 'Read for 30 min', category: 'Learning', xp: 12, icon: 'üìö', color: '#bfdbfe' },
            { id: '3', name: 'Meditate', category: 'Mindfulness', xp: 10, icon: 'üßò', color: '#ddd6fe' },
            { id: '4', name: 'Budget Review', category: 'Finance', xp: 10, icon: 'üí∞', color: '#fef08a' },
            { id: '5', name: 'Call a Friend', category: 'Social', xp: 8, icon: 'üìû', color: '#bbf7d0' },
            { id: '6', name: 'Creative Writing', category: 'Hobby', xp: 12, icon: '‚úçÔ∏è', color: '#fed7aa' }
        ];

        // Initialize app
        function initApp() {
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // 1. Immediate Render (Fastest LCP)
                switchView('tracker'); 
                
                // 2. Fetch User Data (Async)
                await loadData();
                // Re-render tracker to show loaded habits
                if(currentView === 'tracker') document.getElementById('content').innerHTML = getTrackerView();
    
                // 3. Fetch External APIs (Background - Non-blocking)
                loadExternalData(); 
            } else {
                currentUser = null;
                switchView('signin');
            }
        });
    }

        async function loadData() {
            try {
                const habitsDoc = await getDoc(doc(db, 'users', 'default', 'data', 'habits'));
                if (habitsDoc.exists()) {
                    habits = habitsDoc.data().list || defaultHabits;
                } else {
                    habits = defaultHabits;
                    await saveHabits();
                }

                const completionsDoc = await getDoc(doc(db, 'users', 'default', 'data', 'completions'));
                if (completionsDoc.exists()) {
                    completions = completionsDoc.data();
                }

                const statsDoc = await getDoc(doc(db, 'users', 'default', 'data', 'stats'));
                if (statsDoc.exists()) {
                    userStats = statsDoc.data();
                }
            } catch (error) {
                console.log('Using local data');
                habits = defaultHabits;
            }
        }

        async function saveHabits() {
            try {
                await setDoc(doc(db, 'users', 'default', 'data', 'habits'), { list: habits });
            } catch (error) {
                console.log('Save failed, using local storage');
            }
        }

        async function saveCompletions() {
            try {
                await setDoc(doc(db, 'users', 'default', 'data', 'completions'), completions);
            } catch (error) {
                console.log('Save failed');
            }
        }

        async function saveStats() {
            try {
                await setDoc(doc(db, 'users', 'default', 'data', 'stats'), userStats);
            } catch (error) {
                console.log('Save failed');
            }
        }

        window.switchView = function(view) {
    currentView = view;
    
    // Toggle Bottom Nav visibility
    const nav = document.querySelector('.bottom-nav');
    if (view === 'signin') {
        nav.style.display = 'none';
    } else {
        nav.style.display = 'flex';
        // Handle active state
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        // Find the button that calls this view and activate it
        const activeBtn = document.querySelector(`button[onclick="switchView('${view}')"]`);
        if(activeBtn) activeBtn.classList.add('active');
    }

    const content = document.getElementById('content');
    
    switch(view) {
        case 'signin':
            content.innerHTML = getSignInView();
            break;
        case 'tracker':
            content.innerHTML = getTrackerView();
            break;
        // ... (Keep existing cases for log, analytics, character, settings) ...
    }
    
    // REMOVED: loadExternalData(); -> This is now handled in initApp non-blockingly
}

        function getTrackerView() {
            const today = new Date().toISOString().split('T')[0];
            const todayCompletions = completions[today] || [];
            const completed = todayCompletions.length;
            const total = habits.length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

            return `
                <div class="header">
                    <h1>Daily Discipline</h1>
                    <p>Track your habits, level up your life</p>
                </div>

                <div class="progress-card">
                    <span>Weekly Progress</span>
                    <span class="percentage">${percentage}%</span>
                </div>

                <h2 class="section-title">Today's Habits</h2>
                
                ${habits.map(habit => {
                    const isCompleted = todayCompletions.includes(habit.id);
                    return `
                        <div class="habit-item ${isCompleted ? 'completed' : ''}" onclick="toggleHabit('${habit.id}')">
                            <div class="habit-icon" style="background: ${habit.color}">
                                ${habit.icon}
                            </div>
                            <div class="habit-info">
                                <div class="habit-name">${habit.name}</div>
                                <div class="habit-details">${habit.category} ‚Ä¢ +${habit.xp} XP</div>
                            </div>
                            <div style="font-size: 20px">${isCompleted ? '‚úì' : '‚óã'}</div>
                        </div>
                    `;
                }).join('')}

                <button class="add-habit-btn" onclick="addNewHabit()">
                    + Add New Habit
                </button>

                <div class="info-cards">
                    <div class="info-card">
                        <div class="info-card-icon">üå§Ô∏è</div>
                        <div class="info-card-label">Weather</div>
                        <div class="info-card-value" id="weather-value">--¬∞</div>
                    </div>
                    <div class="info-card">
                        <div class="info-card-icon">üôè</div>
                        <div class="info-card-label">Prayer</div>
                        <div class="info-card-value" id="prayer-value">--:--</div>
                    </div>
                    <div class="info-card">
                        <div class="info-card-icon">üì∞</div>
                        <div class="info-card-label">News</div>
                        <div class="info-card-value" id="news-value">--</div>
                    </div>
                </div>
            `;
        }

        function getLogView() {
            const today = new Date().toISOString().split('T')[0];
            const hours = Array.from({length: 24}, (_, i) => i);

            return `
                <div class="header">
                    <h1>Hourly Log</h1>
                    <p>Track your day hour by hour</p>
                </div>

                <input type="date" class="date-picker" value="${today}" onchange="loadLogForDate(this.value)">

                <div class="category-pills">
                    <button class="pill" style="background: #3b82f6">Work</button>
                    <button class="pill" style="background: #8b5cf6">Study</button>
                    <button class="pill" style="background: #ef4444">Exercise</button>
                    <button class="pill" style="background: #f59e0b">Meal</button>
                    <button class="pill" style="background: #10b981">Social</button>
                    <button class="pill" style="background: #6b7280">Rest</button>
                    <button class="pill" style="background: #ec4899">Hobby</button>
                    <button class="pill" style="background: #a855f7">Prayer</button>
                </div>

                ${hours.map(hour => {
                    const period = hour >= 12 ? 'PM' : 'AM';
                    const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                    return `
                        <div class="time-slot">
                            <div class="time-label">${displayHour}:00 ${period}</div>
                            <input type="text" class="activity-input" placeholder="Add activity..." 
                                   id="hour-${hour}" onchange="saveHourActivity(${hour}, this.value)">
                        </div>
                    `;
                }).join('')}
            `;
        }

        function getAnalyticsView() {
            const totalCompletions = Object.values(completions).reduce((sum, day) => sum + day.length, 0);
            const weekDates = getLast7Days();
            const weekStreak = calculateStreak();
            const topHabit = getTopHabit();
            const completionRate = calculateCompletionRate();

            return `
                <div class="header">
                    <h1>Analytics</h1>
                    <p>Track your progress over time</p>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: #fee2e2">üéØ</div>
                    <div class="stat-info">
                        <div class="stat-label">Total Completions</div>
                        <div class="stat-value">${totalCompletions}</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: #dbeafe">üìà</div>
                    <div class="stat-info">
                        <div class="stat-label">Weekly Streak</div>
                        <div class="stat-value">${weekStreak}</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: #e9d5ff">üèÜ</div>
                    <div class="stat-info">
                        <div class="stat-label">Top Habit</div>
                        <div class="stat-value">${topHabit || 'None'}</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: #d1fae5">üìÖ</div>
                    <div class="stat-info">
                        <div class="stat-label">Completion Rate</div>
                        <div class="stat-value">${completionRate}%</div>
                    </div>
                </div>

                <div class="weekly-chart">
                    <div class="chart-title">Weekly Overview</div>
                    <canvas id="weeklyChart"></canvas>
                </div>
            `;
        }

        function getCharacterView() {
            return `
                <div class="header">
                    <h1>Character</h1>
                    <p>Your RPG Stats & Progress</p>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #ec4899, #a855f7);">
                        üèÜ
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Level ${userStats.level} ‚Ä¢ Novice</div>
                        <div class="stat-value">Adventurer</div>
                        <div style="margin-top: 8px">
                            <div style="font-size: 13px; color: #666;">Experience</div>
                            <div style="font-size: 16px; font-weight: 600; color: #a855f7;">
                                ${userStats.totalXP}/100 XP
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin: 24px 0">
                    <h3 class="section-title">Stat Distribution</h3>
                    <canvas id="radarChart"></canvas>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px;">
                    <div class="stat-card" style="flex-direction: column; align-items: flex-start;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <div style="width: 32px; height: 32px; background: #fee2e2; border-radius: 8px; display: flex; align-items: center; justify-content: center;">‚ù§Ô∏è</div>
                            <div style="font-size: 12px; color: #666;">Vitality</div>
                        </div>
                        <div style="font-size: 24px; font-weight: 700;">${userStats.stats.vitality}</div>
                    </div>
                    <div class="stat-card" style="flex-direction: column; align-items: flex-start;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <div style="width: 32px; height: 32px; background: #dbeafe; border-radius: 8px; display: flex; align-items: center; justify-content: center;">üß†</div>
                            <div style="font-size: 12px; color: #666;">Intellect</div>
                        </div>
                        <div style="font-size: 24px; font-weight: 700;">${userStats.stats.intellect}</div>
                    </div>
                    <div class="stat-card" style="flex-direction: column; align-items: flex-start;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <div style="width: 32px; height: 32px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center;">üé®</div>
                            <div style="font-size: 12px; color: #666;">Creativity</div>
                        </div>
                        <div style="font-size: 24px; font-weight: 700;">${userStats.stats.creativity}</div>
                    </div>
                    <div class="stat-card" style="flex-direction: column; align-items: flex-start;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <div style="width: 32px; height: 32px; background: #d1fae5; border-radius: 8px; display: flex; align-items: center; justify-content: center;">üë•</div>
                            <div style="font-size: 12px; color: #666;">Social</div>
                        </div>
                        <div style="font-size: 24px; font-weight: 700;">${userStats.stats.social}</div>
                    </div>
                </div>
            `;
        }

        function getSettingsView() {
            return `
                <div class="header">
                    <h1>Settings</h1>
                    <p>Manage your preferences</p>
                </div>

                <div class="settings-section">
                    <div class="settings-header">PREFERENCES</div>
                    
                    <div class="setting-item">
                        <div class="setting-left">
                            <div class="setting-icon">üîî</div>
                            <div>Notifications</div>
                        </div>
                        <div class="setting-value">Enabled</div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-left">
                            <div class="setting-icon">üåô</div>
                            <div>Dark Mode</div>
                        </div>
                        <div class="setting-value">Off</div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-left">
                            <div class="setting-icon">üåç</div>
                            <div>Language</div>
                        </div>
                        <div class="setting-value">English</div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-header">ACCOUNT</div>
                    
                    <div class="setting-item">
                        <div class="setting-left">
                            <div class="setting-icon">üîí</div>
                            <div>Privacy</div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-left">
                            <div class="setting-icon">‚ùì</div>
                            <div>Help & Support</div>
                        </div>
                    </div>

                    <div class="setting-item sign-out-btn" onclick="handleSignOut()">
                        <div class="setting-left">
                            <div class="setting-icon" style="background: #fee">üö™</div>
                            <div>Sign Out</div>
                        </div>
                    </div>

                <div class="app-version">
                    <div class="version-text">Daily Discipline v1.0.0</div>
                    <div class="version-text" style="color: #ccc;">Made with discipline and dedication</div>
                </div>
            `;
        }

            function getSignInView() {
        // Hide bottom nav on login screen
        document.querySelector('.bottom-nav').style.display = 'none';
        
        return `
            <div class="auth-view">
                <div class="auth-icon">ü¶Å</div>
                <div class="header" style="margin-bottom: 8px">
                    <h1 style="font-size: 32px;">Daily Discipline</h1>
                    <p>Master your habits, master your life.</p>
                </div>
                
                <button class="auth-btn" onclick="handleSignIn()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.26.81-.58z" fill="#FBBC05"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                    </svg>
                    Sign in with Google
                </button>
                
                <p style="margin-top: 24px; font-size: 12px; color: #999;">
                    By continuing, you agree to commit to excellence.
                </p>
            </div>
        `;
    }
    
    window.handleSignIn = async function() {
        const provider = new GoogleAuthProvider();
        try {
            await signInWithPopup(auth, provider);
            // initApp listener will handle the redirect
        } catch (error) {
            alert("Sign in failed: " + error.message);
        }
    }
    
    window.handleSignOut = function() {
        signOut(auth).then(() => {
            // initApp listener will handle the redirect
        });
    }

        window.toggleHabit = async function(habitId) {
            const today = new Date().toISOString().split('T')[0];
            if (!completions[today]) {
                completions[today] = [];
            }

            const index = completions[today].indexOf(habitId);
            if (index > -1) {
                completions[today].splice(index, 1);
                const habit = habits.find(h => h.id === habitId);
                if (habit) {
                    userStats.totalXP = Math.max(0, userStats.totalXP - habit.xp);
                }
            } else {
                completions[today].push(habitId);
                const habit = habits.find(h => h.id === habitId);
                if (habit) {
                    userStats.totalXP += habit.xp;
                    updateStats(habit.category);
                    
                    // Level up check
                    while (userStats.totalXP >= 100) {
                        userStats.level++;
                        userStats.totalXP -= 100;
                    }
                }
            }

            await saveCompletions();
            await saveStats();
            switchView('tracker');
        }

        function updateStats(category) {
            const statMap = {
                'Health': 'vitality',
                'Learning': 'intellect',
                'Hobby': 'creativity',
                'Social': 'social',
                'Mindfulness': 'spirit',
                'Finance': 'wealth'
            };

            const stat = statMap[category];
            if (stat && userStats.stats[stat]) {
                userStats.stats[stat]++;
            }
        }

        window.addNewHabit = function() {
            const name = prompt('Habit name:');
            if (!name) return;
            
            const category = prompt('Category (Health/Learning/Mindfulness/Finance/Social/Hobby):');
            const xp = parseInt(prompt('XP value (5-20):')) || 10;
            const icon = prompt('Emoji icon:') || '‚≠ê';
            
            const colors = ['#fecaca', '#bfdbfe', '#ddd6fe', '#fef08a', '#bbf7d0', '#fed7aa'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            habits.push({
                id: Date.now().toString(),
                name,
                category: category || 'General',
                xp,
                icon,
                color
            });
            
            saveHabits();
            switchView('tracker');
        }

        window.saveHourActivity = function(hour, activity) {
            const today = new Date().toISOString().split('T')[0];
            if (!hourlyLog[today]) {
                hourlyLog[today] = {};
            }
            hourlyLog[today][hour] = activity;
        }

        window.loadLogForDate = function(date) {
            // Load activities for selected date
            const log = hourlyLog[date] || {};
            for (let hour = 0; hour < 24; hour++) {
                const input = document.getElementById(`hour-${hour}`);
                if (input) {
                    input.value = log[hour] || '';
                }
            }
        }

        function getLast7Days() {
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date.toISOString().split('T')[0]);
            }
            return days;
        }

        function calculateStreak() {
            const dates = Object.keys(completions).sort().reverse();
            let streak = 0;
            const today = new Date().toISOString().split('T')[0];
            
            for (let i = 0; i < dates.length; i++) {
                const date = new Date(dates[i]);
                const expectedDate = new Date();
                expectedDate.setDate(expectedDate.getDate() - i);
                
                if (date.toISOString().split('T')[0] === expectedDate.toISOString().split('T')[0]) {
                    if (completions[dates[i]].length > 0) {
                        streak++;
                    } else {
                        break;
                    }
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function getTopHabit() {
            const habitCounts = {};
            Object.values(completions).forEach(day => {
                day.forEach(habitId => {
                    habitCounts[habitId] = (habitCounts[habitId] || 0) + 1;
                });
            });
            
            let topHabitId = null;
            let maxCount = 0;
            
            for (const [habitId, count] of Object.entries(habitCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    topHabitId = habitId;
                }
            }
            
            const habit = habits.find(h => h.id === topHabitId);
            return habit ? habit.name : 'None';
        }

        function calculateCompletionRate() {
            const days = Object.keys(completions);
            if (days.length === 0) return 0;
            
            let totalPossible = days.length * habits.length;
            let totalCompleted = Object.values(completions).reduce((sum, day) => sum + day.length, 0);
            
            return totalPossible > 0 ? Math.round((totalCompleted / totalPossible) * 100) : 0;
        }

        function renderCharts() {
            const canvas = document.getElementById('weeklyChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const weekDates = getLast7Days();
            const dayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            const data = weekDates.map(date => {
                const dayCompletions = completions[date] || [];
                return dayCompletions.length;
            });
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: 'Completions',
                        data: data,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function renderRadarChart() {
            const canvas = document.getElementById('radarChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Vitality', 'Intellect', 'Creativity', 'Social', 'Spirit', 'Wealth'],
                    datasets: [{
                        label: 'Stats',
                        data: [
                            userStats.stats.vitality,
                            userStats.stats.intellect,
                            userStats.stats.creativity,
                            userStats.stats.social,
                            userStats.stats.spirit,
                            userStats.stats.wealth
                        ],
                        backgroundColor: 'rgba(168, 85, 247, 0.2)',
                        borderColor: 'rgba(168, 85, 247, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(168, 85, 247, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(168, 85, 247, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 30,
                            ticks: {
                                stepSize: 5
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // External data loading
        async function loadExternalData() {
            await loadWeather();
            await loadPrayerTimes();
            await loadNews();
        }

        async function loadWeather() {
            try {
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=23.5880&longitude=58.3829&current_weather=true');
                const data = await response.json();
                const temp = Math.round(data.current_weather.temperature);
                const weatherEl = document.getElementById('weather-value');
                if (weatherEl) {
                    weatherEl.textContent = `${temp}¬∞C`;
                }
            } catch (error) {
                console.log('Weather load failed');
                const weatherEl = document.getElementById('weather-value');
                if (weatherEl) {
                    weatherEl.textContent = '72¬∞F';
                }
            }
        }

        async function loadPrayerTimes() {
            try {
                const date = new Date();
                const dateStr = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`;
                const response = await fetch(`https://api.aladhan.com/v1/timingsByCity/${dateStr}?city=Muscat&country=Oman&method=4`);
                const data = await response.json();
                
                if (data.data && data.data.timings) {
                    const timings = data.data.timings;
                    const now = new Date();
                    const currentTime = now.getHours() * 60 + now.getMinutes();
                    
                    const prayers = [
                        { name: 'Fajr', time: timings.Fajr },
                        { name: 'Dhuhr', time: timings.Dhuhr },
                        { name: 'Asr', time: timings.Asr },
                        { name: 'Maghrib', time: timings.Maghrib },
                        { name: 'Isha', time: timings.Isha }
                    ];
                    
                    let nextPrayer = null;
                    for (const prayer of prayers) {
                        const [hours, minutes] = prayer.time.split(':').map(Number);
                        const prayerTime = hours * 60 + minutes;
                        if (prayerTime > currentTime) {
                            nextPrayer = prayer;
                            break;
                        }
                    }
                    
                    if (!nextPrayer) {
                        nextPrayer = prayers[0]; // Next day Fajr
                    }
                    
                    const prayerEl = document.getElementById('prayer-value');
                    if (prayerEl) {
                        prayerEl.textContent = nextPrayer.time.substring(0, 5);
                    }
                }
            } catch (error) {
                console.log('Prayer times load failed');
                const prayerEl = document.getElementById('prayer-value');
                if (prayerEl) {
                    prayerEl.textContent = '12:30';
                }
            }
        }

        async function loadNews() {
            try {
                const response = await fetch(`https://newsapi.org/v2/top-headlines?country=us&apiKey=${NEWS_API_KEY}`);
                const data = await response.json();
                
                const newsEl = document.getElementById('news-value');
                if (newsEl && data.articles) {
                    const newCount = data.articles.filter(article => {
                        const articleDate = new Date(article.publishedAt);
                        const daysDiff = (new Date() - articleDate) / (1000 * 60 * 60 * 24);
                        return daysDiff < 1;
                    }).length;
                    
                    newsEl.textContent = `${newCount} new`;
                }
            } catch (error) {
                console.log('News load failed');
                const newsEl = document.getElementById('news-value');
                if (newsEl) {
                    newsEl.textContent = '3 new';
                }
            }
        }

        // Initialize the app
        initApp();
    </script>
</body>
</html>

