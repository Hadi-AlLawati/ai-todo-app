<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Habit Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
        }
        .custom-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>');
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        .todo-item span {
            word-break: break-word;
        }
        .day-btn.active, .view-btn.active {
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
            color: #1e40af; /* blue-800 */
            font-weight: 600;
        }
        .modal-backdrop {
             background-color: rgba(0,0,0,0.5);
        }
        .points-animation {
            position: absolute;
            animation: points-pop 0.8s ease-out forwards;
            font-weight: bold;
            color: #22c55e; /* green-500 */
        }
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes points-pop {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-30px) scale(1.2); opacity: 0; }
        }
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .card {
             transform: translateY(20px);
             opacity: 0;
             animation: fadeInUp 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex justify-center items-center z-50 hidden">
        <div class="loading-spinner"></div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="flex items-center justify-center min-h-screen bg-gray-50">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <!-- Login Form -->
            <form id="login-form" class="space-y-6">
                <h2 class="text-3xl font-bold text-center text-gray-900">Welcome Back!</h2>
                <div>
                    <label for="login-email" class="text-sm font-medium text-gray-700">Email address</label>
                    <input id="login-email" name="email" type="email" autocomplete="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="login-password" class="text-sm font-medium text-gray-700">Password</label>
                    <input id="login-password" name="password" type="password" autocomplete="current-password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <p id="login-error" class="text-sm text-red-600"></p>
                <div>
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Sign In
                    </button>
                </div>
                <p class="text-sm text-center text-gray-600">
                    No account? <a href="#" id="show-signup-link" class="font-medium text-blue-600 hover:text-blue-500">Sign up</a>
                </p>
            </form>

            <!-- Signup Form -->
            <form id="signup-form" class="hidden space-y-6">
                <h2 class="text-3xl font-bold text-center text-gray-900">Create an Account</h2>
                <div>
                    <label for="signup-email" class="text-sm font-medium text-gray-700">Email address</label>
                    <input id="signup-email" name="email" type="email" autocomplete="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="signup-password" class="text-sm font-medium text-gray-700">Password</label>
                    <input id="signup-password" name="password" type="password" autocomplete="new-password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <p id="signup-error" class="text-sm text-red-600"></p>
                <div>
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Sign Up
                    </button>
                </div>
                <p class="text-sm text-center text-gray-600">
                    Already have an account? <a href="#" id="show-login-link" class="font-medium text-blue-600 hover:text-blue-500">Log in</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">Daily Discipline Tracker</h1>
                <p class="text-md text-gray-600 mt-2" id="current-week-display">Your journey to consistency starts now.</p>
                
                <!-- Main Navigation -->
                <div class="flex justify-center my-4 space-x-2 border-b-2 border-gray-200 pb-2">
                     <button id="view-tracker-btn" class="view-btn flex items-center space-x-2 px-4 py-2 rounded-lg text-gray-600 border-b-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                        <span>Tracker</span>
                     </button>
                     <button id="view-analytics-btn" class="view-btn flex items-center space-x-2 px-4 py-2 rounded-lg text-gray-600 border-b-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" /></svg>
                        <span>Analytics</span>
                    </button>
                     <button id="view-settings-btn" class="view-btn flex items-center space-x-2 px-4 py-2 rounded-lg text-gray-600 border-b-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0l-.1.41a1.5 1.5 0 01-2.1 1.45c-1.45-.4-2.8.9-2.4 2.34l.24 1.1a1.5 1.5 0 01-1.45 2.1l-1.1.24c-1.45.4-1.98 2.32-.54 3.25l.8 1.32a1.5 1.5 0 010 2.4l-.8 1.32c-1.45.93-.92 2.85.54 3.25l1.1.24a1.5 1.5 0 011.45 2.1l-.24 1.1c-.4 1.45.95 2.75 2.4 2.34l1.1-.24a1.5 1.5 0 012.1 1.45l.1.41c.38 1.56 2.6 1.56 2.98 0l.1-.41a1.5 1.5 0 012.1-1.45l1.1.24c1.45.4 2.8-.9 2.4-2.34l-.24-1.1a1.5 1.5 0 011.45-2.1l1.1-.24c1.45-.4 1.98-2.32.54-3.25l-.8-1.32a1.5 1.5 0 010-2.4l.8-1.32c1.45-.93.92-2.85-.54-3.25l-1.1-.24a1.5 1.5 0 01-1.45-2.1l.24-1.1c.4-1.45-.95-2.75-2.4-2.34l-1.1.24a1.5 1.5 0 01-2.1-1.45l-.1-.41zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                        <span>Settings</span>
                    </button>
                </div>
                 <div class="flex items-center justify-center space-x-6 mt-4">
                    <div id="week-nav-controls" class="flex items-center space-x-4">
                        <button id="prev-week-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg shadow-sm hover:bg-gray-300 transition-colors">&larr; Prev</button>
                        <button id="today-btn" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 transition-colors">Today</button>
                        <button id="next-week-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg shadow-sm hover:bg-gray-300 transition-colors">Next &rarr;</button>
                    </div>
                    <div class="flex items-center space-x-4">
                         <div class="bg-yellow-100 text-yellow-800 font-bold py-2 px-4 rounded-lg shadow-sm">
                            Score: <span id="discipline-score">0</span>
                        </div>
                        <button id="signout-btn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-sm hover:bg-red-600 transition-colors">Sign Out</button>
                    </div>
                </div>
                 <p id="user-email" class="text-sm text-gray-500 mt-4"></p>
            </header>

            <!-- Tracker View -->
            <div id="tracker-view">
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 card">
                    <h2 class="text-xl font-bold mb-2">Weekly Progress</h2>
                    <div class="w-full h-4 bg-gray-200 rounded-full">
                        <div id="total-progress-bar" class="h-full text-center text-xs text-white bg-green-500 rounded-full transition-all duration-500" style="width: 0%;"></div>
                    </div>
                    <p id="total-progress-text" class="text-center text-sm font-medium text-gray-600 mt-2">0% Complete</p>
                </div>

                <!-- Day Navigation Tabs -->
                <div id="day-nav-container" class="grid grid-cols-4 sm:grid-cols-7 text-center border-b-2 border-gray-200 mb-6">
                    <!-- Day buttons will be inserted here -->
                </div>

                <div id="app-content" class="space-y-6">
                    <!-- Day-specific content will be rendered here -->
                </div>
            </div>
            
            <!-- Analytics View -->
            <div id="analytics-view" class="hidden">
                 <div class="bg-white rounded-2xl shadow-lg p-6 card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Habit Streaks</h2>
                    <div id="streaks-content" class="space-y-3">Loading analytics...</div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="hidden">
                 <div class="bg-white rounded-2xl shadow-lg p-6 card">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                         <h2 class="text-2xl font-bold text-gray-800">Customize Habits</h2>
                         <div class="flex space-x-2">
                            <button id="add-habit-btn" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 transition-colors text-sm">Add New Habit</button>
                            <button id="export-data-btn" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-sm hover:bg-green-600 transition-colors text-sm">Export All Data</button>
                         </div>
                    </div>
                    <div id="settings-content" class="space-y-4">Loading settings...</div>
                </div>
            </div>


            <footer class="text-center mt-12 py-6 border-t-2 border-gray-200">
                <div class="w-full max-w-4xl mx-auto">
                    <p class="text-gray-500 text-lg">"The secret of getting ahead is getting started."</p>
                    <p class="text-gray-400 text-sm mt-2">- Mark Twain</p>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- Habit Modal -->
    <div id="habit-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Add Habit</h3>
            <form id="habit-form">
                <input type="hidden" id="habit-id">
                <div class="mb-4">
                    <label for="habit-name" class="block text-sm font-medium text-gray-700">Habit Name</label>
                    <input type="text" id="habit-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="habit-category" class="block text-sm font-medium text-gray-700">Category</label>
                    <select id="habit-category" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                 <div class="mb-4">
                    <label for="habit-type" class="block text-sm font-medium text-gray-700">Type</label>
                    <select id="habit-type" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500">
                        <option value="checkbox">Checkbox (Daily)</option>
                        <option value="weekly-checkbox">Checkbox (Weekly)</option>
                        <option value="select">Dropdown (Daily)</option>
                    </select>
                </div>
                <div id="select-options-container" class="mb-4 hidden">
                     <label for="habit-options" class="block text-sm font-medium text-gray-700">Dropdown Options (comma separated)</label>
                    <input type="text" id="habit-options" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-habit-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Habit</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "FIREBASE_API_KEY_PLACEHOLDER",
            authDomain: "FIREBASE_AUTH_DOMAIN_PLACEHOLDER",
            projectId: "FIREBASE_PROJECT_ID_PLACEHOLDER",
            storageBucket: "FIREBASE_STORAGE_BUCKET_PLACEHOLDER",
            messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID_PLACEHOLDER",
            appId: "FIREBASE_APP_ID_PLACEHOLDER"
        };
        const appId = 'habit-tracker-live';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let habitData = {};
        let userHabitConfig = {};
        let userConfig = {};
        let unsubscribe = null;
        let displayedDate = new Date();
        let activeDayIndex = 0;
        let currentView = 'tracker'; // tracker, analytics, settings

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const mainAppContainer = document.getElementById('app-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const userEmailDisplay = document.getElementById('user-email');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupLink = document.getElementById('show-signup-link');
        const showLoginLink = document.getElementById('show-login-link');
        const signoutBtn = document.getElementById('signout-btn');
        const dayNavContainer = document.getElementById('day-nav-container');
        const appContent = document.getElementById('app-content');
        const disciplineScoreDisplay = document.getElementById('discipline-score');

        // View Containers and Buttons
        const views = {
            tracker: document.getElementById('tracker-view'),
            analytics: document.getElementById('analytics-view'),
            settings: document.getElementById('settings-view')
        };
        const viewButtons = {
            tracker: document.getElementById('view-tracker-btn'),
            analytics: document.getElementById('view-analytics-btn'),
            settings: document.getElementById('view-settings-btn')
        };
        const weekNavControls = document.getElementById('week-nav-controls');
        
        // Modal elements
        const habitModal = document.getElementById('habit-modal');
        const habitForm = document.getElementById('habit-form');
        const modalTitle = document.getElementById('modal-title');
        const addHabitBtn = document.getElementById('add-habit-btn');
        const cancelHabitBtn = document.getElementById('cancel-habit-btn');

        // --- Default Habit Definitions ---
        const defaultHabits = {
            "Health": [
                { id: "h1", name: "Body", type: "checkbox" }, { id: "h2", name: "Face", type: "checkbox" }, { id: "h3", name: "Ears", type: "checkbox" }, { id: "h4", name: "Teeth", type: "checkbox" }, { id: "h5", name: "Smell", type: "checkbox" }, { id: "h6", name: "Calories (>3000)", type: "checkbox" }, { id: "h7", name: "Stretch", type: "checkbox" }, { id: "h8", name: "Sleep (7-8 hours)", type: "checkbox" }, { id: "h9", name: "Hydration", type: "checkbox" }, { id: "h10", name: "Physical Activity", type: "select", options: ["", "Muscle", "Padel", "Running", "Tennis"] },
            ],
            "Mind": [
                { id: "m1", name: "Investments Learning", type: "select", options: ["", "Crypto", "Stock", "News"] }, { id: "m2", name: "CFA Learning", type: "checkbox" }, { id: "m3", name: "Padel Learning", type: "checkbox" }, { id: "m4", name: "Tennis Learning", type: "checkbox" }, { id: "m5", name: "Discipline", type: "checkbox" }, { id: "m6", name: "Talk to one person", type: "checkbox" }, { id: "m7", name: "Family time (30min)", type: "checkbox" }, { id: "m8", name: "Daily Planning/Review", type: "checkbox" }, { id: "m9", name: "Tidying Up", type: "checkbox" },
            ],
            "Spirit": [
                { id: "s1", name: "Affirmations", type: "checkbox" }, { id: "s2", name: "Prayer", type: "checkbox" }, { id: "s3", name: "Quran", type: "checkbox" }, { id: "s4", name: "Dua", type: "checkbox" },
            ],
            "Budget": [ { id: "b1", name: "Spend < 6.67 OMR", type: "checkbox" }, ],
            "Weekly": [ { id: "w1", name: "Family Outing", type: "weekly-checkbox" }, { id: "w2", name: "Extended Family Gathering", type: "weekly-checkbox" }, { id: "w3", name: "Charity", type: "weekly-checkbox" } ]
        };
        const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const journalPrompts = [
            "What was one win from today, big or small?", "What is something you're grateful for right now?", "What is one thing you can do to make tomorrow even better?", "Describe a moment today that made you smile.", "What challenge did you face today and how did you handle it?", "What are you most looking forward to this week?", "Write about something you learned today.", "If you could describe today in three words, what would they be?", "What's one thing that's been on your mind lately?"
        ];

        // --- Auth State Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                authContainer.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');
                loadingOverlay.classList.remove('hidden');
                userId = user.uid;
                userEmailDisplay.textContent = `Signed in as: ${user.email}`;
                
                await loadUserConfig();

                setActiveDayForCurrentWeek();
                updateViewForDate();
                setupViewNavigation();

            } else {
                authContainer.classList.remove('hidden');
                mainAppContainer.classList.add('hidden');
                if (unsubscribe) unsubscribe();
                userId = null;
                userEmailDisplay.textContent = '';
                habitData = {};
                userHabitConfig = {};
                userConfig = {};
                loadingOverlay.classList.add('hidden');
            }
        });
        
        // --- User Configuration (Habits & Score) ---
        async function loadUserConfig() {
            const habitConfigRef = doc(db, `artifacts/${appId}/users/${userId}/config`, 'habits');
            const habitDocSnap = await getDoc(habitConfigRef);
            if (habitDocSnap.exists()) {
                userHabitConfig = habitDocSnap.data();
            } else {
                userHabitConfig = JSON.parse(JSON.stringify(defaultHabits)); // Deep copy
                await setDoc(habitConfigRef, userHabitConfig);
            }

            const userConfigRef = doc(db, `artifacts/${appId}/users/${userId}/config`, 'user');
            const userDocSnap = await getDoc(userConfigRef);
            if(userDocSnap.exists()) {
                userConfig = userDocSnap.data();
            } else {
                userConfig = { disciplineScore: 0 };
                await setDoc(userConfigRef, userConfig);
            }
            disciplineScoreDisplay.textContent = userConfig.disciplineScore || 0;
        }

        async function saveUserHabitConfig() {
            if (!userId) return;
            const configRef = doc(db, `artifacts/${appId}/users/${userId}/config`, 'habits');
            await setDoc(configRef, userHabitConfig);
        }
        
        let scoreUpdateTimeout;
        async function incrementScore(points) {
            userConfig.disciplineScore = (userConfig.disciplineScore || 0) + points;
            disciplineScoreDisplay.textContent = userConfig.disciplineScore;
            
            clearTimeout(scoreUpdateTimeout);
            scoreUpdateTimeout = setTimeout(() => {
                const userConfigRef = doc(db, `artifacts/${appId}/users/${userId}/config`, 'user');
                setDoc(userConfigRef, userConfig, { merge: true });
            }, 2000); // Debounce Firestore writes
        }

        function showPointsAnimation(element, points) {
            const pointsEl = document.createElement('span');
            pointsEl.textContent = `+${points}`;
            pointsEl.className = 'points-animation';
            element.parentElement.style.position = 'relative';
            element.parentElement.appendChild(pointsEl);
            setTimeout(() => {
                pointsEl.remove();
            }, 800);
        }


        // --- Auth Event Handlers ---
        showSignupLink.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value, password = loginForm['login-password'].value;
            const errorP = document.getElementById('login-error'); errorP.textContent = '';
            try { await signInWithEmailAndPassword(auth, email, password); } 
            catch (error) { console.error("Login Error:", error.message); errorP.textContent = "Invalid email or password."; }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = signupForm['signup-email'].value, password = signupForm['signup-password'].value;
            const errorP = document.getElementById('signup-error'); errorP.textContent = '';
            try { await createUserWithEmailAndPassword(auth, email, password); } 
            catch (error) {
                 console.error("Signup Error:", error.message);
                 errorP.textContent = error.code === 'auth/email-already-in-use' ? 'This email is already registered.' : 'Could not create account. Please try again.';
            }
        });

        signoutBtn.addEventListener('click', async () => { try { await signOut(auth); } catch (error) { console.error("Signout Error:", error); } });


        // --- Date & Week Logic ---
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - d.getUTCDay());
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return [d.getUTCFullYear(), weekNo];
        }
        
        function getDateOfWeek(w, y) {
            const simple = new Date(y, 0, 1 + (w - 1) * 7);
            const dow = simple.getDay();
            simple.setDate(simple.getDate() - dow);
            return simple;
        }

        function setActiveDayForCurrentWeek() {
             const today = new Date();
             const [currentYear, currentWeek] = getWeekNumber(today);
             const [displayYear, displayWeek] = getWeekNumber(displayedDate);
             if (currentYear === displayYear && currentWeek === displayWeek) {
                 activeDayIndex = today.getDay(); // Sunday is 0
             } else {
                 activeDayIndex = 0; // Default to Sunday for other weeks
             }
        }

        function updateViewForDate() {
            if (!userId) return;
            const [year, week] = getWeekNumber(displayedDate);
            const weekId = `${year}-W${String(week).padStart(2, '0')}`;
            document.getElementById('current-week-display').textContent = `Week ${week}, ${year}`;

            const nextWeekBtn = document.getElementById('next-week-btn');
            const today = new Date();
            const [currentYear, currentWeek] = getWeekNumber(today);
            nextWeekBtn.disabled = year > currentYear || (year === currentYear && week >= currentWeek);
            nextWeekBtn.classList.toggle('opacity-50', nextWeekBtn.disabled);
            nextWeekBtn.classList.toggle('cursor-not-allowed', nextWeekBtn.disabled);
            
            setupTracker(weekId);
        }

        function navigateWeeks(offset) { 
            displayedDate.setDate(displayedDate.getDate() + (offset * 7)); 
            setActiveDayForCurrentWeek();
            updateViewForDate(); 
        }
        
        // --- Firestore ---
        async function setupTracker(weekId) {
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/habits`, weekId);
            if (unsubscribe) unsubscribe(); 
            unsubscribe = onSnapshot(docRef, (docSnap) => {
                habitData = docSnap.exists() ? docSnap.data() : initializeEmptyHabitData();
                if (!docSnap.exists()) { setDoc(docRef, habitData); }
                renderApp();
                loadingOverlay.classList.add('hidden');
            }, (error) => {
                console.error("Error fetching document:", error);
                loadingOverlay.innerHTML = `<p class="text-red-500">Error loading data. Check console.</p>`;
            });
        }
        
        function initializeEmptyHabitData() {
            const data = {};
            for (const category in userHabitConfig) {
                userHabitConfig[category].forEach(habit => {
                    const key = habit.id;
                    if (habit.type === 'weekly-checkbox') {
                         data[key] = [false];
                    } else if (habit.type === 'checkbox') {
                        data[key] = Array(7).fill(false);
                    } else {
                         data[key] = Array(7).fill("");
                    }
                });
            }
            data.journal = Array(7).fill("");
            data.todos = { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] };
            return data;
        }

        async function updateFirestore() {
             if (!userId) return;
             const [year, week] = getWeekNumber(displayedDate);
             const weekId = `${year}-W${String(week).padStart(2, '0')}`;
             const docRef = doc(db, `artifacts/${appId}/users/${userId}/habits`, weekId);
             try { await setDoc(docRef, habitData, { merge: true }); } 
             catch (error) { console.error("Error updating Firestore: ", error); }
        }

        // --- View Navigation ---
        function setupViewNavigation() {
            Object.keys(viewButtons).forEach(view => {
                viewButtons[view].addEventListener('click', () => switchView(view));
            });
            switchView('tracker'); // Set initial view
        }

        function switchView(view) {
            currentView = view;
            Object.keys(views).forEach(v => {
                const is_active = v === view;
                views[v].classList.toggle('hidden', !is_active);
                viewButtons[v].classList.toggle('active', is_active);
            });
            weekNavControls.classList.toggle('hidden', view !== 'tracker');

            if (view === 'analytics') renderAnalytics();
            if (view === 'settings') renderSettings();
        }

        // --- Main Render Function ---
        function renderApp() {
            if(currentView !== 'tracker') return;
            renderDayNavigation();
            renderContentForDay();
            addAppEventListeners();
            updateProgress();
        }
        
        function renderDayNavigation() {
            dayNavContainer.innerHTML = '';
            days.forEach((day, index) => {
                const btn = document.createElement('button');
                btn.textContent = day;
                btn.className = `day-btn p-3 border-b-4 ${index === activeDayIndex ? 'active' : 'border-transparent text-gray-500 hover:border-gray-300'}`;
                btn.addEventListener('click', () => {
                    activeDayIndex = index;
                    renderApp();
                });
                dayNavContainer.appendChild(btn);
            });
        }

        function renderContentForDay() {
            const today = new Date();
            const isCurrentDay = activeDayIndex === today.getDay() &&
                                getWeekNumber(displayedDate).join('-') === getWeekNumber(today).join('-');

            let html = `
                <div class="card">${isCurrentDay ? renderDashboard() : ''}</div>
                <div class="card" style="animation-delay: 100ms;">${renderWeeklySection()}</div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card" style="animation-delay: 200ms;">${renderDayJournal(activeDayIndex)}</div>
                    <div class="card" style="animation-delay: 250ms;">${renderDayTodos(activeDayIndex)}</div>
                </div>
                <div class="card" style="animation-delay: 300ms;">${renderDayHabits(activeDayIndex)}</div>
            `;
            appContent.innerHTML = html;
            if (isCurrentDay) {
                fetchDashboardData();
            }
        }
        
        // --- Analytics Rendering ---
        async function renderAnalytics() {
            const streaksContent = document.getElementById('streaks-content');
            streaksContent.innerHTML = 'Calculating streaks...';

            const habitHistory = await fetchHabitHistory(12); // Fetch last 12 weeks
            if(Object.keys(habitHistory).length === 0) {
                 streaksContent.innerHTML = '<p>Not enough data to calculate streaks. Keep tracking your habits!</p>';
                 return;
            }

            const streaks = calculateAllStreaks(habitHistory);
            
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
            for(const category in userHabitConfig) {
                userHabitConfig[category].forEach(habit => {
                    const habitStreaks = streaks[habit.id] || { current: 0, longest: 0};
                    html += `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-bold text-gray-800">${habit.name}</p>
                            <p class="text-sm text-gray-600">Current Streak: <span class="font-semibold text-blue-600">${habitStreaks.current} days</span></p>
                            <p class="text-sm text-gray-600">Longest Streak: <span class="font-semibold text-green-600">${habitStreaks.longest} days</span></p>
                        </div>
                    `;
                });
            }
            html += '</div>';
            streaksContent.innerHTML = html;
        }

        async function fetchHabitHistory(weeksToFetch) {
            const history = {};
            const today = new Date();
            for (let i = 0; i < weeksToFetch; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - (i * 7));
                const [year, week] = getWeekNumber(date);
                const weekId = `${year}-W${String(week).padStart(2, '0')}`;
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/habits`, weekId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    history[weekId] = docSnap.data();
                }
            }
            return history;
        }
        
        function calculateAllStreaks(history) {
            const allHabits = Object.values(userHabitConfig).flat();
            const results = {};
            
            allHabits.filter(h => h.type !== 'weekly-checkbox').forEach(habit => {
                let currentStreak = 0;
                let longestStreak = 0;
                
                // Calculate current streak
                let dayToCheck = new Date();
                for(let i = 0; i < 365; i++) { 
                    const [year, week] = getWeekNumber(dayToCheck);
                    const weekId = `${year}-W${String(week).padStart(2, '0')}`;
                    const dayIndex = dayToCheck.getDay();
                    
                    const weekData = history[weekId];
                    let isDone = false;
                    if(weekData && weekData[habit.id]) {
                        isDone = habit.type === 'checkbox' ? weekData[habit.id][dayIndex] : !!weekData[habit.id][dayIndex];
                    }

                    if (isDone) {
                        currentStreak++;
                    } else {
                        break; // Current streak ends
                    }
                    dayToCheck.setDate(dayToCheck.getDate() - 1);
                }

                // Calculate longest streak
                let runningLongest = 0;
                for(const weekId of Object.keys(history).sort()) {
                    const weekData = history[weekId];
                    if(!weekData) continue;
                    for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                         let isDone = false;
                         if(weekData[habit.id]) {
                            isDone = habit.type === 'checkbox' ? weekData[habit.id][dayIndex] : !!weekData[habit.id][dayIndex];
                         }
                         if (isDone) {
                             runningLongest++;
                         } else {
                             if(runningLongest > longestStreak) longestStreak = runningLongest;
                             runningLongest = 0;
                         }
                    }
                }
                if(runningLongest > longestStreak) longestStreak = runningLongest;

                results[habit.id] = { current: currentStreak, longest: longestStreak };
            });

            return results;
        }


        // --- Settings Rendering & Logic ---
        function renderSettings() {
            const settingsContent = document.getElementById('settings-content');
            let html = '';
            for (const category in userHabitConfig) {
                 html += `<div class="p-4 border rounded-lg"><h3 class="text-xl font-bold mb-3">${category}</h3><div class="space-y-2">`;
                 userHabitConfig[category].forEach(habit => {
                     html += `
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <span class="font-medium">${habit.name}</span>
                            <div>
                                <button data-id="${habit.id}" class="edit-habit-btn text-sm text-blue-600 hover:underline px-2">Edit</button>
                                <button data-id="${habit.id}" class="delete-habit-btn text-sm text-red-600 hover:underline px-2">Delete</button>
                            </div>
                        </div>
                     `;
                 });
                 html += '</div></div>';
            }
            settingsContent.innerHTML = html;
            addSettingsEventListeners();
        }

        function addSettingsEventListeners() {
            document.getElementById('export-data-btn').addEventListener('click', exportData);
            document.querySelectorAll('.edit-habit-btn').forEach(btn => {
                btn.addEventListener('click', () => openHabitModal(btn.dataset.id));
            });
             document.querySelectorAll('.delete-habit-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteHabit(btn.dataset.id));
            });
        }
        
        async function exportData() {
            if (!userId) return;
            const exportButton = document.getElementById('export-data-btn');
            exportButton.textContent = 'Exporting...';
            exportButton.disabled = true;

            try {
                const habitsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/habits`);
                const querySnapshot = await getDocs(habitsCollectionRef);
                
                const allHabitData = {};
                querySnapshot.forEach(doc => {
                    allHabitData[doc.id] = doc.data();
                });

                const exportObject = {
                    userHabitConfig: userHabitConfig,
                    habitHistory: allHabitData,
                    exportDate: new Date().toISOString()
                };

                const jsonString = JSON.stringify(exportObject, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'habit_tracker_export.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch(error) {
                console.error("Error exporting data:", error);
                alert("Could not export data. Please check the console for errors.");
            } finally {
                exportButton.textContent = 'Export All Data';
                exportButton.disabled = false;
            }
        }
        
        function openHabitModal(habitId = null) {
            habitForm.reset();
            const categorySelect = document.getElementById('habit-category');
            categorySelect.innerHTML = Object.keys(userHabitConfig).map(c => `<option value="${c}">${c}</option>`).join('');
            
            const optionsContainer = document.getElementById('select-options-container');
            document.getElementById('habit-type').addEventListener('change', e => {
                optionsContainer.classList.toggle('hidden', e.target.value !== 'select');
            });

            if (habitId) {
                modalTitle.textContent = "Edit Habit";
                let habitToEdit, categoryToEdit;
                for(const category in userHabitConfig) {
                    const found = userHabitConfig[category].find(h => h.id === habitId);
                    if(found) {
                        habitToEdit = found;
                        categoryToEdit = category;
                        break;
                    }
                }
                
                document.getElementById('habit-id').value = habitId;
                document.getElementById('habit-name').value = habitToEdit.name;
                document.getElementById('habit-category').value = categoryToEdit;
                document.getElementById('habit-type').value = habitToEdit.type;
                if (habitToEdit.type === 'select') {
                    optionsContainer.classList.remove('hidden');
                    document.getElementById('habit-options').value = (habitToEdit.options || []).join(', ');
                } else {
                    optionsContainer.classList.add('hidden');
                }
            } else {
                modalTitle.textContent = "Add New Habit";
                 document.getElementById('habit-id').value = '';
                 optionsContainer.classList.add('hidden');
            }
            habitModal.classList.remove('hidden');
        }

        function closeHabitModal() {
            habitModal.classList.add('hidden');
        }

        async function saveHabit(e) {
            e.preventDefault();
            const habitId = document.getElementById('habit-id').value;
            const name = document.getElementById('habit-name').value;
            const category = document.getElementById('habit-category').value;
            const type = document.getElementById('habit-type').value;
            const options = document.getElementById('habit-options').value.split(',').map(s => s.trim()).filter(Boolean);

            if(!name || !category || !type) {
                alert("Please fill all fields.");
                return;
            }

            if(habitId) { // Editing existing
                let habit, oldCategory;
                 for(const cat in userHabitConfig) {
                    const foundIndex = userHabitConfig[cat].findIndex(h => h.id === habitId);
                    if(foundIndex > -1) {
                       habit = userHabitConfig[cat][foundIndex];
                       oldCategory = cat;
                       break;
                    }
                }
                habit.name = name;
                habit.type = type;
                if (type === 'select') habit.options = options;
                else delete habit.options;

                if(oldCategory !== category) {
                    userHabitConfig[oldCategory] = userHabitConfig[oldCategory].filter(h => h.id !== habitId);
                    userHabitConfig[category].push(habit);
                }

            } else { // Adding new
                const newHabit = { id: 'h' + Date.now(), name, type };
                if (type === 'select') newHabit.options = options;
                userHabitConfig[category].push(newHabit);
            }

            await saveUserHabitConfig();
            renderSettings();
            closeHabitModal();
        }

        async function deleteHabit(habitId) {
             if (!confirm("Are you sure you want to delete this habit? This cannot be undone.")) return;

             for(const category in userHabitConfig) {
                 userHabitConfig[category] = userHabitConfig[category].filter(h => h.id !== habitId);
             }
             await saveUserHabitConfig();
             renderSettings();
        }

        addHabitBtn.addEventListener('click', () => openHabitModal());
        cancelHabitBtn.addEventListener('click', closeHabitModal);
        habitForm.addEventListener('submit', saveHabit);


        // --- Dashboard, News & Weather ---
        function renderDashboard() {
            return `
            <div id="dashboard" class="bg-white rounded-2xl shadow-lg p-6">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Today's Dashboard</h3>
                    <button id="refresh-dashboard-btn" class="px-3 py-1 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg shadow-sm hover:bg-gray-300 transition-colors">Refresh</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div id="weather-widget" class="bg-gray-50 p-4 rounded-lg flex items-center justify-center space-x-4">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 9.168A6 6 0 0110 6a6 6 0 015.668 3.168A2 2 0 0114 13H6a2 2 0 01-1.668-3.832z" clip-rule="evenodd" /></svg>
                        <div id="weather-content">Loading weather...</div>
                    </div>
                    <div id="news-widget" class="bg-gray-50 p-4 rounded-lg flex items-center justify-center space-x-4">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h14a1 1 0 011 1v14a1 1 0 01-1 1H3a1 1 0 01-1-1V3z" /><path d="M5 7h10v2H5V7zm0 4h10v2H5v-2zm0 4h5v2H5v-2z" /></svg>
                        <div id="news-content" class="text-sm space-y-2 flex-grow">Loading news...</div>
                    </div>
                    <div id="prayer-widget" class="bg-gray-50 p-4 rounded-lg flex items-center justify-center space-x-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a.75.75 0 01.75.75v.512c3.54.341 6.25 3.28 6.25 6.738v3.25a.75.75 0 01-1.5 0v-3.25c0-2.89-2.298-5.25-5-5.25v-1.5a.75.75 0 01-.75-.75zM10 4a6 6 0 00-6 6v3.25a.75.75 0 01-1.5 0V10c0-3.458 2.71-6.397 6.25-6.738V2.75A.75.75 0 0110 2zM3 12a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>
                        <div id="prayer-content" class="text-sm space-y-1">Loading prayer times...</div>
                    </div>
                    <div id="history-widget" class="bg-gray-50 p-4 rounded-lg flex items-center justify-center space-x-4">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                        <div id="history-content" class="text-sm">Loading history...</div>
                    </div>
                </div>
            </div>
            `;
        }

        function renderWeather(weatherData) {
            const weatherDiv = document.getElementById('weather-content');
            if (!weatherDiv) return;
            if (weatherData && !weatherData.error) {
                weatherDiv.innerHTML = `
                    <div>
                        <p class="text-2xl font-bold">${weatherData.temperature}C</p>
                        <p class="text-sm text-gray-600">Wind: ${weatherData.windspeed} km/h</p>
                    </div>
                `;
            } else {
                weatherDiv.textContent = (weatherData && weatherData.message) || 'Could not load weather.';
            }
        }

        function renderNews(newsData) {
            const newsDiv = document.getElementById('news-content');
            if (!newsDiv) return;

            if (newsData && !newsData.error && newsData.articles) {
                newsDiv.innerHTML = newsData.articles.slice(0, 3).map(article => `
                    <div class="border-b pb-1 last:border-b-0">
                        <a href="${article.link}" target="_blank" rel="noopener noreferrer" class="font-semibold hover:text-blue-600 text-xs leading-tight">${article.title}</a>
                    </div>
                `).join('');
            } else {
                newsDiv.textContent = (newsData && newsData.message) || 'Could not load news articles.';
            }
        }

        function renderPrayerTimes(prayerData) {
            const prayerDiv = document.getElementById('prayer-content');
            if (!prayerDiv) return;
            if (prayerData && !prayerData.error) {
                const { Fajr, Dhuhr, Asr, Maghrib, Isha } = prayerData;
                prayerDiv.innerHTML = `
                    <div class="grid grid-cols-2 gap-x-2">
                        <span class="font-semibold">Fajr:</span> <span>${Fajr}</span>
                        <span class="font-semibold">Dhuhr:</span> <span>${Dhuhr}</span>
                        <span class="font-semibold">Asr:</span> <span>${Asr}</span>
                        <span class="font-semibold">Maghrib:</span> <span>${Maghrib}</span>
                        <span class="font-semibold">Isha:</span> <span>${Isha}</span>
                    </div>
                `;
            } else {
                 prayerDiv.textContent = (prayerData && prayerData.message) || 'Could not load prayer times.';
            }
        }

        function renderOnThisDay(historyData) {
             const historyDiv = document.getElementById('history-content');
            if (!historyDiv) return;
            if (historyData && !historyData.error && historyData.events && historyData.events.length > 0) {
                 const event = historyData.events[Math.floor(Math.random() * historyData.events.length)];
                 historyDiv.innerHTML = `<p><span class="font-bold">${event.year}:</span> ${event.text}</p>`;
            } else {
                historyDiv.textContent = (historyData && historyData.message) || 'Could not load historical event.';
            }
        }
        
        async function fetchDashboardData(forceRefresh = false) {
            const currentDate = new Date().toISOString().split('T')[0];
            const cacheKey = 'dashboardDataCache';

            if (!forceRefresh) {
                try {
                    const cachedData = JSON.parse(localStorage.getItem(cacheKey));
                    if (cachedData && cachedData.date === currentDate) {
                        renderWeather(cachedData.weather);
                        renderNews(cachedData.news);
                        renderPrayerTimes(cachedData.prayer);
                        renderOnThisDay(cachedData.history);
                        return;
                    }
                } catch (e) {
                    console.error("Could not read cache", e);
                }
            }
            
            const getPrayerTimes = (lat, lon) => new Promise(async (resolve) => {
                try {
                    const date = new Date().toISOString().split('T')[0];
                    const response = await fetch(`https://api.aladhan.com/v1/timings/${date}?latitude=${lat}&longitude=${lon}&method=4`);
                    const data = await response.json();
                    resolve(data.data.timings);
                } catch (error) {
                    console.error("Error fetching prayer times:", error);
                    resolve({ error: true, message: 'Could not fetch prayer times.' });
                }
            });

            const getOnThisDay = () => new Promise(async (resolve) => {
                try {
                    const today = new Date();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const response = await fetch(`https://en.wikipedia.org/api/rest_v1/feed/onthisday/events/${month}/${day}`);
                    const data = await response.json();
                    resolve({ events: data.events });
                } catch (error) {
                    console.error("Error fetching 'On This Day' data:", error);
                     resolve({ error: true, message: "Could not fetch today's history." });
                }
            });

            const getNews = () => new Promise(async (resolve) => {
                const rssFeedUrl = encodeURIComponent("http://feeds.bbci.co.uk/news/world/rss.xml");
                try {
                    const response = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${rssFeedUrl}`);
                    const data = await response.json();
                    resolve(data.status === 'ok' ? { articles: data.items } : { error: true, message: 'Could not load news.' });
                } catch (error) {
                    console.error("Error fetching news:", error);
                    resolve({ error: true, message: 'Could not fetch news.' });
                }
            });

            const getWeatherAndLocation = () => new Promise((resolve) => {
                 if (!navigator.geolocation) {
                    resolve({ weather: { error: true, message: "Geolocation is not supported." }, location: null });
                    return;
                }
                navigator.geolocation.getCurrentPosition(async position => {
                    const { latitude, longitude } = position.coords;
                    try {
                        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`);
                        const data = await response.json();
                        resolve({ weather: data.current_weather, location: { latitude, longitude } });
                    } catch (error) {
                        console.error("Error fetching weather:", error);
                        resolve({ weather: { error: true, message: 'Could not fetch weather.' }, location: { latitude, longitude }});
                    }
                }, () => {
                    resolve({ weather: { error: true, message: 'Location access denied.' }, location: null });
                });
            });

            const { weather, location } = await getWeatherAndLocation();
            let prayerTimes = { error: true, message: 'Location needed for prayer times.' };
            if(location) {
                prayerTimes = await getPrayerTimes(location.latitude, location.longitude);
            }
            const news = await getNews();
            const history = await getOnThisDay();
            
            renderWeather(weather);
            renderNews(news);
            renderPrayerTimes(prayerTimes);
            renderOnThisDay(history);

            const newCache = { date: currentDate, weather, news, prayer: prayerTimes, history };
            localStorage.setItem(cacheKey, JSON.stringify(newCache));
        }

        // --- Rendering Sections ---
        function renderWeeklySection() {
            let html = `<div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Weekly Tasks</h3>
                <div class="space-y-3">`;
            (userHabitConfig["Weekly"] || []).forEach(habit => {
                const key = habit.id;
                if (!habitData[key]) { habitData[key] = [false]; }
                const isChecked = habitData[key][0];
                html += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <label for="${key}" class="font-medium text-gray-700">${habit.name}</label>
                    <input type="checkbox" id="${key}" data-key="${key}" data-day="0" class="h-6 w-6 rounded border-gray-300 text-green-500 focus:ring-green-400 cursor-pointer habit-input" ${isChecked ? 'checked' : ''}>
                </div>`;
            });
            html += `</div></div>`;
            return html;
        }

        function renderDayHabits(dayIndex) {
            let html = '<div class="bg-white rounded-2xl shadow-lg p-6"><h3 class="text-2xl font-bold mb-4 text-gray-800">Daily Habits</h3><div class="space-y-4">';

            Object.keys(userHabitConfig).filter(c => c !== 'Weekly').forEach(category => {
                html += `<div><h4 class="text-lg font-semibold text-gray-600 mb-2">${category}</h4><div class="space-y-3">`;
                userHabitConfig[category].forEach(habit => {
                     const key = habit.id;
                     if (!habitData[key]) { habitData[key] = habit.type === 'checkbox' ? Array(7).fill(false) : Array(7).fill(""); }
                     const habitState = habitData[key][dayIndex];
                     
                     html += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <label class="font-medium text-gray-700">${habit.name}</label>`;

                     if (habit.type === 'checkbox') {
                         html += `<input type="checkbox" data-key="${key}" data-day="${dayIndex}" class="h-6 w-6 rounded border-gray-300 text-green-500 focus:ring-green-400 cursor-pointer habit-input" ${habitState ? 'checked' : ''}>`;
                     } else if (habit.type === 'select') {
                         html += `<select data-key="${key}" data-day="${dayIndex}" class="custom-select rounded-md border-gray-300 shadow-sm focus:border-green-400 focus:ring focus:ring-green-300 focus:ring-opacity-50 text-sm py-1.5 w-40 habit-input">${(habit.options || []).map(opt => `<option value="${opt}" ${opt === (habitState || "") ? 'selected' : ''}>${opt || 'Select'}</option>`).join('')}</select>`;
                     }
                     html += `</div>`;
                });
                html += `</div></div>`;
            });

            html += '</div></div>';
            return html;
        }

        function renderDayJournal(dayIndex) {
            const [year, weekNo] = getWeekNumber(displayedDate);
            const weekStartDate = getDateOfWeek(weekNo, year);
            const journalDate = new Date(weekStartDate);
            journalDate.setDate(journalDate.getDate() + dayIndex);
            const dayOfYear = Math.floor((journalDate - new Date(journalDate.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const prompt = journalPrompts[dayOfYear % journalPrompts.length];
            
            const journalEntry = (habitData.journal && habitData.journal[dayIndex]) || "";
            return `<div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-2 text-gray-800">Journal Entry</h3>
                <p class="text-sm text-gray-500 italic mb-3">"${prompt}"</p>
                <textarea data-day="${dayIndex}" class="journal-entry w-full h-48 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">${journalEntry}</textarea>
            </div>`;
        }

        function renderDayTodos(dayIndex) {
            let html = `<div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Todo List</h3>
                <ul id="todo-list" class="space-y-2 flex-grow min-h-[150px]">
                    ${renderSingleDayTodos(dayIndex)}
                </ul>
                <div class="mt-4 flex space-x-2">
                    <input type="text" id="todo-input" placeholder="New todo..." class="flex-grow w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <button id="add-todo-btn" class="px-3 py-1 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 text-sm">Add</button>
                </div>
            </div>`;
            return html;
        }

        function renderSingleDayTodos(dayIndex) {
            const dayTodos = (habitData.todos && habitData.todos[dayIndex]) || [];
            if (dayTodos.length === 0) return `<li class="text-xs text-gray-500 text-center italic pt-4">No tasks for today.</li>`;
            return dayTodos.map((todo, todoIndex) => `
                <li class="todo-item flex items-center justify-between bg-gray-50 p-2 rounded-md">
                    <input type="checkbox" data-index="${todoIndex}" class="todo-checkbox h-4 w-4 rounded border-gray-300 text-blue-500 focus:ring-blue-400" ${todo.completed ? 'checked' : ''}>
                    <span class="text-sm mx-2 flex-grow ${todo.completed ? 'line-through text-gray-400' : 'text-gray-700'}">${todo.text}</span>
                    <button data-index="${todoIndex}" class="delete-todo-btn text-red-500 hover:text-red-700 font-bold">&times;</button>
                </li>
            `).join('');
        }

        // --- Event Handling ---
        function addAppEventListeners() {
            appContent.addEventListener('click', (e) => {
                if (e.target && e.target.id === 'refresh-dashboard-btn') {
                    const weatherDiv = document.getElementById('weather-content');
                    const newsDiv = document.getElementById('news-content');
                    if(weatherDiv) weatherDiv.innerHTML = 'Refreshing...';
                    if(newsDiv) newsDiv.innerHTML = 'Refreshing...';
                    fetchDashboardData(true);
                }
            });

            // Habit inputs
            appContent.querySelectorAll('.habit-input').forEach(el => {
                el.addEventListener('change', (e) => {
                    const { key, day } = e.target.dataset;
                    const dayIndex = parseInt(day);
                    const previousState = habitData[key][dayIndex];

                    if (e.target.type === 'checkbox') {
                        habitData[key][dayIndex] = e.target.checked;
                         if (e.target.checked && !previousState) {
                             incrementScore(10);
                             showPointsAnimation(e.target, 10);
                         } else if (!e.target.checked && previousState) {
                             incrementScore(-10);
                         }
                    } else {
                        const hadValue = !!previousState && previousState !== "";
                        const hasValue = !!e.target.value && e.target.value !== "";
                        habitData[key][dayIndex] = e.target.value;
                         if (hasValue && !hadValue) {
                            incrementScore(10);
                            showPointsAnimation(e.target, 10);
                         } else if (!hasValue && hadValue) {
                            incrementScore(-10);
                         }
                    }
                    
                    updateFirestore();
                    updateProgress();
                });
            });
            // Journal entry
            let journalTimeout;
            const journalEl = appContent.querySelector('.journal-entry');
            if (journalEl) {
                journalEl.addEventListener('input', (e) => {
                    clearTimeout(journalTimeout);
                    const day = parseInt(e.target.dataset.day);
                    if (!habitData.journal) habitData.journal = Array(7).fill("");
                    habitData.journal[day] = e.target.value;
                    journalTimeout = setTimeout(updateFirestore, 500); // Debounce
                });
            }
            // Todo List interactions
            const addTodoBtn = appContent.querySelector('#add-todo-btn');
            if (addTodoBtn) {
                addTodoBtn.addEventListener('click', () => {
                    const input = appContent.querySelector('#todo-input');
                    if (input && input.value.trim()) {
                        if (!habitData.todos) habitData.todos = { 0:[], 1:[], 2:[], 3:[], 4:[], 5:[], 6:[] };
                        if (!habitData.todos[activeDayIndex]) habitData.todos[activeDayIndex] = [];
                        habitData.todos[activeDayIndex].push({ text: input.value.trim(), completed: false });
                        input.value = '';
                        appContent.querySelector('#todo-list').innerHTML = renderSingleDayTodos(activeDayIndex);
                        updateFirestore();
                    }
                });
            }
            appContent.querySelectorAll('.todo-checkbox, .delete-todo-btn').forEach(el => {
                el.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const wasCompleted = habitData.todos[activeDayIndex][index].completed;
                    
                    if (e.target.classList.contains('todo-checkbox')) {
                         habitData.todos[activeDayIndex][index].completed = e.target.checked;
                         if(e.target.checked && !wasCompleted) incrementScore(5);
                         if(!e.target.checked && wasCompleted) incrementScore(-5);
                    } else {
                         if(wasCompleted) incrementScore(-5);
                         habitData.todos[activeDayIndex].splice(index, 1);
                    }
                    appContent.querySelector('#todo-list').innerHTML = renderSingleDayTodos(activeDayIndex);
                    updateFirestore();
                });
            });
        }
        
        function updateProgress() {
            let totalTasks = 0, completedTasks = 0;
            for (const category in userHabitConfig) {
                userHabitConfig[category].forEach(habit => {
                    const key = habit.id;
                    const habitState = habitData[key]; if (!habitState) return;
                    if (habit.type === 'weekly-checkbox') {
                         totalTasks++; if(habitState[0]) completedTasks++;
                    } else {
                        totalTasks += 7;
                        if(habit.type === 'checkbox') {
                            completedTasks += habitState.filter(Boolean).length;
                        } else {
                            completedTasks += habitState.filter(val => val && val !== "").length;
                        }
                    }
                });
            }
            const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('total-progress-bar').style.width = `${percentage}%`;
            document.getElementById('total-progress-text').textContent = `${percentage}% Complete - Great work!`;
        }

        // --- Navigation Listeners ---
        document.getElementById('prev-week-btn').addEventListener('click', () => navigateWeeks(-1));
        document.getElementById('next-week-btn').addEventListener('click', () => navigateWeeks(1));
        document.getElementById('today-btn').addEventListener('click', () => {
            const today = new Date();
             if (getWeekNumber(displayedDate).join('-') !== getWeekNumber(today).join('-')) {
                displayedDate = today;
                setActiveDayForCurrentWeek();
                updateViewForDate();
            } else {
                // If it's already the current week, just switch to the current day
                const currentDayIndex = today.getDay();
                if (activeDayIndex !== currentDayIndex) {
                    activeDayIndex = currentDayIndex;
                    renderApp();
                }
            }
        });
    </script>
</body>
</html>
