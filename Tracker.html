<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level Up: Hexagon Habit Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; padding-bottom: 80px; }
        .custom-select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>');
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%;
            border-left-color: #09f; animation: spin 1s ease infinite;
        }
        .day-btn.active, .view-btn.active { border-color: #3b82f6; background-color: #eff6ff; color: #1e40af; font-weight: 600; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .points-animation {
            position: absolute; animation: points-pop 0.8s ease-out forwards;
            font-weight: bold; pointer-events: none; z-index: 10;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes points-pop { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-30px) scale(1.2); opacity: 0; } }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        .card { transform: translateY(20px); opacity: 0; animation: fadeInUp 0.5s ease-out forwards; }
        .timeline-hour { grid-template-columns: 50px 1fr; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex justify-center items-center z-50 hidden">
        <div class="loading-spinner"></div>
    </div>

    <div id="auth-container" class="flex items-center justify-center min-h-screen bg-gray-50">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <form id="login-form" class="space-y-6">
                <h2 class="text-3xl font-bold text-center text-gray-900">Level Up Your Life</h2>
                <input id="login-email" type="email" placeholder="Email" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <input id="login-password" type="password" placeholder="Password" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <p id="login-error" class="text-sm text-red-600"></p>
                <button type="submit" class="w-full px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700">Sign In</button>
                <p class="text-center"><a href="#" id="show-signup-link" class="text-blue-600">Sign up</a></p>
            </form>
            <form id="signup-form" class="hidden space-y-6">
                <h2 class="text-3xl font-bold text-center">Create Account</h2>
                <input id="signup-email" type="email" placeholder="Email" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <input id="signup-password" type="password" placeholder="Password" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <p id="signup-error" class="text-sm text-red-600"></p>
                <button type="submit" class="w-full px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700">Sign Up</button>
                <p class="text-center"><a href="#" id="show-login-link" class="text-blue-600">Log in</a></p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <header class="text-center mb-6">
                <div class="mb-2">
                     <span id="rank-badge" class="inline-block px-4 py-1 rounded-full bg-yellow-100 text-yellow-800 font-bold text-sm tracking-wide uppercase shadow-sm">Novice</span>
                </div>
                <h1 class="text-4xl font-bold text-gray-900">The Six Pillars</h1>
                <p class="text-md text-gray-600 mt-2" id="current-week-display">Loading...</p>
                
                <div class="flex justify-center my-4 space-x-2 border-b-2 border-gray-200 pb-2 overflow-x-auto">
                     <button id="view-tracker-btn" class="view-btn px-4 py-2 rounded-lg text-gray-600 border-b-4">Tracker</button>
                     <button id="view-log-btn" class="view-btn px-4 py-2 rounded-lg text-gray-600 border-b-4">Hourly Log</button>
                     <button id="view-analytics-btn" class="view-btn px-4 py-2 rounded-lg text-gray-600 border-b-4">Analytics</button>
                     <button id="view-settings-btn" class="view-btn px-4 py-2 rounded-lg text-gray-600 border-b-4">Settings</button>
                </div>
                 <div class="flex items-center justify-center space-x-6 mt-4 flex-wrap gap-y-2">
                    <div id="week-nav-controls" class="flex items-center space-x-2">
                        <button id="prev-week-btn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&larr;</button>
                        <button id="today-btn" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">Today</button>
                        <button id="next-week-btn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&rarr;</button>
                    </div>
                    <div class="flex items-center space-x-2">
                         <div class="bg-blue-50 text-blue-800 font-bold py-1 px-3 rounded border border-blue-100 text-sm">XP: <span id="discipline-score">0</span></div>
                        <button id="signout-btn" class="text-sm text-red-500 hover:underline">Sign Out</button>
                    </div>
                </div>
            </header>

            <div id="tracker-view">
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 card">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-8">
                        <div class="w-full md:w-1/2">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-800">Attribute Stats</h3>
                                    <p class="text-gray-500 text-xs">Blue = This Week. Grey = Last Week.</p>
                                </div>
                                <button id="refresh-dashboard-btn" class="text-xs bg-gray-100 px-2 py-1 rounded">Refresh Weather</button>
                            </div>
                            <div class="relative w-full h-64">
                                <canvas id="hexagon-chart"></canvas>
                            </div>
                        </div>
                        <div class="w-full md:w-1/2 space-y-4">
                             <div class="grid grid-cols-2 gap-2 text-xs">
                                 <div id="weather-widget" class="bg-blue-50 p-2 rounded border border-blue-100">Loading Weather...</div>
                                 <div id="prayer-widget" class="bg-green-50 p-2 rounded border border-green-100">Loading Prayer...</div>
                             </div>
                             <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                 <h4 class="font-bold text-gray-900">Weekly Progress</h4>
                                 <div class="w-full h-3 bg-gray-200 rounded-full mt-2">
                                    <div id="total-progress-bar" class="h-full bg-blue-500 rounded-full transition-all duration-500" style="width: 0%;"></div>
                                </div>
                                <p id="total-progress-text" class="text-right text-xs mt-1 text-gray-500">0%</p>
                             </div>
                        </div>
                    </div>
                </div>

                <div id="day-nav-container" class="grid grid-cols-4 sm:grid-cols-7 text-center border-b-2 border-gray-200 mb-6"></div>
                <div id="app-content" class="space-y-6"></div>
            </div>

            <div id="log-view" class="hidden">
                 <div class="bg-white rounded-2xl shadow-lg p-6 card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Hourly Log: <span id="hourly-log-date"></span></h2>
                    <div id="hourly-log-content" class="space-y-2">Loading...</div>
                </div>
            </div>
            
            <div id="analytics-view" class="hidden">
                 <div class="bg-white rounded-2xl shadow-lg p-6 card space-y-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Task Completion History</h2>
                        <div class="h-64"><canvas id="todo-chart"></canvas></div>
                    </div>
                    <div id="streaks-container" class="border-t pt-6">
                         <h2 class="text-2xl font-bold text-gray-800 mb-4">Habit Streaks</h2>
                         <button id="generate-report-btn" class="w-full md:w-auto px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600">Generate Report</button>
                         <div id="streaks-content" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 mt-4"></div>
                    </div>
                </div>
            </div>

            <div id="settings-view" class="hidden">
                 <div class="bg-white rounded-2xl shadow-lg p-6 card">
                    <div class="flex justify-between items-center mb-6">
                         <h2 class="text-2xl font-bold text-gray-800">Manage Pillars</h2>
                         <div class="space-x-2">
                            <button id="add-habit-btn" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">Add Habit</button>
                            <button id="export-data-btn" class="px-3 py-1 bg-green-500 text-white rounded text-sm">Export Data</button>
                         </div>
                    </div>
                    <div id="settings-content" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="habit-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Edit/Add Habit</h3>
            <form id="habit-form" class="space-y-4">
                <input type="hidden" id="habit-id">
                <input type="text" id="habit-name" placeholder="Habit Name" class="w-full border p-2 rounded" required>
                <select id="habit-category" class="w-full border p-2 rounded"></select>
                <select id="habit-type" class="w-full border p-2 rounded">
                    <option value="checkbox">Daily Checkbox</option>
                    <option value="weekly-checkbox">Weekly Checkbox</option>
                    <option value="select">Daily Dropdown</option>
                </select>
                <input type="text" id="habit-options" placeholder="Options (comma separated)" class="w-full border p-2 rounded hidden">
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-habit-btn" class="px-4 py-2 bg-gray-200 rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="failure-log-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Log Failure</h3>
            <form id="failure-log-form" class="space-y-4">
                <input type="hidden" id="failure-habit-id"><input type="hidden" id="failure-day-index">
                <textarea id="failure-reason" class="w-full border p-2 rounded" rows="3" placeholder="Why did you miss this?"></textarea>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-failure-log-btn" class="px-4 py-2 bg-gray-200 rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="hourly-log-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Log Activity</h3>
            <form id="hourly-log-form" class="space-y-4">
                <input type="hidden" id="hourly-log-hour"><input type="hidden" id="hourly-log-day">
                <textarea id="hourly-log-activity" class="w-full border p-2 rounded" rows="2" placeholder="What did you do?"></textarea>
                <select id="hourly-log-category" class="w-full border p-2 rounded"></select>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-hourly-log-btn" class="px-4 py-2 bg-gray-200 rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="save-bar" class="fixed bottom-0 left-0 w-full bg-white border-t-2 border-blue-100 p-4 shadow-lg transform translate-y-full transition-transform duration-300 flex justify-between items-center z-50">
        <div class="flex items-center space-x-2"><span class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></span><span class="text-sm font-bold">Unsaved changes</span></div>
        <div class="space-x-2"><button id="discard-changes-btn" class="text-red-500 text-sm">Discard</button><button id="global-save-btn" class="bg-blue-600 text-white px-4 py-1 rounded text-sm font-bold">Save</button></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "FIREBASE_API_KEY_PLACEHOLDER",
            authDomain: "FIREBASE_AUTH_DOMAIN_PLACEHOLDER",
            projectId: "FIREBASE_PROJECT_ID_PLACEHOLDER",
            storageBucket: "FIREBASE_STORAGE_BUCKET_PLACEHOLDER",
            messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID_PLACEHOLDER",
            appId: "FIREBASE_APP_ID_PLACEHOLDER"
        };
        const appId = 'habit-tracker-hexagon';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null, habitData = {}, prevHabitData = {}, userHabitConfig = {}, userConfig = { disciplineScore: 0 };
        let unsubscribe = null, displayedDate = new Date(), activeDayIndex = 0, currentView = 'tracker';
        let hexagonChart = null, todoChart = null, hasUnsavedChanges = false;

        const defaultHabits = {
            "Vitality": [{ id: "v1", name: "Sleep (7-8hrs)", type: "checkbox" }, { id: "v2", name: "Hydration", type: "checkbox" }, { id: "v3", name: "Gym/Fitness", type: "checkbox" }, { id: "v4", name: "Calories", type: "checkbox" }],
            "Intellect": [{ id: "i1", name: "CFA Study", type: "checkbox" }, { id: "i2", name: "Investments", type: "checkbox" }, { id: "i3", name: "SQL/PowerShell", type: "checkbox" }],
            "Spirit": [{ id: "sp1", name: "Prayer", type: "checkbox" }, { id: "sp2", name: "Quran", type: "checkbox" }, { id: "sp3", name: "Dua", type: "checkbox" }],
            "Wealth": [{ id: "w1", name: "Spend < 6.67", type: "checkbox" }, { id: "w2", name: "Save Objective", type: "checkbox" }],
            "Social": [{ id: "so1", name: "Family Time", type: "checkbox" }, { id: "so2", name: "Talk to 1 person", type: "checkbox" }, { id: "so3", name: "Weekly Gathering", type: "weekly-checkbox" }],
            "Discipline": [{ id: "d1", name: "Make Bed", type: "checkbox" }, { id: "d2", name: "Daily Planning", type: "checkbox" }]
        };
        const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const logCats = { "Work": "bg-blue-200", "Leisure": "bg-green-200", "Exercise": "bg-yellow-200", "Learning": "bg-purple-200", "Family": "bg-pink-200", "Sleep": "bg-indigo-200", "Other": "bg-gray-100" };

        // AUTH
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                userId = u.uid;
                await loadConfig();
                setActiveDay();
                await loadData();
                setupNav();
                setupSave();
                fetchWeather(); // Init weather
            } else {
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });

        // CORE LOGIC
        async function loadConfig() {
            let snap = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/config`, 'habits'));
            userHabitConfig = snap.exists() ? snap.data() : JSON.parse(JSON.stringify(defaultHabits));
            snap = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/config`, 'user'));
            userConfig = snap.exists() ? snap.data() : { disciplineScore: 0 };
            updateRank();
        }

        async function loadData() {
            const [y, w] = getWeekNumber(displayedDate);
            const wId = `${y}-W${String(w).padStart(2,'0')}`;
            document.getElementById('current-week-display').textContent = `Week ${w}, ${y}`;
            
            // Prev week for Ghost Graph
            const dPrev = new Date(displayedDate); dPrev.setDate(dPrev.getDate()-7);
            const [py, pw] = getWeekNumber(dPrev);
            const pwId = `${py}-W${String(pw).padStart(2,'0')}`;
            try { const ps = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/habits`, pwId)); prevHabitData = ps.exists() ? ps.data() : {}; } catch(e){}

            if(unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(doc(db, `artifacts/${appId}/users/${userId}/habits`, wId), (s) => {
                if(!hasUnsavedChanges) {
                    habitData = s.exists() ? s.data() : initHabitData();
                    renderApp();
                }
            });
        }

        function initHabitData() {
            const d = { journal: Array(7).fill(""), todos: {}, failureLog: {}, hourlyLog: {} };
            for(let i=0;i<7;i++) { d.todos[i]=[]; d.hourlyLog[i]=[]; }
            for(const c in userHabitConfig) userHabitConfig[c].forEach(h => d[h.id] = (h.type==='weekly-checkbox') ? [false] : (h.type==='checkbox' ? Array(7).fill(false) : Array(7).fill("")));
            return d;
        }

        async function saveData() {
            const [y, w] = getWeekNumber(displayedDate);
            await setDoc(doc(db, `artifacts/${appId}/users/${userId}/habits`, `${y}-W${String(w).padStart(2,'0')}`), habitData, { merge: true });
            await setDoc(doc(db, `artifacts/${appId}/users/${userId}/config`, 'user'), userConfig, { merge: true });
        }

        function markUnsaved() { hasUnsavedChanges = true; document.getElementById('save-bar').classList.remove('translate-y-full'); }
        function setupSave() {
            document.getElementById('global-save-btn').onclick = async () => {
                document.getElementById('global-save-btn').textContent = "Saving...";
                await saveData();
                hasUnsavedChanges = false;
                document.getElementById('global-save-btn').textContent = "Saved";
                setTimeout(() => { document.getElementById('save-bar').classList.add('translate-y-full'); document.getElementById('global-save-btn').textContent = "Save"; }, 1000);
            };
            document.getElementById('discard-changes-btn').onclick = async () => { if(confirm("Discard?")) { hasUnsavedChanges = false; document.getElementById('save-bar').classList.add('translate-y-full'); await loadData(); } };
        }

        // GAMIFICATION
        function updateRank() {
            const s = userConfig.disciplineScore;
            let r = "Novice", c = "bg-gray-100 text-gray-800";
            if (s >= 3000) { r = "Unstoppable"; c = "bg-purple-100 text-purple-800"; }
            else if (s >= 1500) { r = "Consistent"; c = "bg-blue-100 text-blue-800"; }
            else if (s >= 500) { r = "Apprentice"; c = "bg-green-100 text-green-800"; }
            document.getElementById('rank-badge').textContent = r; document.getElementById('rank-badge').className = `inline-block px-4 py-1 rounded-full font-bold text-sm uppercase shadow-sm ${c}`;
            document.getElementById('discipline-score').textContent = s;
        }
        function addXP(el, amt) {
            userConfig.disciplineScore += amt;
            updateRank();
            const anim = document.createElement('span'); anim.textContent = (amt>0?"+":"")+amt; anim.className = 'points-animation';
            anim.style.color = amt>0 ? '#22c55e' : '#ef4444'; el.parentNode.appendChild(anim); setTimeout(()=>anim.remove(), 800);
        }

        // RENDERING
        function renderApp() {
            if (currentView === 'tracker') {
                renderDashboard();
                renderDayNav();
                renderDayContent();
            } else if (currentView === 'log') {
                renderDayNav();
                renderHourlyLog();
            }
        }

        function renderDayNav() {
            const c = document.getElementById('day-nav-container'); c.innerHTML = '';
            days.forEach((d, i) => {
                const b = document.createElement('button'); b.textContent = d; b.className = `day-btn p-3 border-b-4 ${i === activeDayIndex ? 'active' : 'border-transparent text-gray-500'}`;
                b.onclick = () => { activeDayIndex = i; renderApp(); }; c.appendChild(b);
            });
        }

        function renderDayContent() {
            const html = `
                <div class="card">${renderHabitList(activeDayIndex)}</div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                    <div class="card h-full bg-white rounded-2xl shadow-lg p-6 flex flex-col">
                        <h3 class="font-bold mb-4">Todos</h3>
                        <ul id="todo-list" class="space-y-2 flex-grow">${renderTodos(activeDayIndex)}</ul>
                        <div class="mt-4 flex gap-2"><input id="todo-input" class="border p-2 rounded w-full"><button id="add-todo" class="bg-blue-500 text-white px-4 rounded">Add</button></div>
                    </div>
                    <div class="card h-full bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="font-bold mb-2">Journal</h3>
                        <textarea id="journal-input" data-day="${activeDayIndex}" class="w-full h-32 border p-2 rounded bg-gray-50">${habitData.journal[activeDayIndex]||""}</textarea>
                    </div>
                </div>`;
            document.getElementById('app-content').innerHTML = html;
            attachEvents();
        }

        function renderHabitList(day) {
            let h = '<div class="bg-white rounded-2xl shadow-lg p-6 space-y-4">';
            Object.keys(userHabitConfig).forEach(cat => {
                if(userHabitConfig[cat].length === 0) return;
                h += `<div><h4 class="text-xs font-bold text-gray-400 uppercase mb-2">${cat}</h4><div class="space-y-2">`;
                userHabitConfig[cat].forEach(hab => {
                    const k = hab.id;
                    if(!habitData[k]) habitData[k] = hab.type==='checkbox'?Array(7).fill(false):Array(7).fill("");
                    const val = hab.type==='weekly-checkbox'?habitData[k][0]:habitData[k][day];
                    const fail = (habitData.failureLog[k] && habitData.failureLog[k][day]) ? "text-yellow-600" : "text-gray-300";
                    
                    h += `<div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span>${hab.name}</span>
                        <div class="flex items-center gap-2">
                           ${hab.type!=='select' ? `<button class="text-xs ${fail} hover:text-red-500 fail-btn" data-id="${k}" data-day="${day}">âš </button>` : ''}
                           ${hab.type==='select' ? 
                             `<select class="habit-inp border rounded text-sm w-32" data-key="${k}" data-day="${day}">${(hab.options||[]).map(o=>`<option ${o===val?'selected':''}>${o}</option>`).join('')}</select>` : 
                             `<input type="checkbox" class="habit-inp w-5 h-5 text-blue-600" data-key="${k}" data-day="${day}" ${val?'checked':''}>`}
                        </div>
                    </div>`;
                });
                h += '</div></div>';
            });
            return h + '</div>';
        }

        function renderTodos(day) {
            return (habitData.todos[day]||[]).map((t,i) => `
                <li class="flex justify-between bg-gray-50 p-2 rounded">
                    <div class="flex gap-2"><input type="checkbox" class="todo-chk" data-i="${i}" ${t.completed?'checked':''}> <span class="${t.completed?'line-through text-gray-400':''}">${t.text}</span></div>
                    <button class="text-red-400 del-todo" data-i="${i}">Ã—</button>
                </li>`).join('') || '<li class="text-gray-400 italic text-sm">No tasks</li>';
        }

        function renderDashboard() {
            // Hexagon Logic
            const ctx = document.getElementById('hexagon-chart');
            if(ctx) {
                const getScores = (data) => ["Vitality","Intellect","Spirit","Wealth","Social","Discipline"].map(c => {
                    let tot=0, act=0;
                    (userHabitConfig[c]||[]).forEach(h => {
                        if(!data[h.id]) return;
                        if(h.type==='weekly-checkbox'){ tot++; if(data[h.id][0]) act++; }
                        else { tot+=7; act += (h.type==='checkbox' ? data[h.id].filter(Boolean).length : data[h.id].filter(v=>v).length); }
                    });
                    return tot?Math.round((act/tot)*100):0;
                });
                if(hexagonChart) hexagonChart.destroy();
                hexagonChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ["Vitality","Intellect","Spirit","Wealth","Social","Discipline"],
                        datasets: [
                            { label: 'Current', data: getScores(habitData), backgroundColor: 'rgba(59,130,246,0.5)', borderColor: '#3b82f6', borderWidth: 2 },
                            { label: 'Last Week', data: getScores(prevHabitData), borderColor: '#9ca3af', borderDash: [5,5], borderWidth: 2, backgroundColor: 'transparent', pointRadius: 0 }
                        ]
                    },
                    options: { scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { display: false } } }, plugins: { legend: { position: 'bottom' } } }
                });
                
                // Progress Bar
                const cur = getScores(habitData).reduce((a,b)=>a+b,0), max = 600;
                const pct = Math.round((cur/max)*100);
                document.getElementById('total-progress-bar').style.width = `${pct}%`;
                document.getElementById('total-progress-text').textContent = `${pct}% Complete`;
            }
        }

        function renderHourlyLog() {
            const d = activeDayIndex;
            const hLog = document.getElementById('hourly-log-content'); hLog.innerHTML = '';
            const dt = new Date(displayedDate); dt.setDate(dt.getDate() - (dt.getDay() - d));
            document.getElementById('hourly-log-date').textContent = dt.toLocaleDateString();
            
            for(let i=0; i<24; i++) {
                const ent = (habitData.hourlyLog[d] && habitData.hourlyLog[d][i]) || {};
                const color = logCats[ent.category] || "bg-white";
                hLog.innerHTML += `<div class="timeline-hour grid gap-2 items-center text-sm">
                    <span class="text-gray-400 text-right">${i}:00</span>
                    <div class="log-slot border rounded p-2 cursor-pointer hover:opacity-80 ${color}" data-h="${i}">${ent.activity || '<span class="text-gray-300">Log...</span>'}</div>
                </div>`;
            }
            document.querySelectorAll('.log-slot').forEach(b => b.onclick = () => {
                const h = b.dataset.h;
                const ent = (habitData.hourlyLog[d] && habitData.hourlyLog[d][h]) || {};
                document.getElementById('hourly-log-hour').value = h; document.getElementById('hourly-log-day').value = d;
                document.getElementById('hourly-log-activity').value = ent.activity||"";
                document.getElementById('hourly-log-category').innerHTML = Object.keys(logCats).map(c=>`<option ${c===ent.category?'selected':''}>${c}</option>`).join('');
                document.getElementById('hourly-log-modal').classList.remove('hidden');
            });
        }
        
        // ANALYTICS & EXPORT (RESTORED)
        function renderAnalytics() {
            // Weekly Todo Chart
            const ctx = document.getElementById('todo-chart');
            const todoCounts = days.map((_, i) => (habitData.todos[i]||[]).length);
            const todoDone = days.map((_, i) => (habitData.todos[i]||[]).filter(t=>t.completed).length);
            
            if(todoChart) todoChart.destroy();
            todoChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: days, datasets: [{ label: 'Done', data: todoDone, backgroundColor: '#3b82f6' }, { label: 'Total', data: todoCounts, backgroundColor: '#e5e7eb' }] },
                options: { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
            });

            // Generate Streaks (Button Logic)
            document.getElementById('generate-report-btn').onclick = async () => {
                const btn = document.getElementById('generate-report-btn');
                btn.textContent = "Calculating...";
                const container = document.getElementById('streaks-content');
                container.innerHTML = ''; container.classList.remove('hidden');
                
                // Fetch History (Simplified: checks last 4 weeks)
                let streakData = {};
                for(let i=0; i<4; i++) {
                     const d = new Date(); d.setDate(d.getDate() - (i*7));
                     const [y,w] = getWeekNumber(d);
                     const s = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/habits`, `${y}-W${String(w).padStart(2,'0')}`));
                     if(s.exists()) streakData[i] = s.data();
                }

                // Simple Streak calc for first few habits
                let html = '';
                Object.values(userHabitConfig).flat().forEach(h => {
                     if(h.type !== 'checkbox') return;
                     let streak = 0, broken = false;
                     // Check backwards from today
                     for(let w=0; w<4; w++) {
                         if(!streakData[w] || !streakData[w][h.id]) { broken=true; break; }
                         for(let d=6; d>=0; d--) {
                             if(w===0 && d > new Date().getDay()) continue; // Skip future days
                             if(streakData[w][h.id][d]) streak++; else { broken=true; break; }
                         }
                         if(broken) break;
                     }
                     if(streak > 0) html += `<div class="bg-gray-50 p-4 rounded border"><div class="font-bold">${h.name}</div><div class="text-green-600 font-bold text-xl">${streak} Days ðŸ”¥</div></div>`;
                });
                container.innerHTML = html || "<div class='col-span-3 text-center text-gray-500'>No active streaks found. Start today!</div>";
                btn.textContent = "Generate Report";
            };
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ config: userHabitConfig, currentWeek: habitData }));
            const anchor = document.createElement('a');
            anchor.setAttribute("href", dataStr);
            anchor.setAttribute("download", "habit_tracker_export.json");
            document.body.appendChild(anchor); anchor.click(); anchor.remove();
        }
        document.getElementById('export-data-btn').onclick = exportData;

        // EVENT ATTACHMENT
        function attachEvents() {
            document.querySelectorAll('.habit-inp').forEach(i => i.onchange = (e) => {
                const {key, day} = e.target.dataset;
                const prev = habitData[key][day];
                habitData[key][day] = e.target.type==='checkbox' ? e.target.checked : e.target.value;
                // XP Logic
                if(e.target.type==='checkbox' && e.target.checked && !prev) addXP(e.target, 10);
                else if(e.target.type==='checkbox' && !e.target.checked && prev) addXP(e.target, -10);
                markUnsaved(); renderDashboard();
            });
            document.getElementById('add-todo').onclick = () => {
                const t = document.getElementById('todo-input').value;
                if(t) { habitData.todos[activeDayIndex].push({text:t, completed:false}); document.getElementById('todo-input').value=""; renderDayContent(); markUnsaved(); }
            };
            document.querySelectorAll('.todo-chk').forEach(c => c.onclick = (e) => {
                const idx = e.target.dataset.i;
                habitData.todos[activeDayIndex][idx].completed = e.target.checked;
                if(e.target.checked) addXP(e.target, 5); else addXP(e.target, -5);
                renderDayContent(); markUnsaved();
            });
            document.querySelectorAll('.del-todo').forEach(b => b.onclick = (e) => {
                habitData.todos[activeDayIndex].splice(e.target.dataset.i, 1);
                renderDayContent(); markUnsaved();
            });
            document.getElementById('journal-input').oninput = (e) => { habitData.journal[activeDayIndex] = e.target.value; markUnsaved(); };
            document.querySelectorAll('.fail-btn').forEach(b => b.onclick = () => {
                document.getElementById('failure-habit-id').value = b.dataset.id; document.getElementById('failure-day-index').value = b.dataset.day;
                document.getElementById('failure-reason').value = (habitData.failureLog[b.dataset.id]&&habitData.failureLog[b.dataset.id][b.dataset.day])||"";
                document.getElementById('failure-log-modal').classList.remove('hidden');
            });
        }
        
        // SETTINGS & MODAL EVENTS (Simplified)
        function renderSettings() {
            const c = document.getElementById('settings-content'); c.innerHTML = '';
            for(const cat in userHabitConfig) {
                c.innerHTML += `<div class="p-3 border rounded"><h4 class="font-bold">${cat}</h4>${userHabitConfig[cat].map(h=>`<div class="flex justify-between text-sm py-1"><span>${h.name}</span><button class="text-red-500 del-h" data-id="${h.id}">Del</button></div>`).join('')}</div>`;
            }
            document.querySelectorAll('.del-h').forEach(b=>b.onclick=async()=>{ if(confirm("Delete?")){ for(const k in userHabitConfig) userHabitConfig[k]=userHabitConfig[k].filter(h=>h.id!==b.dataset.id); await setDoc(doc(db,`artifacts/${appId}/users/${userId}/config`,'habits'), userHabitConfig); renderSettings(); }});
        }
        document.getElementById('add-habit-btn').onclick = () => {
            document.getElementById('habit-category').innerHTML = Object.keys(userHabitConfig).map(c=>`<option>${c}</option>`).join('');
            document.getElementById('habit-modal').classList.remove('hidden');
        };
        document.getElementById('habit-form').onsubmit = async (e) => {
            e.preventDefault();
            const n=document.getElementById('habit-name').value, c=document.getElementById('habit-category').value, t=document.getElementById('habit-type').value;
            const h = {id: 'h'+Date.now(), name:n, type:t};
            if(t==='select') h.options = document.getElementById('habit-options').value.split(',');
            userHabitConfig[c].push(h);
            await setDoc(doc(db,`artifacts/${appId}/users/${userId}/config`,'habits'), userHabitConfig);
            document.getElementById('habit-modal').classList.add('hidden'); renderSettings();
        };
        document.getElementById('habit-type').onchange = (e) => document.getElementById('habit-options').classList.toggle('hidden', e.target.value!=='select');
        ['cancel-habit-btn','cancel-failure-log-btn','cancel-hourly-log-btn'].forEach(id => document.getElementById(id).onclick = () => document.querySelectorAll('.fixed').forEach(m => { if(m.id.includes('modal')) m.classList.add('hidden'); }));
        document.getElementById('failure-log-form').onsubmit = (e) => {
            e.preventDefault(); const id=document.getElementById('failure-habit-id').value, d=document.getElementById('failure-day-index').value;
            if(!habitData.failureLog[id]) habitData.failureLog[id]=Array(7).fill("");
            habitData.failureLog[id][d] = document.getElementById('failure-reason').value;
            markUnsaved(); document.getElementById('failure-log-modal').classList.add('hidden'); renderDayContent();
        };
        document.getElementById('hourly-log-form').onsubmit = (e) => {
            e.preventDefault(); const h=document.getElementById('hourly-log-hour').value, d=document.getElementById('hourly-log-day').value;
            habitData.hourlyLog[d][h] = {activity:document.getElementById('hourly-log-activity').value, category:document.getElementById('hourly-log-category').value};
            markUnsaved(); document.getElementById('hourly-log-modal').classList.add('hidden'); renderHourlyLog();
        };

        // NAVIGATION & INIT
        function setupNav() {
            Object.keys(viewButtons).forEach(k => {
                document.getElementById(`view-${k}-btn`).onclick = () => {
                    currentView = k; renderApp();
                    if(k==='analytics') renderAnalytics();
                    if(k==='settings') renderSettings();
                    Object.keys(viewButtons).forEach(b => document.getElementById(`view-${b}-btn`).classList.toggle('active', b===k));
                };
            });
            document.getElementById('prev-week-btn').onclick = () => { displayedDate.setDate(displayedDate.getDate()-7); loadData(); };
            document.getElementById('next-week-btn').onclick = () => { displayedDate.setDate(displayedDate.getDate()+7); loadData(); };
            document.getElementById('today-btn').onclick = () => { displayedDate = new Date(); loadData(); };
            document.getElementById('refresh-dashboard-btn').onclick = fetchWeather;
            // Sign in/out toggle logic
            document.getElementById('show-signup-link').onclick = (e)=>{e.preventDefault();document.getElementById('login-form').classList.add('hidden');document.getElementById('signup-form').classList.remove('hidden');};
            document.getElementById('show-login-link').onclick = (e)=>{e.preventDefault();document.getElementById('signup-form').classList.add('hidden');document.getElementById('login-form').classList.remove('hidden');};
            document.getElementById('login-form').onsubmit = async(e)=>{e.preventDefault();try{await signInWithEmailAndPassword(auth,document.getElementById('login-email').value,document.getElementById('login-password').value);}catch(err){document.getElementById('login-error').textContent=err.message;}};
            document.getElementById('signup-form').onsubmit = async(e)=>{e.preventDefault();try{await createUserWithEmailAndPassword(auth,document.getElementById('signup-email').value,document.getElementById('signup-password').value);}catch(err){document.getElementById('signup-error').textContent=err.message;}};
            document.getElementById('signout-btn').onclick = () => signOut(auth);
        }

        async function fetchWeather() {
            if(!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(async p => {
                try {
                    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current=temperature_2m`);
                    const d = await r.json();
                    document.getElementById('weather-widget').textContent = `${d.current.temperature_2m}Â°C`;
                } catch(e) { document.getElementById('weather-widget').textContent = "Weather Error"; }
            });
            // Dummy Prayer Times (Replace with API if needed)
            const d = new Date().toISOString().split('T')[0];
            document.getElementById('prayer-widget').textContent = "Fajr: 05:00, Maghrib: 18:00"; 
        }

        // HELPERS
        function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - d.getUTCDay()); const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return [d.getUTCFullYear(), Math.ceil((((d - yearStart) / 86400000) + 1)/7)]; }
        function setActiveDay() { const t = new Date(); const [cy, cw] = getWeekNumber(t); const [dy, dw] = getWeekNumber(displayedDate); activeDayIndex = (cy===dy && cw===dw) ? t.getDay() : 0; }
        const viewButtons = { tracker:1, log:1, analytics:1, settings:1 };

    </script>
</body>
</html>
