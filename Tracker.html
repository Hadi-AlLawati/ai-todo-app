<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Habit Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; padding-bottom: 80px; }
        .custom-select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>');
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%;
            border-left-color: #09f; animation: spin 1s ease infinite;
        }
        .todo-item span { word-break: break-word; }
        .day-btn.active, .view-btn.active {
            border-color: #3b82f6; background-color: #eff6ff; color: #1e40af; font-weight: 600;
        }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .points-animation {
            position: absolute; animation: points-pop 0.8s ease-out forwards; font-weight: bold; color: #22c55e;
        }
        .card { transform: translateY(20px); opacity: 0; animation: fadeInUp 0.5s ease-out forwards; }
        .timeline-hour { grid-template-columns: 50px 1fr; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes points-pop { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-30px) scale(1.2); opacity: 0; } }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex justify-center items-center z-50 hidden">
        <div class="loading-spinner"></div>
    </div>

    <div id="auth-container" class="flex items-center justify-center min-h-screen bg-gray-50">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <form id="login-form" class="space-y-6">
                <h2 class="text-3xl font-bold text-center text-gray-900">Welcome Back!</h2>
                <div>
                    <label class="text-sm font-medium text-gray-700">Email</label>
                    <input id="login-email" type="email" autocomplete="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Password</label>
                    <input id="login-password" type="password" autocomplete="current-password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500">
                </div>
                <p id="login-error" class="text-sm text-red-600"></p>
                <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">Sign In</button>
                <p class="text-sm text-center text-gray-600">No account? <a href="#" id="show-signup-link" class="text-blue-600 hover:text-blue-500">Sign up</a></p>
            </form>

            <form id="signup-form" class="hidden space-y-6">
                <h2 class="text-3xl font-bold text-center text-gray-900">Create Account</h2>
                <div>
                    <label class="text-sm font-medium text-gray-700">Email</label>
                    <input id="signup-email" type="email" autocomplete="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Password</label>
                    <input id="signup-password" type="password" autocomplete="new-password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500">
                </div>
                <p id="signup-error" class="text-sm text-red-600"></p>
                <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">Sign Up</button>
                <p class="text-sm text-center text-gray-600">Have an account? <a href="#" id="show-login-link" class="text-blue-600 hover:text-blue-500">Log in</a></p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">Daily Discipline Tracker</h1>
                <p class="text-md text-gray-600 mt-2" id="current-week-display">Your journey to consistency starts now.</p>
                
                <div class="flex justify-center my-4 space-x-2 border-b-2 border-gray-200 pb-2 flex-wrap gap-2">
                     <button id="view-tracker-btn" class="view-btn flex items-center space-x-2 px-4 py-2 rounded-lg text-gray-600 border-b-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" /></svg><span>Tracker</span>
                     </button>
                     <button id="view-log-btn" class="view-btn flex items-center space-x-2 px-4 py-2 rounded-lg text-gray-600 border-b-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" /></svg><span>Hourly Log</span>
                     </button>
                     <button id="view-analytics-btn" class="view-btn flex items-center space-x-2 px-4 py-2 rounded-lg text-gray-600 border-b-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" /></svg><span>Analytics</span>
                    </button>
                    <button id="view-character-btn" class="view-btn flex items-center space-x-2 px-4 py-2 rounded-lg text-gray-600 border-b-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg><span>Character</span>
                    </button>
                     <button id="view-settings-btn" class="view-btn flex items-center space-x-2 px-4 py-2 rounded-lg text-gray-600 border-b-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0l-.1.41a1.5 1.5 0 01-2.1 1.45c-1.45-.4-2.8.9-2.4 2.34l.24 1.1a1.5 1.5 0 01-1.45 2.1l-1.1.24c-1.45.4-1.98 2.32-.54 3.25l.8 1.32a1.5 1.5 0 010 2.4l-.8 1.32c-1.45.93-.92 2.85.54 3.25l1.1.24a1.5 1.5 0 011.45 2.1l-.24 1.1c-.4 1.45.95 2.75 2.4 2.34l1.1-.24a1.5 1.5 0 012.1 1.45l.1.41c.38 1.56 2.6 1.56 2.98 0l.1-.41a1.5 1.5 0 012.1-1.45l1.1.24c1.45.4 2.8-.9 2.4-2.34l-.24-1.1a1.5 1.5 0 011.45-2.1l1.1-.24c1.45-.4 1.98-2.32.54-3.25l-.8-1.32a1.5 1.5 0 010-2.4l.8-1.32c1.45-.93.92-2.85-.54-3.25l-1.1-.24a1.5 1.5 0 01-1.45-2.1l.24-1.1c.4-1.45-.95-2.75-2.4-2.34l-1.1.24a1.5 1.5 0 01-2.1-1.45l-.1-.41zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg><span>Settings</span>
                    </button>
                </div>
                 <div class="flex items-center justify-center space-x-6 mt-4">
                    <div id="week-nav-controls" class="flex items-center space-x-4">
                        <button id="prev-week-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg shadow-sm hover:bg-gray-300 transition-colors">&larr; Prev</button>
                        <button id="today-btn" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 transition-colors">Today</button>
                        <button id="next-week-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg shadow-sm hover:bg-gray-300 transition-colors">Next &rarr;</button>
                    </div>
                    <div class="flex items-center space-x-4">
                         <div class="bg-yellow-100 text-yellow-800 font-bold py-2 px-4 rounded-lg shadow-sm">
                            Score: <span id="discipline-score">0</span>
                        </div>
                        <button id="signout-btn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-sm hover:bg-red-600 transition-colors">Sign Out</button>
                    </div>
                </div>
                 <p id="user-email" class="text-sm text-gray-500 mt-4"></p>
            </header>

            <div id="tracker-view">
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 card">
                    <h2 class="text-xl font-bold mb-2">Weekly Progress</h2>
                    <div class="w-full h-4 bg-gray-200 rounded-full">
                        <div id="total-progress-bar" class="h-full text-center text-xs text-white bg-green-500 rounded-full transition-all duration-500" style="width: 0%;"></div>
                    </div>
                    <p id="total-progress-text" class="text-center text-sm font-medium text-gray-600 mt-2">0% Complete</p>
                </div>

                <div id="day-nav-container" class="grid grid-cols-4 sm:grid-cols-7 text-center border-b-2 border-gray-200 mb-6"></div>
                <div id="app-content" class="space-y-6"></div>
            </div>

             <div id="log-view" class="hidden">
                 <div class="bg-white rounded-2xl shadow-lg p-6 card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Hourly Log for <span id="hourly-log-date"></span></h2>
                    <div id="hourly-log-content" class="space-y-2">Loading log...</div>
                </div>
            </div>
            
            <div id="analytics-view" class="hidden">
                 <div class="bg-white rounded-2xl shadow-lg p-6 card space-y-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Weekly Todo Summary</h2>
                        <canvas id="todo-chart"></canvas>
                    </div>
                    <div id="streaks-container">
                        <div id="analytics-prompt" class="text-center py-8 border-t">
                             <h2 class="text-2xl font-bold text-gray-800 mb-4">Habit Streaks</h2>
                             <p class="text-gray-600 mb-6">Generate a report to see your long-term habit streaks.</p>
                             <button id="generate-report-btn" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 transition-colors">Generate Streaks Report</button>
                        </div>
                        <div id="streaks-content" class="hidden space-y-3"></div>
                    </div>
                </div>
            </div>

            <div id="character-view" class="hidden">
                <div class="bg-white rounded-2xl shadow-lg p-6 card mb-6">
                    <div class="text-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-900 mb-1" id="character-rank-title">Novice</h2>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 max-w-md mx-auto mt-2">
                            <div id="xp-bar" class="bg-purple-600 h-2.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">Total Monthly XP: <span id="total-xp-display">0</span></p>
                    </div>
                    <div class="relative w-full max-w-lg mx-auto aspect-square">
                        <canvas id="radar-chart"></canvas>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-8 text-center text-sm">
                        <div class="p-3 bg-red-50 rounded-lg"><span class="block font-bold text-red-700">Vitality</span><span id="score-vitality">0</span> XP</div>
                        <div class="p-3 bg-blue-50 rounded-lg"><span class="block font-bold text-blue-700">Intellect</span><span id="score-intellect">0</span> XP</div>
                        <div class="p-3 bg-purple-50 rounded-lg"><span class="block font-bold text-purple-700">Spirit</span><span id="score-spirit">0</span> XP</div>
                        <div class="p-3 bg-green-50 rounded-lg"><span class="block font-bold text-green-700">Wealth</span><span id="score-wealth">0</span> XP</div>
                        <div class="p-3 bg-yellow-50 rounded-lg"><span class="block font-bold text-yellow-700">Social</span><span id="score-social">0</span> XP</div>
                        <div class="p-3 bg-gray-50 rounded-lg"><span class="block font-bold text-gray-700">Discipline</span><span id="score-discipline">0</span> XP</div>
                    </div>
                    <p class="text-xs text-center text-gray-400 mt-4">Solid shape is This Month. Ghost shape is Last Month.</p>
                </div>
            </div>

            <div id="settings-view" class="hidden">
                 <div class="bg-white rounded-2xl shadow-lg p-6 card">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                         <h2 class="text-2xl font-bold text-gray-800">Customize Habits</h2>
                         <div class="flex space-x-2">
                            <button id="add-habit-btn" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 transition-colors text-sm">Add New Habit</button>
                            <button id="export-data-btn" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-sm hover:bg-green-600 transition-colors text-sm">Export All Data</button>
                         </div>
                    </div>
                    <div id="settings-content" class="space-y-4">Loading settings...</div>
                </div>
            </div>

            <footer class="text-center mt-12 py-6 border-t-2 border-gray-200">
                <div class="w-full max-w-4xl mx-auto">
                    <p class="text-gray-500 text-lg">"The secret of getting ahead is getting started."</p>
                    <p class="text-gray-400 text-sm mt-2">- Mark Twain</p>
                </div>
            </footer>
        </div>
    </div>
    
    <div id="habit-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Add Habit</h3>
            <form id="habit-form">
                <input type="hidden" id="habit-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Habit Name</label>
                    <input type="text" id="habit-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Category</label>
                    <select id="habit-category" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500"></select>
                </div>
                 <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Type</label>
                    <select id="habit-type" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500">
                        <option value="checkbox">Checkbox (Daily)</option>
                        <option value="weekly-checkbox">Checkbox (Weekly)</option>
                        <option value="select">Dropdown (Daily)</option>
                    </select>
                </div>
                <div id="select-options-container" class="mb-4 hidden">
                     <label class="block text-sm font-medium text-gray-700">Dropdown Options (comma separated)</label>
                    <input type="text" id="habit-options" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-habit-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Habit</button>
                </div>
            </form>
        </div>
    </div>

    <div id="failure-log-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 id="failure-modal-title" class="text-xl font-bold mb-4">Log Failure</h3>
            <form id="failure-log-form">
                <input type="hidden" id="failure-habit-id"><input type="hidden" id="failure-day-index">
                 <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Reason for missing this habit:</label>
                    <textarea id="failure-reason" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500" rows="4"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-failure-log-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Reason</button>
                </div>
            </form>
        </div>
    </div>

    <div id="hourly-log-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 id="hourly-log-modal-title" class="text-xl font-bold mb-4">Log for 00:00</h3>
            <form id="hourly-log-form">
                <input type="hidden" id="hourly-log-hour"><input type="hidden" id="hourly-log-day">
                 <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Activity:</label>
                    <textarea id="hourly-log-activity" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500" rows="3"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Category:</label>
                    <select id="hourly-log-category" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500"></select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-hourly-log-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="save-bar" class="fixed bottom-0 left-0 w-full bg-white border-t-2 border-blue-100 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] transform translate-y-full transition-transform duration-300 flex justify-between items-center z-50">
        <div class="flex items-center space-x-2">
            <span class="flex h-3 w-3 relative">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span>
            </span>
            <span class="text-gray-700 font-semibold">You have unsaved changes</span>
        </div>
        <div class="flex space-x-3">
             <button id="discard-changes-btn" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors font-medium">Discard</button>
             <button id="global-save-btn" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md transition-colors flex items-center space-x-2"><span>Save Changes</span></button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const ICONS = {
            weather: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 9.168A6 6 0 0110 6a6 6 0 015.668 3.168A2 2 0 0114 13H6a2 2 0 01-1.668-3.832z" clip-rule="evenodd" /></svg>`,
            news: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h14a1 1 0 011 1v14a1 1 0 01-1 1H3a1 1 0 01-1-1V3z" /><path d="M5 7h10v2H5V7zm0 4h10v2H5v-2zm0 4h5v2H5v-2z" /></svg>`,
            prayer: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a.75.75 0 01.75.75v.512c3.54.341 6.25 3.28 6.25 6.738v3.25a.75.75 0 01-1.5 0v-3.25c0-2.89-2.298-5.25-5-5.25v-1.5a.75.75 0 01-.75-.75zM10 4a6 6 0 00-6 6v3.25a.75.75 0 01-1.5 0V10c0-3.458 2.71-6.397 6.25-6.738V2.75A.75.75 0 0110 2zM3 12a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>`,
            history: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>`
        };

        const firebaseConfig = {
            apiKey: "FIREBASE_API_KEY_PLACEHOLDER",
            authDomain: "FIREBASE_AUTH_DOMAIN_PLACEHOLDER",
            projectId: "FIREBASE_PROJECT_ID_PLACEHOLDER",
            storageBucket: "FIREBASE_STORAGE_BUCKET_PLACEHOLDER",
            messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID_PLACEHOLDER",
            appId: "FIREBASE_APP_ID_PLACEHOLDER"
        };
        const appId = 'habit-tracker-live';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null, habitData = {}, userHabitConfig = {}, userConfig = {}, unsubscribe = null;
        let displayedDate = new Date(), activeDayIndex = 0, currentView = 'tracker', todoChartInstance = null, radarChartInstance = null;
        let hasUnsavedChanges = false, globalListenersAttached = false;

        const authContainer = document.getElementById('auth-container'), mainAppContainer = document.getElementById('app-container');
        const loadingOverlay = document.getElementById('loading-overlay'), userEmailDisplay = document.getElementById('user-email');
        const loginForm = document.getElementById('login-form'), signupForm = document.getElementById('signup-form');
        const showSignupLink = document.getElementById('show-signup-link'), showLoginLink = document.getElementById('show-login-link');
        const signoutBtn = document.getElementById('signout-btn'), dayNavContainer = document.getElementById('day-nav-container');
        const appContent = document.getElementById('app-content'), disciplineScoreDisplay = document.getElementById('discipline-score');
        const saveBar = document.getElementById('save-bar'), globalSaveBtn = document.getElementById('global-save-btn'), discardBtn = document.getElementById('discard-changes-btn');

        const views = { tracker: document.getElementById('tracker-view'), log: document.getElementById('log-view'), analytics: document.getElementById('analytics-view'), character: document.getElementById('character-view'), settings: document.getElementById('settings-view') };
        const viewButtons = { tracker: document.getElementById('view-tracker-btn'), log: document.getElementById('view-log-btn'), analytics: document.getElementById('view-analytics-btn'), character: document.getElementById('view-character-btn'), settings: document.getElementById('view-settings-btn') };
        const weekNavControls = document.getElementById('week-nav-controls'), analyticsPrompt = document.getElementById('analytics-prompt'), generateReportBtn = document.getElementById('generate-report-btn');
        const habitModal = document.getElementById('habit-modal'), habitForm = document.getElementById('habit-form'), modalTitle = document.getElementById('modal-title');
        const addHabitBtn = document.getElementById('add-habit-btn'), cancelHabitBtn = document.getElementById('cancel-habit-btn');
        const failureLogModal = document.getElementById('failure-log-modal'), failureLogForm = document.getElementById('failure-log-form'), cancelFailureLogBtn = document.getElementById('cancel-failure-log-btn');
        const hourlyLogModal = document.getElementById('hourly-log-modal'), hourlyLogForm = document.getElementById('hourly-log-form'), cancelHourlyLogBtn = document.getElementById('cancel-hourly-log-btn');

        const defaultHabits = {
            "Health": [ { id: "h1", name: "Body", type: "checkbox" }, { id: "h2", name: "Face", type: "checkbox" }, { id: "h3", name: "Ears", type: "checkbox" }, { id: "h4", name: "Teeth", type: "checkbox" }, { id: "h5", name: "Smell", type: "checkbox" }, { id: "h6", name: "Calories (>3000)", type: "checkbox" }, { id: "h7", name: "Stretch", type: "checkbox" }, { id: "h8", name: "Sleep (7-8 hours)", type: "checkbox" }, { id: "h9", name: "Hydration", type: "checkbox" }, { id: "h10", name: "Physical Activity", type: "select", options: ["", "Muscle", "Padel", "Running", "Tennis"] } ],
            "Mind": [ { id: "m1", name: "Investments Learning", type: "select", options: ["", "Crypto", "Stock", "News"] }, { id: "m2", name: "CFA Learning", type: "checkbox" }, { id: "m3", name: "Padel Learning", type: "checkbox" }, { id: "m4", name: "Tennis Learning", type: "checkbox" }, { id: "m5", name: "Discipline", type: "checkbox" }, { id: "m6", name: "Talk to one person", type: "checkbox" }, { id: "m7", name: "Family time (30min)", type: "checkbox" }, { id: "m8", name: "Daily Planning/Review", type: "checkbox" }, { id: "m9", name: "Tidying Up", type: "checkbox" } ],
            "Spirit": [ { id: "s1", name: "Affirmations", type: "checkbox" }, { id: "s2", name: "Prayer", type: "checkbox" }, { id: "s3", name: "Quran", type: "checkbox" }, { id: "s4", name: "Dua", type: "checkbox" } ],
            "Budget": [ { id: "b1", name: "Spend < 6.67 OMR", type: "checkbox" } ],
            "Weekly": [ { id: "w1", name: "Family Outing", type: "weekly-checkbox" }, { id: "w2", name: "Extended Family Gathering", type: "weekly-checkbox" }, { id: "w3", name: "Charity", type: "weekly-checkbox" } ]
        };
        const ATTRIBUTE_MAP = {
            "h1": "Vitality", "h2": "Vitality", "h3": "Vitality", "h4": "Vitality", "h5": "Vitality", "h6": "Vitality", "h7": "Vitality", "h8": "Vitality", "h9": "Vitality", "h10": "Vitality",
            "m1": "Intellect", "m2": "Intellect", "m3": "Intellect", "m4": "Intellect", "m5": "Discipline", "m6": "Social", "m7": "Social", "m8": "Discipline", "m9": "Discipline",
            "s1": "Spirit", "s2": "Spirit", "s3": "Spirit", "s4": "Spirit", "b1": "Wealth", "w1": "Social", "w2": "Social", "w3": "Social"
        };
        const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const journalPrompts = [ "What was one win from today?", "What is something you're grateful for?", "One thing to make tomorrow better?", "A moment that made you smile?", "Challenge faced today?", "Looking forward to?", "Something you learned today.", "Describe today in 3 words.", "What's on your mind?" ];
        const hourlyLogCategories = { "Work": "bg-blue-200", "Leisure": "bg-green-200", "Exercise": "bg-yellow-200", "Learning": "bg-purple-200", "Family/Social": "bg-pink-200", "Chores": "bg-gray-200", "Sleep": "bg-indigo-200", "Other": "bg-white" };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                authContainer.classList.add('hidden'); mainAppContainer.classList.remove('hidden'); loadingOverlay.classList.remove('hidden');
                userId = user.uid; userEmailDisplay.textContent = `Signed in as: ${user.email}`;
                await loadUserConfig();
                setActiveDayForCurrentWeek(); updateViewForDate(); setupViewNavigation(); setupSaveHandlers();
                if (!globalListenersAttached) { setupGlobalListeners(); globalListenersAttached = true; }
            } else {
                authContainer.classList.remove('hidden'); mainAppContainer.classList.add('hidden');
                if (unsubscribe) unsubscribe(); userId = null; habitData = {}; loadingOverlay.classList.add('hidden');
            }
        });

        function setupGlobalListeners() {
            appContent.addEventListener('click', (e) => {
                if (e.target.classList.contains('log-failure-btn')) openFailureLogModal(e.target.dataset.key, e.target.dataset.day);
                else if (e.target.id === 'add-todo-btn') handleAddTodo();
                else if (e.target.classList.contains('delete-todo-btn')) handleDeleteTodo(e.target.dataset.index);
            });
            appContent.addEventListener('change', (e) => {
                if (e.target.classList.contains('habit-input')) handleHabitChange(e.target);
                else if (e.target.classList.contains('todo-checkbox')) handleTodoToggle(e.target.dataset.index, e.target.checked);
            });
            appContent.addEventListener('input', (e) => {
                if (e.target.classList.contains('journal-entry')) {
                    if (!habitData.journal) habitData.journal = Array(7).fill("");
                    habitData.journal[parseInt(e.target.dataset.day)] = e.target.value; markUnsaved();
                }
            });
            views.log.addEventListener('click', (e) => {
                const slot = e.target.closest('.hourly-log-slot'); if (slot) openHourlyLogModal(slot.dataset.hour, slot.dataset.day);
            });
        }

        function handleHabitChange(target) {
            const { key, day } = target.dataset; const dayIndex = parseInt(day);
            const previousState = habitData[key] ? habitData[key][dayIndex] : undefined;
            if (!habitData[key]) habitData[key] = target.type === 'checkbox' ? Array(7).fill(false) : Array(7).fill("");
            
            if (target.type === 'checkbox') {
                habitData[key][dayIndex] = target.checked;
                if (target.checked && !previousState) { incrementScore(10); showPointsAnimation(target, 10); }
                else if (!target.checked && previousState) incrementScore(-10);
            } else {
                const hadValue = !!previousState && previousState !== ""; const hasValue = !!target.value && target.value !== "";
                habitData[key][dayIndex] = target.value;
                if (hasValue && !hadValue) { incrementScore(10); showPointsAnimation(target, 10); }
                else if (!hasValue && hadValue) incrementScore(-10);
            }
            renderDayHabits(activeDayIndex); updateProgress(); markUnsaved();
        }

        function handleAddTodo() {
            const input = appContent.querySelector('#todo-input');
            if (input && input.value.trim()) {
                if (!habitData.todos) habitData.todos = {0:[],1:[],2:[],3:[],4:[],5:[],6:[]};
                if (!habitData.todos[activeDayIndex]) habitData.todos[activeDayIndex] = [];
                habitData.todos[activeDayIndex].push({ text: input.value.trim(), completed: false });
                input.value = ''; appContent.querySelector('#todo-list').innerHTML = renderSingleDayTodos(activeDayIndex); markUnsaved();
            }
        }
        function handleDeleteTodo(index) {
            index = parseInt(index); const wasCompleted = habitData.todos[activeDayIndex][index].completed;
            if(wasCompleted) incrementScore(-5);
            habitData.todos[activeDayIndex].splice(index, 1);
            appContent.querySelector('#todo-list').innerHTML = renderSingleDayTodos(activeDayIndex); markUnsaved();
        }
        function handleTodoToggle(index, isChecked) {
            index = parseInt(index); const wasCompleted = habitData.todos[activeDayIndex][index].completed;
            habitData.todos[activeDayIndex][index].completed = isChecked;
            if(isChecked && !wasCompleted) incrementScore(5); if(!isChecked && wasCompleted) incrementScore(-5);
            appContent.querySelector('#todo-list').innerHTML = renderSingleDayTodos(activeDayIndex); markUnsaved();
        }

        function setupSaveHandlers() {
            globalSaveBtn.addEventListener('click', async () => {
                globalSaveBtn.innerHTML = `<span>Saving...</span>`; globalSaveBtn.disabled = true;
                await updateFirestore(); hasUnsavedChanges = false;
                globalSaveBtn.innerHTML = `<span>Saved!</span>`;
                setTimeout(() => { saveBar.classList.add('translate-y-full'); globalSaveBtn.innerHTML = `<span>Save Changes</span>`; globalSaveBtn.disabled = false; }, 1000);
            });
            discardBtn.addEventListener('click', async () => {
                if(confirm("Discard unsaved changes?")) {
                    hasUnsavedChanges = false; saveBar.classList.add('translate-y-full');
                    const [year, week] = getWeekNumber(displayedDate); setupTracker(`${year}-W${String(week).padStart(2, '0')}`); await loadUserConfig();
                }
            });
            window.addEventListener('beforeunload', (e) => { if (hasUnsavedChanges) { e.preventDefault(); e.returnValue = ''; } });
        }
        function markUnsaved() { if (!hasUnsavedChanges) { hasUnsavedChanges = true; saveBar.classList.remove('translate-y-full'); } }

        async function loadUserConfig() {
            const hSnap = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/config`, 'habits'));
            userHabitConfig = hSnap.exists() ? hSnap.data() : JSON.parse(JSON.stringify(defaultHabits));
            if (!hSnap.exists()) await setDoc(doc(db, `artifacts/${appId}/users/${userId}/config`, 'habits'), userHabitConfig);
            const uSnap = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/config`, 'user'));
            userConfig = uSnap.exists() ? uSnap.data() : { disciplineScore: 0 };
            if (!uSnap.exists()) await setDoc(doc(db, `artifacts/${appId}/users/${userId}/config`, 'user'), userConfig);
            disciplineScoreDisplay.textContent = userConfig.disciplineScore || 0;
        }
        async function saveUserHabitConfig() { if (!userId) return; await setDoc(doc(db, `artifacts/${appId}/users/${userId}/config`, 'habits'), userHabitConfig); }
        function incrementScore(points) { userConfig.disciplineScore = (userConfig.disciplineScore || 0) + points; disciplineScoreDisplay.textContent = userConfig.disciplineScore; }
        function showPointsAnimation(element, points) {
            const p = document.createElement('span'); p.textContent = `+${points}`; p.className = 'points-animation';
            element.parentElement.style.position = 'relative'; element.parentElement.appendChild(p); setTimeout(() => p.remove(), 800);
        }

        showSignupLink.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
        loginForm.addEventListener('submit', async (e) => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value); } catch(e) { document.getElementById('login-error').textContent = "Invalid credentials."; } });
        signupForm.addEventListener('submit', async (e) => { e.preventDefault(); try { await createUserWithEmailAndPassword(auth, signupForm['signup-email'].value, signupForm['signup-password'].value); } catch(e) { document.getElementById('signup-error').textContent = e.message; } });
        signoutBtn.addEventListener('click', async () => { try { await signOut(auth); } catch(e) { console.error(e); } });

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - d.getUTCDay());
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return [d.getUTCFullYear(), Math.ceil((((d - yearStart) / 86400000) + 1) / 7)];
        }
        function getDateOfWeek(w, y) { const s = new Date(y, 0, 1 + (w - 1) * 7); s.setDate(s.getDate() - s.getDay()); return s; }
        function setActiveDayForCurrentWeek() {
             const t = new Date(); const [cy, cw] = getWeekNumber(t); const [dy, dw] = getWeekNumber(displayedDate);
             activeDayIndex = (cy === dy && cw === dw) ? t.getDay() : 0;
        }
        function updateViewForDate() {
            if (!userId) return; const [y, w] = getWeekNumber(displayedDate); document.getElementById('current-week-display').textContent = `Week ${w}, ${y}`;
            const nb = document.getElementById('next-week-btn'), t = new Date(), [cy, cw] = getWeekNumber(t);
            nb.disabled = y > cy || (y === cy && w >= cw); nb.classList.toggle('opacity-50', nb.disabled);
            setupTracker(`${y}-W${String(w).padStart(2, '0')}`);
        }
        function navigateWeeks(o) { if(hasUnsavedChanges && !confirm("Discard unsaved changes?")) return; hasUnsavedChanges=false; saveBar.classList.add('translate-y-full'); displayedDate.setDate(displayedDate.getDate() + (o * 7)); setActiveDayForCurrentWeek(); updateViewForDate(); }
        
        async function setupTracker(wId) {
            const ref = doc(db, `artifacts/${appId}/users/${userId}/habits`, wId); if (unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(ref, (s) => {
                if(!hasUnsavedChanges) {
                    habitData = s.exists() ? s.data() : initializeEmptyHabitData();
                    if (!s.exists()) setDoc(ref, habitData);
                    renderApp(); loadingOverlay.classList.add('hidden');
                }
            }, (e) => loadingOverlay.innerHTML = `<p class="text-red-500">Error.</p>`);
        }
        function initializeEmptyHabitData() {
            const d = {}; for (const c in userHabitConfig) { userHabitConfig[c].forEach(h => d[h.id] = h.type === 'weekly-checkbox' ? [false] : (h.type === 'checkbox' ? Array(7).fill(false) : Array(7).fill(""))); }
            d.journal = Array(7).fill(""); d.todos = {0:[],1:[],2:[],3:[],4:[],5:[],6:[]}; d.failureLog = {}; d.hourlyLog = {};
            return d;
        }
        async function updateFirestore() {
             if (!userId) return; const [y, w] = getWeekNumber(displayedDate);
             try { await setDoc(doc(db, `artifacts/${appId}/users/${userId}/habits`, `${y}-W${String(w).padStart(2,'0')}`), habitData, { merge: true }); await setDoc(doc(db, `artifacts/${appId}/users/${userId}/config`, 'user'), userConfig, { merge: true }); } catch(e) { alert("Save failed."); }
        }

        function setupViewNavigation() { Object.keys(viewButtons).forEach(v => viewButtons[v].addEventListener('click', () => switchView(v))); switchView('tracker'); }
        function switchView(v) {
            if(hasUnsavedChanges && v !== currentView && !confirm("Leave with unsaved changes?")) return;
            currentView = v; Object.keys(views).forEach(k => { const a = k === v; views[k].classList.toggle('hidden', !a); viewButtons[k].classList.toggle('active', a); });
            weekNavControls.classList.toggle('hidden', v !== 'tracker' && v !== 'log');
            if (v === 'log') renderHourlyLog();
            if (v === 'analytics') { analyticsPrompt.classList.remove('hidden'); document.getElementById('streaks-content').classList.add('hidden'); renderWeeklyTodoChart(); }
            if (v === 'character') renderCharacterPage();
            if (v === 'settings') renderSettings();
        }

        function renderApp() {
            if (currentView === 'tracker') { renderDayNavigation(); renderContentForDay(); }
            else if (currentView === 'log') { renderDayNavigation(); renderHourlyLog(); }
            updateProgress();
        }
        function renderDayNavigation() {
            dayNavContainer.innerHTML = ''; days.forEach((d, i) => {
                const b = document.createElement('button'); b.textContent = d; b.className = `day-btn p-3 border-b-4 ${i === activeDayIndex ? 'active' : 'border-transparent text-gray-500 hover:border-gray-300'}`;
                b.addEventListener('click', () => { activeDayIndex = i; renderApp(); }); dayNavContainer.appendChild(b);
            });
        }
        function renderContentForDay() {
            const t = new Date(), isCur = activeDayIndex === t.getDay() && getWeekNumber(displayedDate).join('-') === getWeekNumber(t).join('-');
            appContent.innerHTML = `<div class="card">${isCur ? renderDashboard() : ''}</div><div class="card" style="animation-delay: 100ms;">${renderWeeklySection()}</div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="card" style="animation-delay: 200ms;">${renderDayJournal(activeDayIndex)}</div><div class="card" style="animation-delay: 250ms;">${renderDayTodos(activeDayIndex)}</div></div><div class="card" style="animation-delay: 300ms;">${renderDayHabits(activeDayIndex)}</div>`;
            if (isCur) fetchDashboardData();
        }
        
        function renderWeeklyTodoChart() {
             const stats = { labels: days, total: [], completed: [] };
             for (let i = 0; i < 7; i++) { const t = (habitData.todos && habitData.todos[i]) || []; stats.total.push(t.length); stats.completed.push(t.filter(x => x.completed).length); }
            const ctx = document.getElementById('todo-chart').getContext('2d');
            if(todoChartInstance) todoChartInstance.destroy();
            todoChartInstance = new Chart(ctx, { type: 'bar', data: { labels: stats.labels, datasets: [{ label: 'Done', data: stats.completed, backgroundColor: '#3b82f6' }, { label: 'Total', data: stats.total, backgroundColor: '#d1d5db' }] }, options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
        }

        async function renderStreaksReport() {
            const sc = document.getElementById('streaks-content'); sc.innerHTML = 'Calculating...'; sc.classList.remove('hidden');
            const h = await fetchAllYearData();
            if(Object.keys(h).length === 0) { sc.innerHTML = '<p>No data.</p>'; return; }
            const streaks = calculateAllStreaks(h);
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
            for(const c in userHabitConfig) { userHabitConfig[c].forEach(b => { const s = streaks[b.id] || {c:0,l:0}; html += `<div class="bg-gray-50 p-4 rounded-lg"><p class="font-bold text-gray-800">${b.name}</p><p class="text-sm text-gray-600">Streak: <span class="text-blue-600">${s.c}</span> / Best: <span class="text-green-600">${s.l}</span></p></div>`; }); }
            sc.innerHTML = html + '</div>';
        }

        async function fetchAllYearData() {
            const h = {}, t = new Date(), cy = t.getFullYear(), [_, cw] = getWeekNumber(t);
            for (let i = 1; i <= cw; i++) { const wId = `${cy}-W${String(i).padStart(2, '0')}`, s = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/habits`, wId)); if (s.exists()) h[wId] = s.data(); }
            return h;
        }
        function calculateAllStreaks(h) {
            const res = {}; Object.values(userHabitConfig).flat().filter(x => x.type !== 'weekly-checkbox').forEach(hab => {
                let cur = 0, long = 0, run = 0, d = new Date();
                for(let i=0; i<365; i++) {
                    const [y,w] = getWeekNumber(d), wId = `${y}-W${String(w).padStart(2,'0')}`, di = d.getDay();
                    if(h[wId] && h[wId][hab.id] && (hab.type==='checkbox'?h[wId][hab.id][di]:!!h[wId][hab.id][di])) cur++; else break;
                    d.setDate(d.getDate()-1);
                }
                for(const wId of Object.keys(h).sort()) {
                    if(!h[wId]) continue;
                    for(let i=0; i<7; i++) {
                        if(h[wId][hab.id] && (hab.type==='checkbox'?h[wId][hab.id][i]:!!h[wId][hab.id][i])) run++;
                        else { if(run>long)long=run; run=0; }
                    }
                }
                if(run>long) long=run; res[hab.id] = { c: cur, l: long };
            });
            return res;
        }

        async function renderCharacterPage() {
            const cur = await calculateMonthStats(0), ghost = await calculateMonthStats(-1);
            const ctx = document.getElementById('radar-chart').getContext('2d');
            if (radarChartInstance) radarChartInstance.destroy();
            const labels = ["Vitality", "Intellect", "Spirit", "Wealth", "Social", "Discipline"];
            const cData = labels.map(l => cur.scores[l]||0), gData = labels.map(l => ghost.scores[l]||0);
            const max = Math.max(...cData, ...gData, 100);
            radarChartInstance = new Chart(ctx, { type: 'radar', data: { labels, datasets: [ { label: 'Current', data: cData, backgroundColor: 'rgba(99,102,241,0.5)', borderColor: '#6366f1', borderWidth: 2 }, { label: 'Last Month', data: gData, backgroundColor: 'rgba(156,163,175,0.2)', borderColor: 'rgba(156,163,175,0.5)', borderWidth: 1 } ] }, options: { scales: { r: { suggestedMin: 0, suggestedMax: max + 20 } } } });
            
            const total = cur.total; let rank="Novice", p=0;
            if (total<500) { p=(total/500)*100; } else if (total<1500) { rank="Apprentice"; p=((total-500)/1000)*100; } else if (total<3000) { rank="Consistent"; p=((total-1500)/1500)*100; } else { rank="Master"; p=100; }
            document.getElementById('character-rank-title').textContent = rank;
            document.getElementById('total-xp-display').textContent = total;
            document.getElementById('xp-bar').style.width = `${p}%`;
            labels.forEach(l => { const el = document.getElementById(`score-${l.toLowerCase()}`); if(el) el.textContent = cur.scores[l]||0; });
        }

        async function calculateMonthStats(off) {
            const s = { "Vitality": 0, "Intellect": 0, "Spirit": 0, "Wealth": 0, "Social": 0, "Discipline": 0 }; let t = 0;
            const d = new Date(); d.setMonth(d.getMonth() + off);
            const [sy, sw] = getWeekNumber(new Date(d.getFullYear(), d.getMonth(), 1));
            
            for (let i = 0; i < 5; i++) {
                let cw = sw + i, cy = sy; if (cw > 52) { cw -= 52; cy++; }
                const wId = `${cy}-W${String(cw).padStart(2, '0')}`;
                let wd;
                const [dy, dw] = getWeekNumber(displayedDate);
                if (wId === `${dy}-W${String(dw).padStart(2,'0')}`) wd = habitData;
                else { try { const snap = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/habits`, wId)); if (snap.exists()) wd = snap.data(); } catch(e){} }
                
                if (wd) {
                    Object.keys(wd).forEach(k => {
                        const attr = ATTRIBUTE_MAP[k];
                        if (attr) {
                            let type = 'checkbox'; for(const c in userHabitConfig) { const f = userHabitConfig[c].find(x => x.id === k); if(f) { type=f.type; break; } }
                            const vals = wd[k];
                            if(Array.isArray(vals)) vals.forEach(v => {
                                let pts = 0; if (type.includes('checkbox')) { if(v===true) pts=10; } else { if(v && v!=="") pts=10; }
                                if(pts>0) { s[attr]+=pts; t+=pts; }
                            });
                        }
                    });
                }
            }
            return { scores: s, total: t };
        }

        function renderSettings() {
            const sc = document.getElementById('settings-content'); let h = '';
            for (const c in userHabitConfig) {
                 h += `<div class="p-4 border rounded-lg"><h3 class="text-xl font-bold mb-3">${c}</h3><div class="space-y-2">`;
                 userHabitConfig[c].forEach(b => { h += `<div class="flex justify-between p-2 bg-gray-50 rounded"><span class="font-medium">${b.name}</span><div><button data-id="${b.id}" class="edit-habit-btn text-blue-600 text-sm px-2">Edit</button><button data-id="${b.id}" class="delete-habit-btn text-red-600 text-sm px-2">Delete</button></div></div>`; });
                 h += '</div></div>';
            }
            sc.innerHTML = h;
            document.getElementById('export-data-btn').onclick = exportData;
            document.querySelectorAll('.edit-habit-btn').forEach(b => b.onclick = () => openHabitModal(b.dataset.id));
            document.querySelectorAll('.delete-habit-btn').forEach(b => b.onclick = () => deleteHabit(b.dataset.id));
        }

        async function exportData() {
            const b = document.getElementById('export-data-btn'); b.textContent='...'; b.disabled=true;
            try {
                const snap = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/habits`)); const h = {}; snap.forEach(d => h[d.id] = d.data());
                const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify({config:userHabitConfig, history:h},null,2)], {type:'application/json'})); a.download='habits.json';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            } catch(e) { alert("Error"); } finally { b.textContent='Export'; b.disabled=false; }
        }

        function openHabitModal(id) {
            habitForm.reset(); document.getElementById('habit-category').innerHTML = Object.keys(userHabitConfig).map(c=>`<option value="${c}">${c}</option>`).join('');
            const typeSel = document.getElementById('habit-type'), optCont = document.getElementById('select-options-container');
            typeSel.onchange = (e) => optCont.classList.toggle('hidden', e.target.value !== 'select');
            if(id) {
                modalTitle.textContent = "Edit"; let hab, cat;
                for(const c in userHabitConfig) { const f = userHabitConfig[c].find(x => x.id === id); if(f) { hab=f; cat=c; break; } }
                document.getElementById('habit-id').value = id; document.getElementById('habit-name').value = hab.name;
                document.getElementById('habit-category').value = cat; typeSel.value = hab.type;
                if(hab.type==='select') { optCont.classList.remove('hidden'); document.getElementById('habit-options').value = (hab.options||[]).join(','); }
                else optCont.classList.add('hidden');
            } else { modalTitle.textContent="Add"; document.getElementById('habit-id').value=''; optCont.classList.add('hidden'); }
            habitModal.classList.remove('hidden');
        }
        function closeHabitModal() { habitModal.classList.add('hidden'); }
        habitForm.onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('habit-id').value, name = document.getElementById('habit-name').value, cat = document.getElementById('habit-category').value, type = document.getElementById('habit-type').value, opts = document.getElementById('habit-options').value.split(',').map(s=>s.trim()).filter(Boolean);
            if(!name) return;
            if(id) {
                let oldC; for(const c in userHabitConfig) if(userHabitConfig[c].find(h=>h.id===id)) { oldC=c; break; }
                const hIndex = userHabitConfig[oldC].findIndex(h=>h.id===id); const h = userHabitConfig[oldC][hIndex];
                h.name=name; h.type=type; h.options = type==='select'?opts:undefined;
                if(oldC !== cat) { userHabitConfig[oldC].splice(hIndex,1); userHabitConfig[cat].push(h); }
            } else { userHabitConfig[cat].push({id:'h'+Date.now(), name, type, options: type==='select'?opts:undefined}); }
            await saveUserHabitConfig(); renderSettings(); closeHabitModal();
        };
        async function deleteHabit(id) { if(!confirm("Delete?"))return; for(const c in userHabitConfig) userHabitConfig[c]=userHabitConfig[c].filter(h=>h.id!==id); await saveUserHabitConfig(); renderSettings(); }
        addHabitBtn.onclick = () => openHabitModal(); cancelHabitBtn.onclick = closeHabitModal;
        generateReportBtn.onclick = async () => { generateReportBtn.textContent='...'; await renderStreaksReport(); analyticsPrompt.classList.add('hidden'); generateReportBtn.textContent='Generate'; };

        function renderDashboard() {
            return `<div class="bg-white rounded-2xl shadow-lg p-6"><div class="flex justify-between mb-4"><h3 class="text-2xl font-bold text-gray-800">Dashboard</h3><button id="refresh-db-btn" class="px-3 py-1 bg-gray-200 rounded text-sm">Refresh</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><div class="bg-gray-50 p-4 rounded-lg flex justify-center space-x-4">${ICONS.weather}<div id="weather-c">...</div></div><div class="bg-gray-50 p-4 rounded-lg flex justify-center space-x-4">${ICONS.news}<div id="news-c" class="text-sm">...</div></div><div class="bg-gray-50 p-4 rounded-lg flex justify-center space-x-4">${ICONS.prayer}<div id="prayer-c" class="text-sm">...</div></div><div class="bg-gray-50 p-4 rounded-lg flex justify-center space-x-4">${ICONS.history}<div id="history-c" class="text-sm">...</div></div></div></div>`;
        }
        async function fetchDashboardData(force) {
            const k='dashCache', d=new Date().toISOString().split('T')[0];
            if(!force) { try{ const c=JSON.parse(localStorage.getItem(k)); if(c&&c.date===d){ fillDash(c); return; } }catch(e){} }
            const loc = await new Promise(r => navigator.geolocation ? navigator.geolocation.getCurrentPosition(p=>r({lat:p.coords.latitude,lon:p.coords.longitude}),()=>r(null)) : r(null));
            let w={error:true}, p={error:true}, n={error:true}, h={error:true};
            if(loc) {
                try { w = (await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current=temperature_2m,relative_humidity_2m,precipitation,cloud_cover,wind_speed_10m`)).json()).current; } catch(e){}
                try { p = (await (await fetch(`https://api.aladhan.com/v1/timings/${d}?latitude=${loc.lat}&longitude=${loc.lon}&method=4`)).json()).data.timings; } catch(e){}
            }
            try { n = (await (await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent("http://feeds.bbci.co.uk/news/world/rss.xml")}`)).json()).items; } catch(e){}
            try { const t=new Date(), m=String(t.getMonth()+1).padStart(2,'0'), dy=String(t.getDate()).padStart(2,'0'); h = (await (await fetch(`https://en.wikipedia.org/api/rest_v1/feed/onthisday/events/${m}/${dy}`)).json()).events; } catch(e){}
            const data = { date:d, w, p, n, h }; localStorage.setItem(k, JSON.stringify(data)); fillDash(data);
        }
        function fillDash(d) {
            const wc=document.getElementById('weather-c'), nc=document.getElementById('news-c'), pc=document.getElementById('prayer-c'), hc=document.getElementById('history-c');
            if(wc && d.w && !d.w.error) wc.innerHTML=`<div><p class="text-xl font-bold">${d.w.temperature_2m}C</p><p class="text-xs text-gray-600">Wind: ${d.w.wind_speed_10m}km/h</p></div>`;
            if(nc && Array.isArray(d.n)) nc.innerHTML=d.n.slice(0,3).map(a=>`<div class="border-b pb-1"><a href="${a.link}" target="_blank" class="font-semibold text-xs hover:text-blue-600">${a.title}</a></div>`).join('');
            if(pc && d.p && !d.p.error) pc.innerHTML=`<div class="grid grid-cols-2 gap-x-2"><span>Fajr: ${d.p.Fajr}</span><span>Maghrib: ${d.p.Maghrib}</span></div>`;
            if(hc && Array.isArray(d.h) && d.h.length>0) { const e=d.h[Math.floor(Math.random()*d.h.length)]; hc.innerHTML=`<p><span class="font-bold">${e.year}:</span> ${e.text}</p>`; }
            const refBtn = document.getElementById('refresh-db-btn'); if(refBtn) refBtn.onclick = () => fetchDashboardData(true);
        }

        function renderWeeklySection() {
            let h = `<div class="bg-white rounded-2xl shadow-lg p-6"><h3 class="text-2xl font-bold mb-4 text-gray-800">Weekly</h3><div class="space-y-3">`;
            (userHabitConfig["Weekly"]||[]).forEach(b => { if(!habitData[b.id]) habitData[b.id]=[false]; h+=`<div class="flex justify-between p-3 bg-gray-50 rounded-lg"><label>${b.name}</label><input type="checkbox" data-key="${b.id}" data-day="0" class="habit-input h-6 w-6" ${habitData[b.id][0]?'checked':''}></div>`; });
            return h + `</div></div>`;
        }
        function renderDayHabits(i) {
            let h = '<div class="bg-white rounded-2xl shadow-lg p-6"><h3 class="text-2xl font-bold mb-4">Daily</h3><div class="space-y-4">';
            Object.keys(userHabitConfig).filter(c=>c!=='Weekly').forEach(c => {
                h+=`<div><h4 class="font-semibold text-gray-600 mb-2">${c}</h4><div class="space-y-3">`;
                userHabitConfig[c].forEach(b => {
                    if(!habitData[b.id]) habitData[b.id] = b.type==='checkbox'?Array(7).fill(false):Array(7).fill("");
                    const s = habitData[b.id][i], f = (habitData.failureLog&&habitData.failureLog[b.id]&&habitData.failureLog[b.id][i])||"";
                    h+=`<div class="flex justify-between p-3 bg-gray-50 rounded-lg"><label>${b.name}</label><div class="flex space-x-2">`;
                    if(!s && b.type!=='select') h+=`<button data-key="${b.id}" data-day="${i}" class="log-failure-btn text-xs ${f?'text-yellow-600':'text-gray-500'}">${f?'View':'Log Fail'}</button>`;
                    if(b.type==='checkbox') h+=`<input type="checkbox" data-key="${b.id}" data-day="${i}" class="habit-input h-6 w-6" ${s?'checked':''}>`;
                    else h+=`<select data-key="${b.id}" data-day="${i}" class="habit-input custom-select border-gray-300 rounded text-sm py-1 w-32">${(b.options||[]).map(o=>`<option value="${o}" ${o===s?'selected':''}>${o||'-'}</option>`).join('')}</select>`;
                    h+=`</div></div>`;
                });
                h+=`</div></div>`;
            });
            return h+'</div></div>';
        }
        function renderHourlyLog() {
            const d=new Date(displayedDate); d.setDate(d.getDate()-(d.getDay()-activeDayIndex)); document.getElementById('hourly-log-date').textContent=d.toDateString();
            let h=''; if(!habitData.hourlyLog)habitData.hourlyLog={}; if(!habitData.hourlyLog[activeDayIndex])habitData.hourlyLog[activeDayIndex]=Array(24).fill({});
            const l=habitData.hourlyLog[activeDayIndex];
            for(let i=0;i<24;i++){ const e=l[i]||{}, c=e.category||'Other', a=e.activity||''; h+=`<div class="timeline-hour grid gap-2 items-center"><span class="text-sm text-gray-500 text-right">${i}:00</span><div data-hour="${i}" data-day="${activeDayIndex}" class="hourly-log-slot col-span-1 w-full p-2 border rounded cursor-pointer ${hourlyLogCategories[c]}"><p class="text-sm truncate">${a||'...'}</p></div></div>`; }
            document.getElementById('hourly-log-content').innerHTML=h;
        }
        function renderDayJournal(i) {
            const [y,w]=getWeekNumber(displayedDate), s=getDateOfWeek(w,y), jd=new Date(s); jd.setDate(jd.getDate()+i);
            const p = journalPrompts[Math.floor((jd-new Date(jd.getFullYear(),0,0))/86400000)%journalPrompts.length];
            return `<div class="bg-white rounded-2xl shadow-lg p-6"><h3 class="text-2xl font-bold mb-2">Journal</h3><p class="text-sm italic mb-3">${p}</p><textarea data-day="${i}" class="journal-entry w-full h-48 p-2 border rounded">${(habitData.journal&&habitData.journal[i])||""}</textarea></div>`;
        }
        function renderDayTodos(i) {
            return `<div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col"><h3 class="text-2xl font-bold mb-4">Todos</h3><ul id="todo-list" class="space-y-2 flex-grow min-h-[150px]">${renderSingleDayTodos(i)}</ul><div class="mt-4 flex space-x-2"><input id="todo-input" placeholder="New..." class="flex-grow border rounded px-2"><button id="add-todo-btn" class="bg-blue-500 text-white px-3 rounded">Add</button></div></div>`;
        }
        function renderSingleDayTodos(i) {
            const t=(habitData.todos&&habitData.todos[i])||[];
            return t.length===0?`<li class="text-gray-500 italic">No tasks.</li>`:t.map((o,x)=>`<li class="flex justify-between bg-gray-50 p-2 rounded"><input type="checkbox" data-index="${x}" class="todo-checkbox" ${o.completed?'checked':''}><span class="mx-2 flex-grow ${o.completed?'line-through':''}">${o.text}</span><button data-index="${x}" class="delete-todo-btn text-red-500">&times;</button></li>`).join('');
        }

        document.getElementById('prev-week-btn').onclick=()=>navigateWeeks(-1); document.getElementById('next-week-btn').onclick=()=>navigateWeeks(1);
        document.getElementById('today-btn').onclick=()=>{ if(hasUnsavedChanges&&!confirm("Discard?"))return; hasUnsavedChanges=false; saveBar.classList.add('translate-y-full'); const t=new Date(); if(getWeekNumber(displayedDate).join()!==getWeekNumber(t).join()){ displayedDate=t; setActiveDayForCurrentWeek(); updateViewForDate(); } else { activeDayIndex=t.getDay(); renderApp(); } };
    </script>
</body>
</html>
