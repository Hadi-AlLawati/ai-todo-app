<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Discipline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
        }
        
        /* Mobile-first container */
        .mobile-container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 40px rgba(0,0,0,0.1);
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 480px;
            width: 100%;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            padding: 8px 0 20px 0;
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .nav-item svg {
            width: 24px;
            height: 24px;
        }
        
        .nav-item span {
            font-size: 11px;
            font-weight: 500;
        }
        
        .nav-item.active {
            color: #ef4444;
        }
        
        .nav-item:not(.active) {
            color: #9ca3af;
        }
        
        /* Header styles */
        .app-header {
            padding: 24px 20px 16px 20px;
            background: white;
        }
        
        .app-title {
            font-size: 28px;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .app-subtitle {
            font-size: 14px;
            color: #6b7280;
        }
        
        /* Progress bar */
        .progress-section {
            padding: 16px 20px;
            background: white;
        }
        
        .progress-label {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .progress-bar {
            height: 8px;
            background: #f3f4f6;
            border-radius: 999px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #dc2626);
            border-radius: 999px;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            font-size: 12px;
            color: #ef4444;
            font-weight: 600;
            text-align: right;
            margin-top: 4px;
        }
        
        /* Habit cards */
        .habit-list {
            padding: 0 20px 100px 20px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin: 24px 0 16px 0;
        }
        
        .habit-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: white;
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .habit-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .habit-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }
        
        .habit-content {
            flex: 1;
        }
        
        .habit-name {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 2px;
        }
        
        .habit-category {
            font-size: 13px;
            color: #6b7280;
        }
        
        .habit-xp {
            font-size: 13px;
            color: #10b981;
            font-weight: 600;
        }
        
        /* Color variants */
        .bg-red { background: linear-gradient(135deg, #fee2e2, #fecaca); }
        .bg-blue { background: linear-gradient(135deg, #dbeafe, #bfdbfe); }
        .bg-purple { background: linear-gradient(135deg, #e9d5ff, #d8b4fe); }
        .bg-yellow { background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .bg-green { background: linear-gradient(135deg, #d1fae5, #a7f3d0); }
        .bg-orange { background: linear-gradient(135deg, #fed7aa, #fdba74); }
        
        /* Hourly Log styles */
        .hourly-header {
            padding: 24px 20px 16px 20px;
            background: white;
        }
        
        .date-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            margin-bottom: 16px;
        }
        
        .category-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .category-pill {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .pill-work { background: #3b82f6; color: white; }
        .pill-study { background: #8b5cf6; color: white; }
        .pill-exercise { background: #ef4444; color: white; }
        .pill-meal { background: #f59e0b; color: white; }
        .pill-social { background: #10b981; color: white; }
        .pill-rest { background: #6b7280; color: white; }
        .pill-hobby { background: #ec4899; color: white; }
        .pill-prayer { background: #a855f7; color: white; }
        
        .time-slot {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 12px;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .time-label {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
        }
        
        .activity-input {
            padding: 10px 12px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            color: #9ca3af;
        }
        
        /* Analytics styles */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }
        
        .stat-label {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }
        
        /* Character page */
        .character-header {
            padding: 24px 20px;
            background: white;
            text-align: center;
        }
        
        .character-rank {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .character-level {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 16px;
        }
        
        .trophy-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ec4899, #a855f7);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px auto;
        }
        
        .xp-bar-container {
            margin-bottom: 8px;
        }
        
        .xp-label {
            font-size: 13px;
            color: #6b7280;
        }
        
        .xp-value {
            font-size: 13px;
            font-weight: 600;
            color: #a855f7;
        }
        
        .radar-section {
            padding: 24px 20px;
        }
        
        .stats-grid-character {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 0 20px 100px 20px;
        }
        
        .stat-box {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-box-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            margin: 0 auto 8px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stat-box-label {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .stat-box-value {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }
        
        /* Settings page */
        .settings-section {
            padding: 20px;
        }
        
        .settings-group {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .settings-group-title {
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 20px 20px 12px 20px;
        }
        
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-top: 1px solid #f3f4f6;
        }
        
        .settings-item:first-child {
            border-top: none;
        }
        
        .settings-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .settings-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }
        
        .settings-label {
            font-size: 15px;
            font-weight: 500;
            color: #1f2937;
        }
        
        .settings-value {
            font-size: 14px;
            color: #9ca3af;
        }
        
        .sign-out-btn {
            background: #fee2e2;
            color: #ef4444;
            padding: 16px 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            margin: 20px;
        }
        
        .version-footer {
            text-align: center;
            padding: 20px;
            color: #9ca3af;
            font-size: 13px;
        }
        
        /* Hide elements */
        .hidden {
            display: none !important;
        }
        
        /* Loading spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal backdrop */
        .modal-backdrop {
            background: rgba(0,0,0,0.5);
        }
        
        /* Points animation */
        .points-animation {
            position: absolute;
            top: -20px;
            right: 0;
            color: #10b981;
            font-weight: 700;
            animation: fadeUp 0.8s ease;
            pointer-events: none;
        }
        
        @keyframes fadeUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        
        /* Auth container */
        #auth-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Save bar */
        #save-bar {
            max-width: 480px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        #save-bar.translate-y-full {
            transform: translateX(-50%) translateY(100%);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex justify-center items-center z-50 hidden">
        <div class="loading-spinner"></div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg m-4">
            <form id="login-form" class="space-y-6">
                <h2 class="text-3xl font-bold text-center text-gray-900">Welcome Back!</h2>
                <div>
                    <label for="login-email" class="text-sm font-medium text-gray-700">Email address</label>
                    <input id="login-email" name="email" type="email" autocomplete="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="login-password" class="text-sm font-medium text-gray-700">Password</label>
                    <input id="login-password" name="password" type="password" autocomplete="current-password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <p id="login-error" class="text-sm text-red-600"></p>
                <div>
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Sign In
                    </button>
                </div>
                <p class="text-sm text-center text-gray-600">
                    No account? <a href="#" id="show-signup-link" class="font-medium text-blue-600 hover:text-blue-500">Sign up</a>
                </p>
            </form>

            <form id="signup-form" class="hidden space-y-6">
                <h2 class="text-3xl font-bold text-center text-gray-900">Create an Account</h2>
                <div>
                    <label for="signup-email" class="text-sm font-medium text-gray-700">Email address</label>
                    <input id="signup-email" name="email" type="email" autocomplete="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="signup-password" class="text-sm font-medium text-gray-700">Password</label>
                    <input id="signup-password" name="password" type="password" autocomplete="new-password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <p id="signup-error" class="text-sm text-red-600"></p>
                <div>
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Sign Up
                    </button>
                </div>
                <p class="text-sm text-center text-gray-600">
                    Already have an account? <a href="#" id="show-login-link" class="font-medium text-blue-600 hover:text-blue-500">Log in</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <div class="mobile-container">
            <!-- Tracker View -->
            <div id="tracker-view">
                <div class="app-header">
                    <h1 class="app-title">Daily Discipline</h1>
                    <p class="app-subtitle">Track your habits, level up your life</p>
                </div>

                <div class="progress-section">
                    <div class="progress-label">Weekly Progress</div>
                    <div class="progress-bar">
                        <div id="total-progress-bar" class="progress-fill" style="width: 0%;"></div>
                    </div>
                    <p id="total-progress-text" class="progress-text">0%</p>
                </div>

                <div class="habit-list">
                    <h2 class="section-title">Today's Habits</h2>
                    <div id="app-content">
                        <!-- Habits will be rendered here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Hourly Log View -->
            <div id="log-view" class="hidden">
                <div class="hourly-header">
                    <h1 class="app-title">Hourly Log</h1>
                    <p class="app-subtitle">Track your day hour by hour</p>
                    <input type="date" id="hourly-log-date" class="date-input">
                    <div class="category-pills">
                        <div class="category-pill pill-work">Work</div>
                        <div class="category-pill pill-study">Study</div>
                        <div class="category-pill pill-exercise">Exercise</div>
                        <div class="category-pill pill-meal">Meal</div>
                        <div class="category-pill pill-social">Social</div>
                        <div class="category-pill pill-rest">Rest</div>
                        <div class="category-pill pill-hobby">Hobby</div>
                        <div class="category-pill pill-prayer">Prayer</div>
                    </div>
                </div>
                <div id="hourly-log-content">
                    <!-- Time slots will be rendered here -->
                </div>
            </div>

            <!-- Analytics View -->
            <div id="analytics-view" class="hidden">
                <div class="app-header">
                    <h1 class="app-title">Analytics</h1>
                    <p class="app-subtitle">Track your progress over time</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #fee2e2, #fecaca);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="#ef4444" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </div>
                        <div class="stat-label">Total Completions</div>
                        <div class="stat-value">0</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="#3b82f6" stroke-width="2">
                                <path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                            </svg>
                        </div>
                        <div class="stat-label">Weekly Streak</div>
                        <div class="stat-value">0</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #e9d5ff, #d8b4fe);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="#a855f7" stroke-width="2">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="stat-label">Top Habit</div>
                        <div class="stat-value" style="font-size: 16px;">None</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="#10b981" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                        </div>
                        <div class="stat-label">Completion Rate</div>
                        <div class="stat-value">0%</div>
                    </div>
                </div>
                
                <div style="padding: 20px 20px 100px 20px;">
                    <h2 class="section-title">Weekly Overview</h2>
                    <canvas id="todo-chart"></canvas>
                    
                    <div id="streaks-container" style="margin-top: 24px;">
                        <div id="analytics-prompt" class="text-center py-8">
                            <button id="generate-report-btn" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 transition-colors">
                                Generate Streaks Report
                            </button>
                        </div>
                        <div id="streaks-content" class="hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Character View -->
            <div id="character-view" class="hidden">
                <div class="character-header">
                    <div class="trophy-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="white" viewBox="0 0 24 24">
                            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                        </svg>
                    </div>
                    <h2 id="character-rank-title" class="character-rank">Adventurer</h2>
                    <p class="character-level">Level 1 â€¢ Novice</p>
                    
                    <div class="xp-bar-container">
                        <div class="progress-bar">
                            <div id="xp-bar" class="progress-fill" style="width: 0%; background: linear-gradient(90deg, #a855f7, #ec4899);"></div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                        <span class="xp-label">Experience</span>
                        <span class="xp-value"><span id="total-xp-display">0</span>/100 XP</span>
                    </div>
                </div>
                
                <div class="radar-section">
                    <h3 class="section-title" style="text-align: center;">Stat Distribution</h3>
                    <div style="max-width: 300px; margin: 0 auto;">
                        <canvas id="radar-chart"></canvas>
                    </div>
                </div>
                
                <div class="stats-grid-character">
                    <div class="stat-box">
                        <div class="stat-box-icon" style="background: linear-gradient(135deg, #fee2e2, #fecaca);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#ef4444" viewBox="0 0 24 24">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                        </div>
                        <div class="stat-box-label">Vitality</div>
                        <div class="stat-box-value"><span id="score-vitality">15</span></div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-box-icon" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#3b82f6" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </div>
                        <div class="stat-box-label">Intellect</div>
                        <div class="stat-box-value"><span id="score-intellect">12</span></div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-box-icon" style="background: linear-gradient(135deg, #e9d5ff, #d8b4fe);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#a855f7" viewBox="0 0 24 24">
                                <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                            </svg>
                        </div>
                        <div class="stat-box-label">Spirit</div>
                        <div class="stat-box-value"><span id="score-spirit">0</span></div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-box-icon" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#10b981" viewBox="0 0 24 24">
                                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                            </svg>
                        </div>
                        <div class="stat-box-label">Wealth</div>
                        <div class="stat-box-value"><span id="score-wealth">0</span></div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-box-icon" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#f59e0b" viewBox="0 0 24 24">
                                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75M9 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                            </svg>
                        </div>
                        <div class="stat-box-label">Social</div>
                        <div class="stat-box-value"><span id="score-social">0</span></div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-box-icon" style="background: linear-gradient(135deg, #f3f4f6, #e5e7eb);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#6b7280" viewBox="0 0 24 24">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="stat-box-label">Discipline</div>
                        <div class="stat-box-value"><span id="score-discipline">0</span></div>
                    </div>
                </div>
                
                <div style="padding: 0 20px 20px 20px;">
                    <div class="flex space-x-2 mt-2 bg-gray-100 p-1 rounded-lg">
                        <button class="radar-filter-btn px-3 py-1 text-xs font-semibold rounded-md transition-colors bg-blue-100 text-blue-700 shadow-sm" data-range="daily">Daily</button>
                        <button class="radar-filter-btn px-3 py-1 text-xs font-semibold rounded-md transition-colors text-gray-500 hover:bg-white hover:shadow-sm" data-range="weekly">Weekly</button>
                        <button class="radar-filter-btn px-3 py-1 text-xs font-semibold rounded-md transition-colors text-gray-500 hover:bg-white hover:shadow-sm" data-range="monthly">Monthly</button>
                        <button class="radar-filter-btn px-3 py-1 text-xs font-semibold rounded-md transition-colors text-gray-500 hover:bg-white hover:shadow-sm" data-range="yearly">Yearly</button>
                    </div>
                </div>
                
                <div style="padding: 0 20px 100px 20px;">
                    <h3 class="section-title">Stats History</h3>
                    <div class="flex space-x-2 mb-4 bg-gray-100 p-1 rounded-lg">
                        <button class="history-filter-btn px-3 py-1 text-xs font-semibold rounded-md transition-colors text-gray-500 hover:bg-white hover:shadow-sm" data-range="daily">Daily</button>
                        <button class="history-filter-btn px-3 py-1 text-xs font-semibold rounded-md transition-colors bg-white shadow-sm text-blue-600" data-range="weekly">Weekly</button>
                        <button class="history-filter-btn px-3 py-1 text-xs font-semibold rounded-md transition-colors text-gray-500 hover:bg-white hover:shadow-sm" data-range="monthly">Monthly</button>
                        <button class="history-filter-btn px-3 py-1 text-xs font-semibold rounded-md transition-colors text-gray-500 hover:bg-white hover:shadow-sm" data-range="yearly">Yearly</button>
                    </div>
                    <div style="height: 250px;">
                        <canvas id="history-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="hidden">
                <div class="app-header">
                    <h1 class="app-title">Settings</h1>
                    <p class="app-subtitle">Manage your preferences</p>
                </div>
                
                <div class="settings-section">
                    <div class="settings-group">
                        <div class="settings-group-title">PREFERENCES</div>
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div class="settings-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                                    </svg>
                                </div>
                                <span class="settings-label">Notifications</span>
                            </div>
                            <span class="settings-value">Enabled</span>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div class="settings-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                                    </svg>
                                </div>
                                <span class="settings-label">Dark Mode</span>
                            </div>
                            <span class="settings-value">Off</span>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div class="settings-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
                                    </svg>
                                </div>
                                <span class="settings-label">Language</span>
                            </div>
                            <span class="settings-value">English</span>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <div class="settings-group-title">ACCOUNT</div>
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div class="settings-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                    </svg>
                                </div>
                                <span class="settings-label">Privacy</span>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div class="settings-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <span class="settings-label">Help & Support</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="signout-btn" class="sign-out-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                            <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        Sign Out
                    </div>
                    
                    <div class="version-footer">
                        <p>Daily Discipline v1.0.0</p>
                        <p>Made with discipline and dedication</p>
                    </div>
                    
                    <div style="padding-bottom: 20px;">
                        <button id="add-habit-btn" class="w-full px-4 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 transition-colors">Add New Habit</button>
                        <button id="export-data-btn" class="w-full px-4 py-3 mt-2 bg-green-500 text-white font-semibold rounded-lg shadow-sm hover:bg-green-600 transition-colors">Export All Data</button>
                    </div>
                    
                    <div id="settings-content" class="hidden"></div>
                </div>
            </div>

            <!-- Bottom Navigation -->
            <div class="bottom-nav">
                <div id="view-tracker-btn" class="nav-item active">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span>Tracker</span>
                </div>
                
                <div id="view-log-btn" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Log</span>
                </div>
                
                <div id="view-analytics-btn" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <span>Analytics</span>
                </div>
                
                <div id="view-character-btn" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <span>Character</span>
                </div>
                
                <div id="view-settings-btn" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span>Settings</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden elements for week navigation and other features -->
    <div id="week-nav-controls" class="hidden"></div>
    <div id="current-week-display" class="hidden"></div>
    <div id="discipline-score" class="hidden">0</div>
    <div id="user-email" class="hidden"></div>
    <div id="day-nav-container" class="hidden"></div>

    <!-- Modals -->
    <div id="habit-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Add Habit</h3>
            <form id="habit-form">
                <input type="hidden" id="habit-id">
                <div class="mb-4">
                    <label for="habit-name" class="block text-sm font-medium text-gray-700">Habit Name</label>
                    <input type="text" id="habit-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="habit-category" class="block text-sm font-medium text-gray-700">Category</label>
                    <select id="habit-category" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500">
                    </select>
                </div>
                <div class="mb-4">
                    <label for="habit-type" class="block text-sm font-medium text-gray-700">Type</label>
                    <select id="habit-type" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500">
                        <option value="checkbox">Checkbox (Daily)</option>
                        <option value="weekly-checkbox">Checkbox (Weekly)</option>
                        <option value="select">Dropdown (Daily)</option>
                    </select>
                </div>
                <div id="select-options-container" class="mb-4 hidden">
                    <label for="habit-options" class="block text-sm font-medium text-gray-700">Dropdown Options (comma separated)</label>
                    <input type="text" id="habit-options" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-habit-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Habit</button>
                </div>
            </form>
        </div>
    </div>

    <div id="failure-log-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <h3 id="failure-modal-title" class="text-xl font-bold mb-4">Log Failure</h3>
            <form id="failure-log-form">
                <input type="hidden" id="failure-habit-id">
                <input type="hidden" id="failure-day-index">
                <div class="mb-4">
                    <label for="failure-reason" class="block text-sm font-medium text-gray-700">Reason for missing this habit:</label>
                    <textarea id="failure-reason" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500" rows="4"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-failure-log-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Reason</button>
                </div>
            </form>
        </div>
    </div>

    <div id="hourly-log-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <h3 id="hourly-log-modal-title" class="text-xl font-bold mb-4">Log for 00:00</h3>
            <form id="hourly-log-form">
                <input type="hidden" id="hourly-log-hour">
                <input type="hidden" id="hourly-log-day">
                <div class="mb-4">
                    <label for="hourly-log-activity" class="block text-sm font-medium text-gray-700">Activity:</label>
                    <textarea id="hourly-log-activity" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500" rows="3"></textarea>
                </div>
                <div class="mb-4">
                    <label for="hourly-log-category" class="block text-sm font-medium text-gray-700">Category:</label>
                    <select id="hourly-log-category" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500"></select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-hourly-log-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="save-bar" class="fixed bottom-0 left-0 w-full bg-white border-t-2 border-blue-100 p-4 shadow-lg translate-y-full transition-transform duration-300 flex justify-between items-center z-50">
        <div class="flex items-center space-x-2">
            <span class="flex h-3 w-3 relative">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span>
            </span>
            <span class="text-gray-700 font-semibold">You have unsaved changes</span>
        </div>
        <div class="flex space-x-3">
            <button id="discard-changes-btn" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors font-medium">Discard</button>
            <button id="global-save-btn" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md transition-colors flex items-center space-x-2">
                <span>Save Changes</span>
            </button>
        </div>
    </div>

    <!-- Keep all your existing JavaScript here -->
    <script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- OPTIMIZATION: Extract SVGs ---
        const ICONS = {
            weather: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 9.168A6 6 0 0110 6a6 6 0 015.668 3.168A2 2 0 0114 13H6a2 2 0 01-1.668-3.832z" clip-rule="evenodd" /></svg>`,
            news: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h14a1 1 0 011 1v14a1 1 0 01-1 1H3a1 1 0 01-1-1V3z" /><path d="M5 7h10v2H5V7zm0 4h10v2H5v-2zm0 4h5v2H5v-2z" /></svg>`,
            prayer: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a.75.75 0 01.75.75v.512c3.54.341 6.25 3.28 6.25 6.738v3.25a.75.75 0 01-1.5 0v-3.25c0-2.89-2.298-5.25-5-5.25v-1.5a.75.75 0 01-.75-.75zM10 4a6 6 0 00-6 6v3.25a.75.75 0 01-1.5 0V10c0-3.458 2.71-6.397 6.25-6.738V2.75A.75.75 0 0110 2zM3 12a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>`,
            history: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>`
        };

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "FIREBASE_API_KEY_PLACEHOLDER",
            authDomain: "FIREBASE_AUTH_DOMAIN_PLACEHOLDER",
            projectId: "FIREBASE_PROJECT_ID_PLACEHOLDER",
            storageBucket: "FIREBASE_STORAGE_BUCKET_PLACEHOLDER",
            messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID_PLACEHOLDER",
            appId: "FIREBASE_APP_ID_PLACEHOLDER"
        };
        const appId = 'habit-tracker-live';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let habitData = {};
        let userHabitConfig = {};
        let userConfig = {};
        let unsubscribe = null;
        let displayedDate = new Date();
        let activeDayIndex = 0;
        let currentView = 'tracker'; 
        let todoChartInstance = null;
        let radarChartInstance = null; // New chart instance
        let hasUnsavedChanges = false; 
        let globalListenersAttached = false;
        let historyChartInstance = null; // Add this line

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const mainAppContainer = document.getElementById('app-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const userEmailDisplay = document.getElementById('user-email');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupLink = document.getElementById('show-signup-link');
        const showLoginLink = document.getElementById('show-login-link');
        const signoutBtn = document.getElementById('signout-btn');
        const dayNavContainer = document.getElementById('day-nav-container');
        const appContent = document.getElementById('app-content');
        const disciplineScoreDisplay = document.getElementById('discipline-score');

        // Save Bar Elements 
        const saveBar = document.getElementById('save-bar');
        const globalSaveBtn = document.getElementById('global-save-btn');
        const discardBtn = document.getElementById('discard-changes-btn');

        // View Containers and Buttons
        const views = {
            tracker: document.getElementById('tracker-view'),
            log: document.getElementById('log-view'),
            analytics: document.getElementById('analytics-view'),
            character: document.getElementById('character-view'), // ADDED
            settings: document.getElementById('settings-view')
        };
        const viewButtons = {
            tracker: document.getElementById('view-tracker-btn'),
            log: document.getElementById('view-log-btn'),
            analytics: document.getElementById('view-analytics-btn'),
            character: document.getElementById('view-character-btn'), // ADDED
            settings: document.getElementById('view-settings-btn')
        };
        const weekNavControls = document.getElementById('week-nav-controls');
        const analyticsPrompt = document.getElementById('analytics-prompt');
        const generateReportBtn = document.getElementById('generate-report-btn');
        
        // Modals
        const habitModal = document.getElementById('habit-modal');
        const habitForm = document.getElementById('habit-form');
        const modalTitle = document.getElementById('modal-title');
        const addHabitBtn = document.getElementById('add-habit-btn');
        const cancelHabitBtn = document.getElementById('cancel-habit-btn');
        const failureLogModal = document.getElementById('failure-log-modal');
        const failureLogForm = document.getElementById('failure-log-form');
        const cancelFailureLogBtn = document.getElementById('cancel-failure-log-btn');
        const hourlyLogModal = document.getElementById('hourly-log-modal');
        const hourlyLogForm = document.getElementById('hourly-log-form');
        const cancelHourlyLogBtn = document.getElementById('cancel-hourly-log-btn');
        

        // --- Default Definitions ---
        const defaultHabits = {
            "Health": [
                { id: "h1", name: "Body", type: "checkbox" }, { id: "h2", name: "Face", type: "checkbox" }, { id: "h3", name: "Ears", type: "checkbox" }, { id: "h4", name: "Teeth", type: "checkbox" }, { id: "h5", name: "Smell", type: "checkbox" }, { id: "h6", name: "Calories (>3000)", type: "checkbox" }, { id: "h7", name: "Stretch", type: "checkbox" }, { id: "h8", name: "Sleep (7-8 hours)", type: "checkbox" }, { id: "h9", name: "Hydration", type: "checkbox" }, { id: "h10", name: "Physical Activity", type: "select", options: ["", "Muscle", "Padel", "Running", "Tennis"] },
            ],
            "Mind": [
                { id: "m1", name: "Investments Learning", type: "select", options: ["", "Crypto", "Stock", "News"] }, { id: "m2", name: "CFA Learning", type: "checkbox" }, { id: "m3", name: "Padel Learning", type: "checkbox" }, { id: "m4", name: "Tennis Learning", type: "checkbox" }, { id: "m5", name: "Discipline", type: "checkbox" }, { id: "m6", name: "Talk to one person", type: "checkbox" }, { id: "m7", name: "Family time (30min)", type: "checkbox" }, { id: "m8", name: "Daily Planning/Review", type: "checkbox" }, { id: "m9", name: "Tidying Up", type: "checkbox" },
            ],
            "Spirit": [
                { id: "s1", name: "Affirmations", type: "checkbox" }, { id: "s2", name: "Prayer", type: "checkbox" }, { id: "s3", name: "Quran", type: "checkbox" }, { id: "s4", name: "Dua", type: "checkbox" },
            ],
            "Budget": [ { id: "b1", name: "Spend < 6.67 OMR", type: "checkbox" }, ],
            "Weekly": [ { id: "w1", name: "Family Outing", type: "weekly-checkbox" }, { id: "w2", name: "Extended Family Gathering", type: "weekly-checkbox" }, { id: "w3", name: "Charity", type: "weekly-checkbox" } ]
        };

        // --- GAMIFICATION CONFIG ---
        // --- GAMIFICATION CONFIG ---

// HELPER: Determines Stat (Vitality, Intellect, etc.) based on Habit Category
function getAttributeForHabit(habitId) {
    let foundCategory = null;
    let habitName = "";
    
    // 1. Find category from config
    for (const cat in userHabitConfig) {
        const found = userHabitConfig[cat].find(h => h.id === habitId);
        if (found) {
            foundCategory = cat;
            habitName = found.name;
            break;
        }
    }

    // 2. Return Stat based on Category
    if (foundCategory === 'Health') return 'Vitality';
    if (foundCategory === 'Spirit') return 'Spirit';
    if (foundCategory === 'Budget') return 'Wealth';
    if (foundCategory === 'Weekly') return 'Social';
    
    if (foundCategory === 'Mind') {
        if (habitName.includes('Discipline') || habitName.includes('Plan')) return 'Discipline';
        if (habitName.includes('Family') || habitName.includes('Talk')) return 'Social';
        return 'Intellect';
    }

    return 'Vitality'; // Fallback
}

        const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const journalPrompts = [
            "What was one win from today, big or small?", "What is something you're grateful for right now?", "What is one thing you can do to make tomorrow even better?", "Describe a moment today that made you smile.", "What challenge did you face today and how did you handle it?", "What are you most looking forward to this week?", "Write about something you learned today.", "If you could describe today in three words, what would they be?", "What's one thing that's been on your mind lately?"
        ];
        const hourlyLogCategories = {
            "Work": "bg-blue-200",
            "Leisure": "bg-green-200",
            "Exercise": "bg-yellow-200",
            "Learning": "bg-purple-200",
            "Family/Social": "bg-pink-200",
            "Chores": "bg-gray-200",
            "Sleep": "bg-indigo-200",
            "Other": "bg-white",
        };


        // --- Auth State Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                authContainer.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');
                loadingOverlay.classList.remove('hidden');
                userId = user.uid;
                userEmailDisplay.textContent = `Signed in as: ${user.email}`;
                
                await loadUserConfig();

                setActiveDayForCurrentWeek();
                updateViewForDate();
                setupViewNavigation();
                
                // Add save button listeners
                setupSaveHandlers();
                
                // OPTIMIZATION: Attach listeners once
                if (!globalListenersAttached) {
                    setupGlobalListeners();
                    globalListenersAttached = true;
                }

            } else {
                authContainer.classList.remove('hidden');
                mainAppContainer.classList.add('hidden');
                if (unsubscribe) unsubscribe();
                userId = null;
                userEmailDisplay.textContent = '';
                habitData = {};
                loadingOverlay.classList.add('hidden');
            }
        });

        // --- OPTIMIZATION: Delegated Event Listeners ---
        function setupGlobalListeners() {
            // Handle App Content clicks (Todos, Failure Log)
            appContent.addEventListener('click', (e) => {
                // Log Failure Button
                if (e.target.classList.contains('log-failure-btn')) {
                    openFailureLogModal(e.target.dataset.key, e.target.dataset.day);
                }
                // Add Todo Button
                else if (e.target.id === 'add-todo-btn') {
                    handleAddTodo();
                }
                // Delete Todo Button
                else if (e.target.classList.contains('delete-todo-btn')) {
                    handleDeleteTodo(e.target.dataset.index);
                }
            });

            // Handle Changes (Habit Checkboxes/Selects, Todo Checkboxes)
            appContent.addEventListener('change', (e) => {
                // Habit Inputs
                if (e.target.classList.contains('habit-input')) {
                    handleHabitChange(e.target);
                }
                // Todo Checkbox
                else if (e.target.classList.contains('todo-checkbox')) {
                    handleTodoToggle(e.target.dataset.index, e.target.checked);
                }
            });

            // Handle Input (Journal)
            appContent.addEventListener('input', (e) => {
                if (e.target.classList.contains('journal-entry')) {
                    const day = parseInt(e.target.dataset.day);
                    if (!habitData.journal) habitData.journal = Array(7).fill("");
                    habitData.journal[day] = e.target.value;
                    markUnsaved();
                }
            });

            // Handle Log View Clicks
            views.log.addEventListener('click', (e) => {
                 const slot = e.target.closest('.hourly-log-slot');
                 if (slot) {
                    const { hour, day } = slot.dataset;
                    openHourlyLogModal(hour, day);
                 }
            });
        }

        // --- Handlers for Delegated Events ---
        function handleHabitChange(target) {
            const { key, day } = target.dataset;
            const dayIndex = parseInt(day);
            const previousState = habitData[key] ? habitData[key][dayIndex] : undefined;
            if (!habitData[key]) {
                habitData[key] = target.type === 'checkbox' ? Array(7).fill(false) : Array(7).fill("");
            }

            if (target.type === 'checkbox') {
                habitData[key][dayIndex] = target.checked;
                if (target.checked && !previousState) {
                    incrementScore(10);
                    showPointsAnimation(target, 10);
                } else if (!target.checked && previousState) {
                    incrementScore(-10);
                }
            } else {
                const hadValue = !!previousState && previousState !== "";
                const hasValue = !!target.value && target.value !== "";
                habitData[key][dayIndex] = target.value;
                 if (hasValue && !hadValue) {
                    incrementScore(10);
                    showPointsAnimation(target, 10);
                 } else if (!hasValue && hadValue) {
                    incrementScore(-10);
                 }
            }
            renderDayHabits(activeDayIndex);
            updateProgress();
            markUnsaved();
        }

        function handleAddTodo() {
            const input = appContent.querySelector('#todo-input');
            if (input && input.value.trim()) {
                if (!habitData.todos) habitData.todos = { 0:[], 1:[], 2:[], 3:[], 4:[], 5:[], 6:[] };
                if (!habitData.todos[activeDayIndex]) habitData.todos[activeDayIndex] = [];
                habitData.todos[activeDayIndex].push({ text: input.value.trim(), completed: false });
                input.value = '';
                appContent.querySelector('#todo-list').innerHTML = renderSingleDayTodos(activeDayIndex);
                markUnsaved();
            }
        }

        function handleDeleteTodo(index) {
            index = parseInt(index);
            const wasCompleted = habitData.todos[activeDayIndex][index].completed;
            if(wasCompleted) incrementScore(-5);
            habitData.todos[activeDayIndex].splice(index, 1);
            appContent.querySelector('#todo-list').innerHTML = renderSingleDayTodos(activeDayIndex);
            markUnsaved();
        }

        function handleTodoToggle(index, isChecked) {
            index = parseInt(index);
            const wasCompleted = habitData.todos[activeDayIndex][index].completed;
            habitData.todos[activeDayIndex][index].completed = isChecked;
            if(isChecked && !wasCompleted) incrementScore(5);
            if(!isChecked && wasCompleted) incrementScore(-5);
            appContent.querySelector('#todo-list').innerHTML = renderSingleDayTodos(activeDayIndex);
            markUnsaved();
        }


        // --- SAVE HANDLERS (UPDATED) ---
        function setupSaveHandlers() {
            globalSaveBtn.addEventListener('click', async () => {
                const btnContent = globalSaveBtn.innerHTML;
                globalSaveBtn.innerHTML = `<span>Saving...</span>`;
                globalSaveBtn.disabled = true;
                
                await updateFirestore(); // Saves Habits AND Score
                
                hasUnsavedChanges = false;
                
                // UI Feedback
                globalSaveBtn.innerHTML = `<span>Saved!</span>`;
                setTimeout(() => {
                    saveBar.classList.add('translate-y-full'); // Hide bar
                    globalSaveBtn.innerHTML = `<span>Save Changes</span>`;
                    globalSaveBtn.disabled = false;
                }, 1000);
            });

            discardBtn.addEventListener('click', async () => {
                if(confirm("Discard all unsaved changes? This will revert to the last saved state.")) {
                    hasUnsavedChanges = false;
                    saveBar.classList.add('translate-y-full');
                    
                    // 1. Revert Habits
                    const [year, week] = getWeekNumber(displayedDate);
                    const weekId = `${year}-W${String(week).padStart(2, '0')}`;
                    setupTracker(weekId);

                    // 2. Revert Score (Fetch old score from DB)
                    await loadUserConfig();
                }
            });

            // Prevent closing window if unsaved
            window.addEventListener('beforeunload', (e) => {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        }

        function markUnsaved() {
            if (!hasUnsavedChanges) {
                hasUnsavedChanges = true;
                saveBar.classList.remove('translate-y-full'); // Show bar
            }
        }
        
        // --- User Configuration (Habits & Score) ---
        async function loadUserConfig() {
            const habitConfigRef = doc(db, `artifacts/${appId}/users/${userId}/config`, 'habits');
            const habitDocSnap = await getDoc(habitConfigRef);
            if (habitDocSnap.exists()) {
                userHabitConfig = habitDocSnap.data();
            } else {
                userHabitConfig = JSON.parse(JSON.stringify(defaultHabits)); // Deep copy
                await setDoc(habitConfigRef, userHabitConfig);
            }

            const userConfigRef = doc(db, `artifacts/${appId}/users/${userId}/config`, 'user');
            const userDocSnap = await getDoc(userConfigRef);
            if(userDocSnap.exists()) {
                userConfig = userDocSnap.data();
            } else {
                userConfig = { disciplineScore: 0 };
                await setDoc(userConfigRef, userConfig);
            }
            disciplineScoreDisplay.textContent = userConfig.disciplineScore || 0;
        }

        async function saveUserHabitConfig() {
            if (!userId) return;
            const configRef = doc(db, `artifacts/${appId}/users/${userId}/config`, 'habits');
            await setDoc(configRef, userHabitConfig);
        }
        
        function incrementScore(points) {
            userConfig.disciplineScore = (userConfig.disciplineScore || 0) + points;
            disciplineScoreDisplay.textContent = userConfig.disciplineScore;
        }

        function showPointsAnimation(element, points) {
            const pointsEl = document.createElement('span');
            pointsEl.textContent = `+${points}`;
            pointsEl.className = 'points-animation';
            element.parentElement.style.position = 'relative';
            element.parentElement.appendChild(pointsEl);
            setTimeout(() => {
                pointsEl.remove();
            }, 800);
        }


        // --- Auth Event Handlers ---
        showSignupLink.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value, password = loginForm['login-password'].value;
            const errorP = document.getElementById('login-error'); errorP.textContent = '';
            try { await signInWithEmailAndPassword(auth, email, password); } 
            catch (error) { console.error("Login Error:", error.message); errorP.textContent = "Invalid email or password."; }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = signupForm['signup-email'].value, password = signupForm['signup-password'].value;
            const errorP = document.getElementById('signup-error'); errorP.textContent = '';
            try { await createUserWithEmailAndPassword(auth, email, password); } 
            catch (error) {
                 console.error("Signup Error:", error.message);
                 errorP.textContent = error.code === 'auth/email-already-in-use' ? 'This email is already registered.' : 'Could not create account. Please try again.';
            }
        });

        signoutBtn.addEventListener('click', async () => { try { await signOut(auth); } catch (error) { console.error("Signout Error:", error); } });


        // --- Date & Week Logic ---
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - d.getUTCDay());
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return [d.getUTCFullYear(), weekNo];
        }
        
        function getDateOfWeek(w, y) {
            const simple = new Date(y, 0, 1 + (w - 1) * 7);
            const dow = simple.getDay();
            simple.setDate(simple.getDate() - dow);
            return simple;
        }

        function setActiveDayForCurrentWeek() {
             const today = new Date();
             const [currentYear, currentWeek] = getWeekNumber(today);
             const [displayYear, displayWeek] = getWeekNumber(displayedDate);
             if (currentYear === displayYear && currentWeek === displayWeek) {
                 activeDayIndex = today.getDay(); // Sunday is 0
             } else {
                 activeDayIndex = 0; 
             }
        }

        function updateViewForDate() {
            if (!userId) return;
            const [year, week] = getWeekNumber(displayedDate);
            const weekId = `${year}-W${String(week).padStart(2, '0')}`;
            document.getElementById('current-week-display').textContent = `Week ${week}, ${year}`;

            const nextWeekBtn = document.getElementById('next-week-btn');
            const today = new Date();
            const [currentYear, currentWeek] = getWeekNumber(today);
            nextWeekBtn.disabled = year > currentYear || (year === currentYear && week >= currentWeek);
            nextWeekBtn.classList.toggle('opacity-50', nextWeekBtn.disabled);
            nextWeekBtn.classList.toggle('cursor-not-allowed', nextWeekBtn.disabled);
            
            setupTracker(weekId);
        }

        function navigateWeeks(offset) { 
            if(hasUnsavedChanges) {
                if(!confirm("You have unsaved changes. Discard them and switch weeks?")) return;
                hasUnsavedChanges = false;
                saveBar.classList.add('translate-y-full');
            }
            displayedDate.setDate(displayedDate.getDate() + (offset * 7)); 
            setActiveDayForCurrentWeek();
            updateViewForDate(); 
        }
        
        // --- Firestore ---
        async function setupTracker(weekId) {
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/habits`, weekId);
            if (unsubscribe) unsubscribe(); 
            // NOTE: This snapshot listener will only fire on external changes or first load
            // since we are manually handling local updates now.
            unsubscribe = onSnapshot(docRef, (docSnap) => {
                if(!hasUnsavedChanges) { // Only update UI from DB if we don't have local unsaved changes
                    habitData = docSnap.exists() ? docSnap.data() : initializeEmptyHabitData();
                    if (!docSnap.exists()) { setDoc(docRef, habitData); }
                    renderApp();
                    loadingOverlay.classList.add('hidden');
                }
            }, (error) => {
                console.error("Error fetching document:", error);
                loadingOverlay.innerHTML = `<p class="text-red-500">Error loading data. Check console.</p>`;
            });
        }
        
        function initializeEmptyHabitData() {
            const data = {};
            for (const category in userHabitConfig) {
                userHabitConfig[category].forEach(habit => {
                    const key = habit.id;
                    if (habit.type === 'weekly-checkbox') {
                         data[key] = [false];
                    } else if (habit.type === 'checkbox') {
                        data[key] = Array(7).fill(false);
                    } else {
                         data[key] = Array(7).fill("");
                    }
                });
            }
            data.journal = Array(7).fill("");
            data.todos = { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] };
            data.failureLog = {};
            data.hourlyLog = { 0: Array(24).fill({}), 1: Array(24).fill({}), 2: Array(24).fill({}), 3: Array(24).fill({}), 4: Array(24).fill({}), 5: Array(24).fill({}), 6: Array(24).fill({}) };
            return data;
        }

        async function updateFirestore() {
             if (!userId) return;
             const [year, week] = getWeekNumber(displayedDate);
             const weekId = `${year}-W${String(week).padStart(2, '0')}`;
             
             // 1. Save Habits
             const docRef = doc(db, `artifacts/${appId}/users/${userId}/habits`, weekId);
             
             // 2. Save Score
             const userConfigRef = doc(db, `artifacts/${appId}/users/${userId}/config`, 'user');

             try { 
                 await setDoc(docRef, habitData, { merge: true }); 
                 await setDoc(userConfigRef, userConfig, { merge: true });
             } 
             catch (error) { console.error("Error updating Firestore: ", error); alert("Failed to save."); }
        }

        // --- View Navigation ---
        function setupViewNavigation() {
            Object.keys(viewButtons).forEach(view => {
                viewButtons[view].addEventListener('click', () => switchView(view));
            });
            switchView('tracker'); // Set initial view
        }

        function switchView(view) {
            if(hasUnsavedChanges && view !== currentView) {
                if(!confirm("You have unsaved changes. Leave this view?")) return;
            }
            currentView = view;
            Object.keys(views).forEach(v => {
                const is_active = v === view;
                views[v].classList.toggle('hidden', !is_active);
                viewButtons[v].classList.toggle('active', is_active);
            });
            weekNavControls.classList.toggle('hidden', view !== 'tracker' && view !== 'log');

            if (view === 'log') renderHourlyLog();
            if (view === 'analytics') {
                analyticsPrompt.classList.remove('hidden');
                document.getElementById('streaks-content').classList.add('hidden');
                 renderWeeklyTodoChart();
            }
            // NEW: Render Character Page
            if (view === 'character') {
                renderCharacterPage();
            }
            if (view === 'settings') renderSettings();
        }

        // --- Main Render Function ---
        function renderApp() {
            if (currentView === 'tracker') {
                renderDayNavigation();
                renderContentForDay();
            } else if (currentView === 'log') {
                renderDayNavigation();
                renderHourlyLog();
            }
            updateProgress();
        }
        
        function renderDayNavigation() {
            dayNavContainer.innerHTML = '';
            days.forEach((day, index) => {
                const btn = document.createElement('button');
                btn.textContent = day;
                btn.className = `day-btn p-3 border-b-4 ${index === activeDayIndex ? 'active' : 'border-transparent text-gray-500 hover:border-gray-300'}`;
                btn.addEventListener('click', () => {
                    activeDayIndex = index;
                    renderApp();
                });
                dayNavContainer.appendChild(btn);
            });
        }

        function renderContentForDay() {
            const today = new Date();
            const isCurrentDay = activeDayIndex === today.getDay() &&
                                getWeekNumber(displayedDate).join('-') === getWeekNumber(today).join('-');

            let html = `
                <div class="card">${isCurrentDay ? renderDashboard() : ''}</div>
                <div class="card" style="animation-delay: 100ms;">${renderWeeklySection()}</div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card" style="animation-delay: 200ms;">${renderDayJournal(activeDayIndex)}</div>
                    <div class="card" style="animation-delay: 250ms;">${renderDayTodos(activeDayIndex)}</div>
                </div>
                <div class="card" style="animation-delay: 300ms;">${renderDayHabits(activeDayIndex)}</div>
            `;
            appContent.innerHTML = html;
             if (isCurrentDay) {
                try {
                    fetchDashboardData();
                } catch (error) {
                    console.error("Dashboard failed to load:", error);
                }
            }
        }
        
        // --- Analytics Rendering ---
        
        function renderWeeklyTodoChart() {
             const weeklyTodoHistory = calculateWeeklyTodoStats(habitData);
            const ctx = document.getElementById('todo-chart').getContext('2d');
            if(todoChartInstance) {
                todoChartInstance.destroy();
            }
            todoChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weeklyTodoHistory.labels,
                    datasets: [
                        {
                            label: 'Completed Todos',
                            data: weeklyTodoHistory.completedData,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        },
                        {
                            label: 'Total Todos',
                            data: weeklyTodoHistory.totalData,
                            backgroundColor: 'rgba(209, 213, 219, 0.5)',
                        }
                    ]
                },
                options: {
                    scales: {
                        x: { stacked: false },
                        y: { 
                            beginAtZero: true,
                            stacked: false,
                             ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        async function renderStreaksReport() {
            const streaksContent = document.getElementById('streaks-content');
            streaksContent.innerHTML = 'Calculating...';
            streaksContent.classList.remove('hidden');

            const habitHistory = await fetchAllYearData();
            if(Object.keys(habitHistory).length === 0) {
                 streaksContent.innerHTML = '<p>Not enough data to calculate streaks. Keep tracking your habits!</p>';
                 return;
            }

            // Streaks
            const streaks = calculateAllStreaks(habitHistory);
            let streaksHtml = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
            for(const category in userHabitConfig) {
                userHabitConfig[category].forEach(habit => {
                    const habitStreaks = streaks[habit.id] || { current: 0, longest: 0};
                    streaksHtml += `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-bold text-gray-800">${habit.name}</p>
                            <p class="text-sm text-gray-600">Current Streak: <span class="font-semibold text-blue-600">${habitStreaks.current} days</span></p>
                            <p class="text-sm text-gray-600">Longest Streak: <span class="font-semibold text-green-600">${habitStreaks.longest} days</span></p>
                        </div>
                    `;
                });
            }
            streaksHtml += '</div>';
            streaksContent.innerHTML = streaksHtml;
        }

        async function fetchAllYearData() {
            const history = {};
            const today = new Date();
            const currentYear = today.getFullYear();
            const [_, currentWeek] = getWeekNumber(today);

            for (let i = 1; i <= currentWeek; i++) {
                const weekId = `${currentYear}-W${String(i).padStart(2, '0')}`;
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/habits`, weekId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    history[weekId] = docSnap.data();
                }
            }
            return history;
        }
        
        function calculateWeeklyTodoStats(currentWeekData) {
            const labels = days;
            const totalData = [];
            const completedData = [];

            for (let i = 0; i < 7; i++) {
                const dayTodos = (currentWeekData.todos && currentWeekData.todos[i]) || [];
                totalData.push(dayTodos.length);
                completedData.push(dayTodos.filter(t => t.completed).length);
            }
            return { labels, totalData, completedData };
        }
        
        function calculateAllStreaks(history) {
            const allHabits = Object.values(userHabitConfig).flat();
            const results = {};
            
            allHabits.filter(h => h.type !== 'weekly-checkbox').forEach(habit => {
                let currentStreak = 0;
                let longestStreak = 0;
                
                // Calculate current streak
                let dayToCheck = new Date();
                for(let i = 0; i < 365; i++) { 
                    const [year, week] = getWeekNumber(dayToCheck);
                    const weekId = `${year}-W${String(week).padStart(2, '0')}`;
                    const dayIndex = dayToCheck.getDay();
                    
                    const weekData = history[weekId];
                    let isDone = false;
                    if(weekData && weekData[habit.id]) {
                        isDone = habit.type === 'checkbox' ? weekData[habit.id][dayIndex] : !!weekData[habit.id][dayIndex];
                    }

                    if (isDone) {
                        currentStreak++;
                    } else {
                        break; // Current streak ends
                    }
                    dayToCheck.setDate(dayToCheck.getDate() - 1);
                }

                // Calculate longest streak
                let runningLongest = 0;
                for(const weekId of Object.keys(history).sort()) {
                    const weekData = history[weekId];
                    if(!weekData) continue;
                    for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                         let isDone = false;
                         if(weekData[habit.id]) {
                           isDone = habit.type === 'checkbox' ? weekData[habit.id][dayIndex] : !!weekData[habit.id][dayIndex];
                         }
                         if (isDone) {
                             runningLongest++;
                         } else {
                             if(runningLongest > longestStreak) longestStreak = runningLongest;
                             runningLongest = 0;
                         }
                    }
                }
                if(runningLongest > longestStreak) longestStreak = runningLongest;

                results[habit.id] = { current: currentStreak, longest: longestStreak };
            });

            return results;
        }

        // --- CHARACTER / GAMIFICATION LOGIC ---

       async function renderCharacterPage() {
            // Setup Listeners for the Radar Filter Buttons
            document.querySelectorAll('.radar-filter-btn').forEach(btn => {
                const newBtn = btn.cloneNode(true); // Clean listeners
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', (e) => {
                    // UI Update
                    document.querySelectorAll('.radar-filter-btn').forEach(b => {
                        b.classList.remove('bg-blue-100', 'text-blue-700', 'shadow-sm');
                        b.classList.add('text-gray-500', 'hover:bg-gray-100');
                    });
                    e.target.classList.remove('text-gray-500', 'hover:bg-gray-100');
                    e.target.classList.add('bg-blue-100', 'text-blue-700', 'shadow-sm');

                    // Render
                    updateRadarChart(e.target.dataset.range);
                });
            });

            // Initial Render (Default to Weekly for better initial visual)
            document.querySelector('.radar-filter-btn[data-range="weekly"]').click();

            // Render History Line Chart (From previous request)
            if (typeof setupHistoryChartListeners === 'function') {
                setupHistoryChartListeners();
                renderHistoryChart('weekly');
            }
        }

        async function updateRadarChart(range) {
            const ctx = document.getElementById('radar-chart').getContext('2d');
            
            // Show loading or just wait
            if (radarChartInstance) {
                radarChartInstance.destroy();
            }

            // 1. Fetch Data
            // We use fetchAllYearData to ensure we have history for comparisons
            const history = await fetchAllYearData(); 
            
            // 2. Calculate Stats based on range
            const currentStats = await calculatePeriodStats(history, range, 0);  // 0 = Current
            const previousStats = await calculatePeriodStats(history, range, -1); // -1 = Previous

            const labels = ["Vitality", "Intellect", "Spirit", "Wealth", "Social", "Discipline"];
            const currentData = labels.map(l => currentStats.scores[l] || 0);
            const previousData = labels.map(l => previousStats.scores[l] || 0);

            // Dynamic Scale
            const maxScore = Math.max(...currentData, ...previousData, 10); 

            // Label generation
            let currentLabel = "Current";
            let previousLabel = "Previous";
            if (range === 'daily') { currentLabel = "Today"; previousLabel = "Yesterday"; }
            if (range === 'weekly') { currentLabel = "This Week"; previousLabel = "Last Week"; }
            if (range === 'monthly') { currentLabel = "This Month"; previousLabel = "Last Month"; }
            if (range === 'yearly') { currentLabel = "This Year"; previousLabel = "Last Year"; }

            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: currentLabel,
                            data: currentData,
                            backgroundColor: 'rgba(99, 102, 241, 0.5)', // Indigo
                            borderColor: 'rgba(99, 102, 241, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(99, 102, 241, 1)'
                        },
                        {
                            label: previousLabel,
                            data: previousData,
                            backgroundColor: 'rgba(156, 163, 175, 0.2)', // Gray
                            borderColor: 'rgba(156, 163, 175, 0.5)',
                            borderWidth: 1,
                            pointBackgroundColor: 'transparent',
                            pointBorderColor: 'transparent'
                        }
                    ]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(0,0,0,0.1)' },
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            pointLabels: { font: { size: 12, weight: 'bold' }, color: '#374151' },
                            suggestedMin: 0,
                            suggestedMax: maxScore + (maxScore * 0.2) // +20% breathing room
                        }
                    },
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // Update Text Stats below chart (Use current period data)
            labels.forEach(l => {
                const el = document.getElementById(`score-${l.toLowerCase()}`);
                if(el) el.textContent = currentStats.scores[l] || 0;
            });

            // Update Total XP (Always cumulative based on Monthly or Yearly, or just sum of current view)
            // For gamification, usually Total XP is "All Time" or "This Month". 
            // Here we update it to reflect the *viewed* period sum.
            const totalXP = currentStats.total;
            document.getElementById('total-xp-display').textContent = totalXP;
            
            // Recalculate Rank based on monthly equivalent or total
            // (Keeping simple logic: assume rank is based on the viewed stats for feedback)
            let rank = "Novice";
            let progressPercent = 0;
            // Scale rank thresholds based on range? 
            // For simplicity, we keep the thresholds but you might want to adjust them per view.
            if (totalXP < 500) { rank = "Novice"; progressPercent = (totalXP / 500) * 100; } 
            else if (totalXP < 1500) { rank = "Apprentice"; progressPercent = ((totalXP - 500) / 1000) * 100; } 
            else { rank = "Master"; progressPercent = 100; }
            
            document.getElementById('character-rank-title').textContent = rank;
            document.getElementById('xp-bar').style.width = `${progressPercent}%`;
        }

        async function calculatePeriodStats(history, range, offset) {
            const scores = { "Vitality": 0, "Intellect": 0, "Spirit": 0, "Wealth": 0, "Social": 0, "Discipline": 0 };
            let total = 0;

            const today = new Date();
            
            // Determine start/end date logic or Week IDs
            if (range === 'daily') {
                const targetDate = new Date(today);
                targetDate.setDate(today.getDate() + offset);
                
                const [y, w] = getWeekNumber(targetDate);
                const weekId = `${y}-W${String(w).padStart(2, '0')}`;
                const dayIndex = targetDate.getDay();

                let weekData = history[weekId];
                // If checking today and we have local unsaved data in habitData, prefer that
                if (offset === 0 && (!weekData || weekId === getWeekNumber(new Date()).join('-W').replace(/-W(\d)$/, '-W0$1'))) {
                    weekData = habitData;
                }

                if (weekData) {
                    processSingleDay(weekData, dayIndex, scores);
                }
            }
            else if (range === 'weekly') {
                // Offset by weeks
                const targetDate = new Date(today);
                targetDate.setDate(today.getDate() + (offset * 7));
                const [y, w] = getWeekNumber(targetDate);
                const weekId = `${y}-W${String(w).padStart(2, '0')}`;
                
                let weekData = history[weekId];
                if (offset === 0) weekData = habitData; // Use current state

                if (weekData) {
                    processWholeWeek(weekData, scores);
                }
            }
            else if (range === 'monthly') {
                // Offset by months
                const targetDate = new Date(today);
                targetDate.setMonth(today.getMonth() + offset);
                const targetMonth = targetDate.getMonth();
                const targetYear = targetDate.getFullYear();

                // Scan history for weeks belonging to this month
                Object.keys(history).forEach(weekId => {
                    const [y, w] = weekId.split('-W').map(Number);
                    if (y !== targetYear) return;
                    
                    // Approximate month check (Week 1 is roughly Jan)
                    const simpleDate = new Date(y, 0, 1 + (w - 1) * 7);
                    if (simpleDate.getMonth() === targetMonth) {
                        processWholeWeek(history[weekId], scores);
                    }
                });
                
                // If offset is 0, ensure current habitData is included/overwrites stale history
                if (offset === 0) {
                     // In a real robust system, we merge. Here we rely on history having it 
                     // OR we just process habitData if it wasn't in history yet.
                     const [cy, cw] = getWeekNumber(today);
                     const cWeekId = `${cy}-W${String(cw).padStart(2, '0')}`;
                     if (!history[cWeekId]) {
                         processWholeWeek(habitData, scores);
                     }
                }
            }
            else if (range === 'yearly') {
                const targetYear = today.getFullYear() + offset;
                
                Object.keys(history).forEach(weekId => {
                    const [y, w] = weekId.split('-W').map(Number);
                    if (y === targetYear) {
                        processWholeWeek(history[weekId], scores);
                    }
                });
                if (offset === 0) {
                     const [cy, cw] = getWeekNumber(today);
                     const cWeekId = `${cy}-W${String(cw).padStart(2, '0')}`;
                     if (!history[cWeekId]) {
                         processWholeWeek(habitData, scores);
                     }
                }
            }

            // Sum total
            total = Object.values(scores).reduce((a, b) => a + b, 0);
            return { scores, total };
        }

        function processSingleDay(weekData, dayIndex, scores) {
            Object.keys(weekData).forEach(habitKey => {
                if(habitKey === 'todos' || habitKey === 'journal' || habitKey === 'hourlyLog' || habitKey === 'failureLog') return;
                const attribute = getAttributeForHabit(habitKey);
                if (!attribute) return;

                const val = weekData[habitKey][dayIndex];
                if(val === true || (val && val !== "")) {
                    scores[attribute] += 10;
                }
            });
        }

        function processWholeWeek(weekData, scores) {
            Object.keys(weekData).forEach(habitKey => {
                if(habitKey === 'todos' || habitKey === 'journal' || habitKey === 'hourlyLog' || habitKey === 'failureLog') return;
                const attribute = getAttributeForHabit(habitKey);
                if (!attribute) return;

                const values = weekData[habitKey];
                if (Array.isArray(values)) {
                    values.forEach(val => {
                        if(val === true || (val && val !== "")) {
                            scores[attribute] += 10;
                        }
                    });
                }
            });
        }


        
        async function calculateMonthStats(monthOffset) {
            const scores = { "Vitality": 0, "Intellect": 0, "Spirit": 0, "Wealth": 0, "Social": 0, "Discipline": 0 };
            let total = 0;

            // 1. Determine Week IDs involved in this month
            const targetDate = new Date();
            targetDate.setMonth(targetDate.getMonth() + monthOffset);
            const year = targetDate.getFullYear();
            const month = targetDate.getMonth(); // 0-11

            // Simple approximation: check 5 weeks around the target month
            const firstDayOfMonth = new Date(year, month, 1);
            const [startYear, startWeek] = getWeekNumber(firstDayOfMonth);
            
            // Fetch up to 5 weeks of data to cover the month
            for (let w = 0; w < 5; w++) {
                let currentW = startWeek + w;
                let currentY = startYear;
                // Handle year rollover for weeks
                if (currentW > 52) { currentW -= 52; currentY++; }
                
                const weekId = `${currentY}-W${String(currentW).padStart(2, '0')}`;
                
                let weekData;
                // Check if this week is currently loaded in memory to save a read
                if (weekId === getWeekNumber(displayedDate).join('-W').replace(/-W(\d)$/, '-W0$1')) {
                    weekData = habitData; 
                } else {
                    // Fetch from Firestore
                    try {
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/habits`, weekId);
                        const snap = await getDoc(docRef);
                        if (snap.exists()) weekData = snap.data();
                    } catch (e) { console.log("Skipping week", weekId); }
                }

                if (weekData) {
                    // Sum points
                    Object.keys(weekData).forEach(habitKey => {
                        const attribute = getAttributeForHabit(habitKey);
                        if (attribute && userHabitConfig) {
                             let habitType = 'checkbox'; // default
                             for(const cat in userHabitConfig) {
                                 const h = userHabitConfig[cat].find(x => x.id === habitKey);
                                 if(h) { habitType = h.type; break; }
                             }

                             const values = weekData[habitKey];
                             if(Array.isArray(values)) {
                                 values.forEach(val => {
                                     // Scoring Rule: 10 XP per completion
                                     let points = 0;
                                     if(habitType === 'checkbox' || habitType === 'weekly-checkbox') {
                                         if(val === true) points = 10;
                                     } else {
                                         if(val && val !== "") points = 10;
                                     }
                                     
                                     if(points > 0) {
                                         scores[attribute] += points;
                                         total += points;
                                     }
                                 });
                             }
                        }
                    });
                }
            }
            return { scores, total };
        }


        // --- Settings Rendering & Logic ---
        function renderSettings() {
            const settingsContent = document.getElementById('settings-content');
            let html = '';
            for (const category in userHabitConfig) {
                 html += `<div class="p-4 border rounded-lg"><h3 class="text-xl font-bold mb-3">${category}</h3><div class="space-y-2">`;
                 userHabitConfig[category].forEach(habit => {
                     html += `
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <span class="font-medium">${habit.name}</span>
                            <div>
                                <button data-id="${habit.id}" class="edit-habit-btn text-sm text-blue-600 hover:underline px-2">Edit</button>
                                <button data-id="${habit.id}" class="delete-habit-btn text-sm text-red-600 hover:underline px-2">Delete</button>
                            </div>
                        </div>
                     `;
                 });
                 html += '</div></div>';
            }
            settingsContent.innerHTML = html;
            addSettingsEventListeners();
        }

        function addSettingsEventListeners() {
            document.getElementById('export-data-btn').addEventListener('click', exportData);
            document.querySelectorAll('.edit-habit-btn').forEach(btn => {
                btn.addEventListener('click', () => openHabitModal(btn.dataset.id));
            });
             document.querySelectorAll('.delete-habit-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteHabit(btn.dataset.id));
            });
        }
        
        async function exportData() {
            if (!userId) return;
            const exportButton = document.getElementById('export-data-btn');
            exportButton.textContent = 'Exporting...';
            exportButton.disabled = true;

            try {
                const habitsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/habits`);
                const querySnapshot = await getDocs(habitsCollectionRef);
                
                const allHabitData = {};
                querySnapshot.forEach(doc => {
                    allHabitData[doc.id] = doc.data();
                });

                const exportObject = {
                    userHabitConfig: userHabitConfig,
                    habitHistory: allHabitData,
                    exportDate: new Date().toISOString()
                };

                const jsonString = JSON.stringify(exportObject, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'habit_tracker_export.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch(error) {
                console.error("Error exporting data:", error);
                alert("Could not export data. Please check the console for errors.");
            } finally {
                exportButton.textContent = 'Export All Data';
                exportButton.disabled = false;
            }
        }
        
        function openHabitModal(habitId = null) {
            habitForm.reset();
            const categorySelect = document.getElementById('habit-category');
            categorySelect.innerHTML = Object.keys(userHabitConfig).map(c => `<option value="${c}">${c}</option>`).join('');
            
            const optionsContainer = document.getElementById('select-options-container');
            document.getElementById('habit-type').addEventListener('change', e => {
                optionsContainer.classList.toggle('hidden', e.target.value !== 'select');
            });

            if (habitId) {
                modalTitle.textContent = "Edit Habit";
                let habitToEdit, categoryToEdit;
                for(const category in userHabitConfig) {
                    const found = userHabitConfig[category].find(h => h.id === habitId);
                    if(found) {
                        habitToEdit = found;
                        categoryToEdit = category;
                        break;
                    }
                }
                
                document.getElementById('habit-id').value = habitId;
                document.getElementById('habit-name').value = habitToEdit.name;
                document.getElementById('habit-category').value = categoryToEdit;
                document.getElementById('habit-type').value = habitToEdit.type;
                if (habitToEdit.type === 'select') {
                    optionsContainer.classList.remove('hidden');
                    document.getElementById('habit-options').value = (habitToEdit.options || []).join(', ');
                } else {
                    optionsContainer.classList.add('hidden');
                }
            } else {
                modalTitle.textContent = "Add New Habit";
                 document.getElementById('habit-id').value = '';
                 optionsContainer.classList.add('hidden');
            }
            habitModal.classList.remove('hidden');
        }

        function closeHabitModal() {
            habitModal.classList.add('hidden');
        }

        async function saveHabit(e) {
            e.preventDefault();
            const habitId = document.getElementById('habit-id').value;
            const name = document.getElementById('habit-name').value;
            const category = document.getElementById('habit-category').value;
            const type = document.getElementById('habit-type').value;
            const options = document.getElementById('habit-options').value.split(',').map(s => s.trim()).filter(Boolean);

            if(!name || !category || !type) {
                alert("Please fill all fields.");
                return;
            }

            if(habitId) { // Editing existing
                let habit, oldCategory;
                 for(const cat in userHabitConfig) {
                    const foundIndex = userHabitConfig[cat].findIndex(h => h.id === habitId);
                    if(foundIndex > -1) {
                       habit = userHabitConfig[cat][foundIndex];
                       oldCategory = cat;
                       break;
                    }
                }
                habit.name = name;
                habit.type = type;
                if (type === 'select') habit.options = options;
                else delete habit.options;

                if(oldCategory !== category) {
                    userHabitConfig[oldCategory] = userHabitConfig[oldCategory].filter(h => h.id !== habitId);
                    userHabitConfig[category].push(habit);
                }

            } else { // Adding new
                const newHabit = { id: 'h' + Date.now(), name, type };
                if (type === 'select') newHabit.options = options;
                userHabitConfig[category].push(newHabit);
            }

            await saveUserHabitConfig();
            renderSettings();
            closeHabitModal();
        }

        async function deleteHabit(habitId) {
             if (!confirm("Are you sure you want to delete this habit? This cannot be undone.")) return;

             for(const category in userHabitConfig) {
                 userHabitConfig[category] = userHabitConfig[category].filter(h => h.id !== habitId);
             }
             await saveUserHabitConfig();
             renderSettings();
        }

        addHabitBtn.addEventListener('click', () => openHabitModal());
        cancelHabitBtn.addEventListener('click', closeHabitModal);
        habitForm.addEventListener('submit', saveHabit);
        generateReportBtn.addEventListener('click', async () => {
            generateReportBtn.textContent = 'Generating...';
            generateReportBtn.disabled = true;

            await renderStreaksReport();
            analyticsPrompt.classList.add('hidden');

            generateReportBtn.textContent = 'Generate Streaks Report';
            generateReportBtn.disabled = false;
        });


        // --- Dashboard, News & Weather ---
        function renderDashboard() {
            return `
            <div id="dashboard" class="bg-white rounded-2xl shadow-lg p-6">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Today's Dashboard</h3>
                    <button id="refresh-dashboard-btn" class="px-3 py-1 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg shadow-sm hover:bg-gray-300 transition-colors">Refresh</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div id="weather-widget" class="bg-gray-50 p-4 rounded-lg flex items-center justify-center space-x-4">
                         ${ICONS.weather}
                        <div id="weather-content">Loading weather...</div>
                    </div>
                    <div id="news-widget" class="bg-gray-50 p-4 rounded-lg flex items-center justify-center space-x-4">
                         ${ICONS.news}
                        <div id="news-content" class="text-sm space-y-2 flex-grow">Loading news...</div>
                    </div>
                    <div id="prayer-widget" class="bg-gray-50 p-4 rounded-lg flex items-center justify-center space-x-4">
                        ${ICONS.prayer}
                        <div id="prayer-content" class="text-sm space-y-1">Loading prayer times...</div>
                    </div>
                    <div id="history-widget" class="bg-gray-50 p-4 rounded-lg flex items-center justify-center space-x-4">
                         ${ICONS.history}
                        <div id="history-content" class="text-sm">Loading history...</div>
                    </div>
                </div>
            </div>
            `;
        }

        function renderWeather(weatherData) {
            const weatherDiv = document.getElementById('weather-content');
            if (!weatherDiv) return;
            if (weatherData && !weatherData.error) {
                 weatherDiv.innerHTML = `
                    <div class="text-left">
                        <p class="text-xl font-bold">${weatherData.temperature_2m}Â°C</p>
                        <p class="text-xs text-gray-600">Wind: ${weatherData.wind_speed_10m} km/h</p>
                        <p class="text-xs text-gray-600">Humidity: ${weatherData.relative_humidity_2m}%</p>
                        <p class="text-xs text-gray-600">Precipitation: ${weatherData.precipitation}mm</p>
                        <p class="text-xs text-gray-600">Cloud Cover: ${weatherData.cloud_cover}%</p>
                    </div>
                `;
            } else {
                weatherDiv.textContent = (weatherData && weatherData.message) || 'Could not load weather.';
            }
        }

        function renderNews(newsData) {
            const newsDiv = document.getElementById('news-content');
            if (!newsDiv) return;

            if (newsData && !newsData.error && newsData.articles) {
                newsDiv.innerHTML = newsData.articles.slice(0, 3).map(article => `
                    <div class="border-b pb-1 last:border-b-0">
                        <a href="${article.link}" target="_blank" rel="noopener noreferrer" class="font-semibold hover:text-blue-600 text-xs leading-tight">${article.title}</a>
                    </div>
                `).join('');
            } else {
                newsDiv.textContent = (newsData && newsData.message) || 'Could not load news articles.';
            }
        }

        function renderPrayerTimes(prayerData) {
            const prayerDiv = document.getElementById('prayer-content');
            if (!prayerDiv) return;
            if (prayerData && !prayerData.error) {
                const { Fajr, Dhuhr, Asr, Maghrib, Isha } = prayerData;
                prayerDiv.innerHTML = `
                    <div class="grid grid-cols-2 gap-x-2">
                        <span class="font-semibold">Fajr:</span> <span>${Fajr}</span>
                        <span class="font-semibold">Dhuhr:</span> <span>${Dhuhr}</span>
                        <span class="font-semibold">Asr:</span> <span>${Asr}</span>
                        <span class="font-semibold">Maghrib:</span> <span>${Maghrib}</span>
                        <span class="font-semibold">Isha:</span> <span>${Isha}</span>
                    </div>
                `;
            } else {
                 prayerDiv.textContent = (prayerData && prayerData.message) || 'Could not load prayer times.';
            }
        }

        function renderOnThisDay(historyData) {
             const historyDiv = document.getElementById('history-content');
            if (!historyDiv) return;
            if (historyData && !historyData.error && historyData.events && historyData.events.length > 0) {
                 const event = historyData.events[Math.floor(Math.random() * historyData.events.length)];
                 historyDiv.innerHTML = `<p><span class="font-bold">${event.year}:</span> ${event.text}</p>`;
            } else {
                historyDiv.textContent = (historyData && historyData.message) || 'Could not load historical event.';
            }
        }
        
        async function fetchDashboardData(forceRefresh = false) {
            const currentDate = new Date().toISOString().split('T')[0];
            const cacheKey = 'dashboardDataCache';

            if (!forceRefresh) {
                try {
                    const cachedData = JSON.parse(localStorage.getItem(cacheKey));
                    if (cachedData && cachedData.date === currentDate) {
                        renderWeather(cachedData.weather);
                        renderNews(cachedData.news);
                        renderPrayerTimes(cachedData.prayer);
                        renderOnThisDay(cachedData.history);
                        return;
                    }
                } catch (e) {
                    console.error("Could not read cache", e);
                }
            }
            
            const getPrayerTimes = (lat, lon) => new Promise(async (resolve) => {
                try {
                    const date = new Date().toISOString().split('T')[0];
                    const response = await fetch(`https://api.aladhan.com/v1/timings/${date}?latitude=${lat}&longitude=${lon}&method=4`);
                    const data = await response.json();
                    resolve(data.data.timings);
                } catch (error) {
                    console.error("Error fetching prayer times:", error);
                    resolve({ error: true, message: 'Could not fetch prayer times.' });
                }
            });

            const getOnThisDay = () => new Promise(async (resolve) => {
                try {
                    const today = new Date();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const response = await fetch(`https://en.wikipedia.org/api/rest_v1/feed/onthisday/events/${month}/${day}`);
                    const data = await response.json();
                    resolve({ events: data.events });
                } catch (error) {
                    console.error("Error fetching 'On This Day' data:", error);
                     resolve({ error: true, message: "Could not fetch today's history." });
                }
            });

            const getNews = () => new Promise(async (resolve) => {
                const rssFeedUrl = encodeURIComponent("http://feeds.bbci.co.uk/news/world/rss.xml");
                try {
                    const response = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${rssFeedUrl}`);
                    const data = await response.json();
                    resolve(data.status === 'ok' ? { articles: data.items } : { error: true, message: 'Could not load news.' });
                } catch (error) {
                    console.error("Error fetching news:", error);
                    resolve({ error: true, message: 'Could not fetch news.' });
                }
            });

            const getWeatherAndLocation = () => new Promise((resolve) => {
                 if (!navigator.geolocation) {
                    resolve({ weather: { error: true, message: "Geolocation is not supported." }, location: null });
                    return;
                }
                navigator.geolocation.getCurrentPosition(async position => {
                    const { latitude, longitude } = position.coords;
                    try {
                        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,precipitation,cloud_cover,wind_speed_10m`);
                        const data = await response.json();
                        resolve({ weather: data.current, location: { latitude, longitude } });
                    } catch (error) {
                        console.error("Error fetching weather:", error);
                        resolve({ weather: { error: true, message: 'Could not fetch weather.' }, location: { latitude, longitude }});
                    }
                }, () => {
                    resolve({ weather: { error: true, message: 'Location access denied.' }, location: null });
                });
            });

            const { weather, location } = await getWeatherAndLocation();
            let prayerTimes = { error: true, message: 'Location needed for prayer times.' };
            if(location) {
                prayerTimes = await getPrayerTimes(location.latitude, location.longitude);
            }
            const news = await getNews();
            const history = await getOnThisDay();
            
            renderWeather(weather);
            renderNews(news);
            renderPrayerTimes(prayerTimes);
            renderOnThisDay(history);

            const newCache = { date: currentDate, weather, news, prayer: prayerTimes, history };
            localStorage.setItem(cacheKey, JSON.stringify(newCache));
        }

        // --- Rendering Sections ---
        function renderWeeklySection() {
            let html = `<div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Weekly Tasks</h3>
                <div class="space-y-3">`;
            (userHabitConfig["Weekly"] || []).forEach(habit => {
                const key = habit.id;
                if (!habitData[key]) { habitData[key] = [false]; }
                const isChecked = habitData[key][0];
                html += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <label for="${key}" class="font-medium text-gray-700">${habit.name}</label>
                    <input type="checkbox" id="${key}" data-key="${key}" data-day="0" class="h-6 w-6 rounded border-gray-300 text-green-500 focus:ring-green-400 cursor-pointer habit-input" ${isChecked ? 'checked' : ''}>
                </div>`;
            });
            html += `</div></div>`;
            return html;
        }

        function renderDayHabits(dayIndex) {
            let html = '<div class="bg-white rounded-2xl shadow-lg p-6"><h3 class="text-2xl font-bold mb-4 text-gray-800">Daily Habits</h3><div class="space-y-4">';

            Object.keys(userHabitConfig).filter(c => c !== 'Weekly').forEach(category => {
                html += `<div><h4 class="text-lg font-semibold text-gray-600 mb-2">${category}</h4><div class="space-y-3">`;
                userHabitConfig[category].forEach(habit => {
                      const key = habit.id;
                      if (!habitData[key]) { habitData[key] = habit.type === 'checkbox' ? Array(7).fill(false) : Array(7).fill(""); }
                      const habitState = habitData[key][dayIndex];
                      const failureReason = (habitData.failureLog && habitData.failureLog[key] && habitData.failureLog[key][dayIndex]) || "";
                      
                      html += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <label class="font-medium text-gray-700">${habit.name}</label>
                        <div class="flex items-center space-x-2">`;

                    if (!habitState && habit.type !== 'select') {
                        html += `<button data-key="${key}" data-day="${dayIndex}" class="log-failure-btn text-xs ${failureReason ? 'text-yellow-600' : 'text-gray-500'} hover:underline">${failureReason ? 'View Reason' : 'Log Failure'}</button>`;
                    }

                      if (habit.type === 'checkbox') {
                          html += `<input type="checkbox" data-key="${key}" data-day="${dayIndex}" class="h-6 w-6 rounded border-gray-300 text-green-500 focus:ring-green-400 cursor-pointer habit-input" ${habitState ? 'checked' : ''}>`;
                      } else if (habit.type === 'select') {
                          html += `<select data-key="${key}" data-day="${dayIndex}" class="custom-select rounded-md border-gray-300 shadow-sm focus:border-green-400 focus:ring focus:ring-green-300 focus:ring-opacity-50 text-sm py-1.5 w-40 habit-input">${(habit.options || []).map(opt => `<option value="${opt}" ${opt === (habitState || "") ? 'selected' : ''}>${opt || 'Select'}</option>`).join('')}</select>`;
                      }
                      html += `</div></div>`;
                });
                html += `</div></div>`;
            });

            html += '</div></div>';
            return html;
        }
        
        function renderHourlyLog() {
            const logDate = new Date(displayedDate);
            logDate.setDate(logDate.getDate() - (logDate.getDay() - activeDayIndex));
            document.getElementById('hourly-log-date').textContent = logDate.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const contentDiv = document.getElementById('hourly-log-content');
            let html = '';
            
            if(!habitData.hourlyLog || !habitData.hourlyLog[activeDayIndex]) {
                 if(!habitData.hourlyLog) habitData.hourlyLog = {};
                 habitData.hourlyLog[activeDayIndex] = Array(24).fill({});
            }
            const dayLog = habitData.hourlyLog[activeDayIndex];

            for (let i = 0; i < 24; i++) {
                const time = `${String(i).padStart(2, '0')}:00`;
                const logEntry = dayLog[i] || {};
                const category = logEntry.category || 'Other';
                const activity = logEntry.activity || '';
                const bgColor = hourlyLogCategories[category];

                html += `
                    <div class="timeline-hour grid gap-2 items-center">
                        <span class="text-sm font-medium text-gray-500 text-right">${time}</span>
                        <div data-hour="${i}" data-day="${activeDayIndex}" class="hourly-log-slot col-span-1 w-full p-2 border border-gray-200 rounded-md shadow-sm cursor-pointer ${bgColor}">
                           <p class="text-sm truncate">${activity || 'Click to add entry...'}</p>
                        </div>
                    </div>
                `;
            }
            contentDiv.innerHTML = html;
        }

        function renderDayJournal(dayIndex) {
            const [year, weekNo] = getWeekNumber(displayedDate);
            const weekStartDate = getDateOfWeek(weekNo, year);
            const journalDate = new Date(weekStartDate);
            journalDate.setDate(journalDate.getDate() + dayIndex);
            const dayOfYear = Math.floor((journalDate - new Date(journalDate.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const prompt = journalPrompts[dayOfYear % journalPrompts.length];
            
            const journalEntry = (habitData.journal && habitData.journal[dayIndex]) || "";
            return `<div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-2 text-gray-800">Journal Entry</h3>
                <p class="text-sm text-gray-500 italic mb-3">"${prompt}"</p>
                <textarea data-day="${dayIndex}" class="journal-entry w-full h-48 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">${journalEntry}</textarea>
            </div>`;
        }

        function renderDayTodos(dayIndex) {
            let html = `<div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Todo List</h3>
                <ul id="todo-list" class="space-y-2 flex-grow min-h-[150px]">
                    ${renderSingleDayTodos(dayIndex)}
                </ul>
                <div class="mt-4 flex space-x-2">
                    <input type="text" id="todo-input" placeholder="New todo..." class="flex-grow w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <button id="add-todo-btn" class="px-3 py-1 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 text-sm">Add</button>
                </div>
            </div>`;
            return html;
        }

        function renderSingleDayTodos(dayIndex) {
            const dayTodos = (habitData.todos && habitData.todos[dayIndex]) || [];
            if (dayTodos.length === 0) return `<li class="text-xs text-gray-500 text-center italic pt-4">No tasks for today.</li>`;
            return dayTodos.map((todo, todoIndex) => `
                <li class="todo-item flex items-center justify-between bg-gray-50 p-2 rounded-md">
                    <input type="checkbox" data-index="${todoIndex}" class="todo-checkbox h-4 w-4 rounded border-gray-300 text-blue-500 focus:ring-blue-400" ${todo.completed ? 'checked' : ''}>
                    <span class="text-sm mx-2 flex-grow ${todo.completed ? 'line-through text-gray-400' : 'text-gray-700'}">${todo.text}</span>
                    <button data-index="${todoIndex}" class="delete-todo-btn text-red-500 hover:text-red-700 font-bold">&times;</button>
                </li>
            `).join('');
        }

        // --- Modal Logic ---
        function openFailureLogModal(habitId, dayIndex) {
            failureLogForm.reset();
            document.getElementById('failure-habit-id').value = habitId;
            document.getElementById('failure-day-index').value = dayIndex;
            const reason = (habitData.failureLog && habitData.failureLog[habitId] && habitData.failureLog[habitId][dayIndex]) || "";
            document.getElementById('failure-reason').value = reason;
            failureLogModal.classList.remove('hidden');
        }

        function closeFailureLogModal() {
            failureLogModal.classList.add('hidden');
        }

        async function saveFailureLog(e) {
            e.preventDefault();
            const habitId = document.getElementById('failure-habit-id').value;
            const dayIndex = document.getElementById('failure-day-index').value;
            const reason = document.getElementById('failure-reason').value;

            if(!habitData.failureLog) habitData.failureLog = {};
            if(!habitData.failureLog[habitId]) habitData.failureLog[habitId] = Array(7).fill("");
            
            habitData.failureLog[habitId][dayIndex] = reason;

            markUnsaved(); // Trigger Save Bar
            closeFailureLogModal();
            renderDayHabits(activeDayIndex);
        }

        function openHourlyLogModal(hour, day) {
            hourlyLogForm.reset();
            document.getElementById('hourly-log-modal-title').textContent = `Log for ${String(hour).padStart(2, '0')}:00`;
            document.getElementById('hourly-log-hour').value = hour;
            document.getElementById('hourly-log-day').value = day;

            const categorySelect = document.getElementById('hourly-log-category');
            categorySelect.innerHTML = Object.keys(hourlyLogCategories).map(c => `<option value="${c}">${c}</option>`).join('');

            const logEntry = (habitData.hourlyLog && habitData.hourlyLog[day] && habitData.hourlyLog[day][hour]) || {};
            document.getElementById('hourly-log-activity').value = logEntry.activity || '';
            categorySelect.value = logEntry.category || 'Other';
            
            hourlyLogModal.classList.remove('hidden');
        }

        function closeHourlyLogModal() {
            hourlyLogModal.classList.add('hidden');
        }

        async function saveHourlyLog(e) {
            e.preventDefault();
            const hour = document.getElementById('hourly-log-hour').value;
            const day = document.getElementById('hourly-log-day').value;
            const activity = document.getElementById('hourly-log-activity').value;
            const category = document.getElementById('hourly-log-category').value;
            
            if(!habitData.hourlyLog) habitData.hourlyLog = {};
            if(!habitData.hourlyLog[day]) habitData.hourlyLog[day] = Array(24).fill({});
            
            habitData.hourlyLog[day][hour] = { activity, category };

            markUnsaved(); // Trigger Save Bar
            closeHourlyLogModal();
            renderHourlyLog();
        }
        
        cancelFailureLogBtn.addEventListener('click', closeFailureLogModal);
        failureLogForm.addEventListener('submit', saveFailureLog);
        cancelHourlyLogBtn.addEventListener('click', closeHourlyLogModal);
        hourlyLogForm.addEventListener('submit', saveHourlyLog);


        function updateProgress() {
            let totalTasks = 0, completedTasks = 0;
            for (const category in userHabitConfig) {
                userHabitConfig[category].forEach(habit => {
                    const key = habit.id;
                    const habitState = habitData[key]; if (!habitState) return;
                    if (habit.type === 'weekly-checkbox') {
                         totalTasks++; if(habitState[0]) completedTasks++;
                    } else {
                        totalTasks += 7;
                        if(habit.type === 'checkbox') {
                            completedTasks += habitState.filter(Boolean).length;
                        } else {
                            completedTasks += habitState.filter(val => val && val !== "").length;
                        }
                    }
                });
            }
            const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('total-progress-bar').style.width = `${percentage}%`;
            document.getElementById('total-progress-text').textContent = `${percentage}% Complete - Great work!`;
        }

        // --- Navigation Listeners ---
        document.getElementById('prev-week-btn').addEventListener('click', () => navigateWeeks(-1));
        document.getElementById('next-week-btn').addEventListener('click', () => navigateWeeks(1));
        document.getElementById('today-btn').addEventListener('click', () => {
             if(hasUnsavedChanges) {
                if(!confirm("You have unsaved changes. Discard them?")) return;
                hasUnsavedChanges = false;
                saveBar.classList.add('translate-y-full');
            }
            const today = new Date();
             if (getWeekNumber(displayedDate).join('-') !== getWeekNumber(today).join('-')) {
                displayedDate = today;
                setActiveDayForCurrentWeek();
                updateViewForDate();
            } else {
                const currentDayIndex = today.getDay();
                if (activeDayIndex !== currentDayIndex) {
                    activeDayIndex = currentDayIndex;
                    renderApp();
                }
            }
        });

        // --- NEW: History Chart Functions ---

        function setupHistoryChartListeners() {
            document.querySelectorAll('.history-filter-btn').forEach(btn => {
                // Remove old listeners to prevent duplicates (simple cloning trick)
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', (e) => {
                    // Update UI classes
                    document.querySelectorAll('.history-filter-btn').forEach(b => {
                        b.classList.remove('bg-white', 'shadow-sm', 'text-blue-600');
                        b.classList.add('text-gray-500', 'hover:bg-white');
                    });
                    e.target.classList.remove('text-gray-500', 'hover:bg-white');
                    e.target.classList.add('bg-white', 'shadow-sm', 'text-blue-600');
                    
                    // Render Chart
                    renderHistoryChart(e.target.dataset.range);
                });
            });
        }

        async function renderHistoryChart(range) {
            const ctx = document.getElementById('history-chart').getContext('2d');
            
            // Show loading state on chart if possible, or just wait
            if (historyChartInstance) historyChartInstance.destroy();

            // 1. Fetch Data based on range
            const rawData = await fetchAllYearData(); // Reusing your existing function
            const processedData = processHistoryData(rawData, range);

            // 2. Define Colors for Categories
            const colors = {
                "Vitality": "rgb(239, 68, 68)",   // Red
                "Intellect": "rgb(59, 130, 246)", // Blue
                "Spirit": "rgb(168, 85, 247)",    // Purple
                "Wealth": "rgb(34, 197, 94)",     // Green
                "Social": "rgb(234, 179, 8)",     // Yellow
                "Discipline": "rgb(107, 114, 128)" // Gray
            };

            const datasets = Object.keys(processedData.scores).map(category => ({
                label: category,
                data: processedData.scores[category],
                borderColor: colors[category] || '#000',
                backgroundColor: 'transparent',
                borderWidth: 2,
                tension: 0.3, // Smooth curves
                pointRadius: range === 'daily' ? 2 : 4
            }));

            historyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: processedData.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { usePointStyle: true, boxWidth: 8 } },
                        tooltip: { 
                            callbacks: {
                                footer: (items) => {
                                    const total = items.reduce((a, b) => a + b.parsed.y, 0);
                                    return 'Total XP: ' + total;
                                }
                            }
                        }
                    }
                }
            });
        }

        function processHistoryData(history, range) {
            const labels = [];
            const scores = { "Vitality": [], "Intellect": [], "Spirit": [], "Wealth": [], "Social": [], "Discipline": [] };
            
            // Sort weeks to ensure chronological order
            const sortedWeekIds = Object.keys(history).sort();
            
            if (range === 'weekly' || range === 'yearly') {
                // Show last 12 weeks for 'weekly', or all available for 'yearly'
                const limit = range === 'weekly' ? 12 : 52; 
                const relevantWeeks = sortedWeekIds.slice(-limit);

                relevantWeeks.forEach(weekId => {
                    labels.push(weekId.split('-')[1]); // Label is "W48"
                    const weekScores = calculateScoreForObject(history[weekId]);
                    Object.keys(scores).forEach(cat => scores[cat].push(weekScores[cat]));
                });
            } 
            else if (range === 'monthly') {
                // Aggregate by month
                const monthMap = {}; // { "Jan": { Vitality: 10, ... } }
                
                sortedWeekIds.forEach(weekId => {
                    // Approximate month from Week ID
                    const year = parseInt(weekId.split('-')[0]);
                    const week = parseInt(weekId.split('-W')[1]);
                    const simpleDate = new Date(year, 0, 1 + (week - 1) * 7);
                    const monthName = simpleDate.toLocaleString('default', { month: 'short' });
                    
                    if (!monthMap[monthName]) monthMap[monthName] = { "Vitality": 0, "Intellect": 0, "Spirit": 0, "Wealth": 0, "Social": 0, "Discipline": 0 };
                    
                    const weekScores = calculateScoreForObject(history[weekId]);
                    Object.keys(scores).forEach(cat => monthMap[monthName][cat] += weekScores[cat]);
                });

                Object.keys(monthMap).slice(-12).forEach(month => { // Last 12 months
                    labels.push(month);
                    Object.keys(scores).forEach(cat => scores[cat].push(monthMap[month][cat]));
                });
            }
            else if (range === 'daily') {
                // Last 14 days logic
                // We need to iterate weeks, then days inside weeks
                const lastWeeks = sortedWeekIds.slice(-3); // Get last 3 weeks to cover enough days
                const dailyData = [];

                lastWeeks.forEach(weekId => {
                    const weekData = history[weekId];
                    const [y, w] = weekId.split('-W').map(Number);
                    
                    for(let d=0; d<7; d++) {
                        // Calculate Date string
                        const simpleDate = new Date(y, 0, 1 + (w - 1) * 7);
                        simpleDate.setDate(simpleDate.getDate() + (d - simpleDate.getDay())); // Adjust to correct day
                        const dateStr = simpleDate.getDate() + '/' + (simpleDate.getMonth()+1);

                        // Calculate score for this specific day
                        const dayScores = { "Vitality": 0, "Intellect": 0, "Spirit": 0, "Wealth": 0, "Social": 0, "Discipline": 0 };
                        
                        Object.keys(weekData).forEach(habitKey => {
                            if(habitKey === 'todos' || habitKey === 'journal' || habitKey === 'hourlyLog' || habitKey === 'failureLog') return;
                            
                            const attribute = getAttributeForHabit(habitKey);
                            if (!attribute) return;
                            
                            const val = weekData[habitKey][d];
                            if(val === true || (val && val !== "")) {
                                dayScores[attribute] += 10;
                            }
                        });
                        dailyData.push({ date: dateStr, scores: dayScores });
                    }
                });

                // Take last 14 days
                dailyData.slice(-14).forEach(entry => {
                    labels.push(entry.date);
                    Object.keys(scores).forEach(cat => scores[cat].push(entry.scores[cat]));
                });
            }

            return { labels, scores };
        }

        function calculateScoreForObject(weekData) {
            const totals = { "Vitality": 0, "Intellect": 0, "Spirit": 0, "Wealth": 0, "Social": 0, "Discipline": 0 };
            
            Object.keys(weekData).forEach(habitKey => {
                if(habitKey === 'todos' || habitKey === 'journal' || habitKey === 'hourlyLog' || habitKey === 'failureLog') return;

                const attribute = getAttributeForHabit(habitKey);
                if (!attribute) return;

                const values = weekData[habitKey];
                if (Array.isArray(values)) {
                    values.forEach(val => {
                        if(val === true || (val && val !== "")) {
                            totals[attribute] += 10;
                        }
                    });
                }
            });
            return totals;
        }
    </script>
</body>
</html>

